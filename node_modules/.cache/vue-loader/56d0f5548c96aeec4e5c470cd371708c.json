{"remainingRequest":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/src/views/assets/CreateAsset.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/src/views/assets/CreateAsset.vue","mtime":1661968702424},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/vue-loader/lib/index.js","mtime":1655715099000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCB7IEFzc2V0TWFuYWdlbWVudFNlcnZpY2UgfSBmcm9tICIuLi8uLi9zZXJ2aWNlcy9Bc3NldE1hbmFnZW1lbnRTZXJ2aWNlIjsKaW1wb3J0IHsgV29ya09yZGVyU2VydmljZSB9IGZyb20gIi4uLy4uL3NlcnZpY2VzL1dvcmtPcmRlclNlcnZpY2UiOwppbXBvcnQgeyBBc3NldFBlcnNvbm5lbFNlcnZpY2UgfSBmcm9tICIuLi8uLi9zZXJ2aWNlcy9Bc3NldFBlcnNvbm5lbFNlcnZpY2UiOwppbXBvcnQgeyBJbnNwZWN0aW9uU2VydmljZSB9IGZyb20gIi4uLy4uL3NlcnZpY2VzL0luc3BlY3Rpb25TZXJ2aWNlIjsKaW1wb3J0IEFzc2lnblVzZXJQb3BVcCBmcm9tICIuL2NvbXBvbmVudHMvQXNzaWduVXNlclBvcFVwIjsKaW1wb3J0IEFzc2lnbm1lbnQgZnJvbSAiLi9jb21wb25lbnRzL0Fzc2lnbm1lbnQiOwppbXBvcnQgU2lkZWJhciBmcm9tICIuLi9hc3NldHMvY29tcG9uZW50cy9TaWRlYmFyIjsKaW1wb3J0IHsgbWF4TGVuZ3RoLCByZXF1aXJlZCB9IGZyb20gInZ1ZWxpZGF0ZS9saWIvdmFsaWRhdG9ycyI7CmltcG9ydCBDcmVhdGVDYXRlZ29yeSBmcm9tICIuLi9hc3NldHMvY29tcG9uZW50cy9DcmVhdGVDYXRlZ29yeSI7CmltcG9ydCBtb21lbnQgZnJvbSAibW9tZW50IjsKaW1wb3J0IHsgRnVuY3Rpb25zIH0gZnJvbSAiQC9zaGFyZWQvRnVuY3Rpb25zIjsKaW1wb3J0IFVuQXNzaWduVXNlclBvcFVwIGZyb20gIi4vY29tcG9uZW50cy9VbkFzc2lnblVzZXJQb3BVcCI7CmltcG9ydCBJbXBvcnRFeHBvcnREaWFsb2cgZnJvbSAiLi4vLi4vY29tcG9uZW50cy9JbXBvcnRFeHBvcnREaWFsb2cudnVlIjsKCmltcG9ydCBsb2FkZXIgZnJvbSAiQC9jb21wb25lbnRzL0xvYWRlci52dWUiOwoKZXhwb3J0IGRlZmF1bHQgewogIG5hbWU6ICJjcmVhdGVBc3NldCIsCgogIGNvbXBvbmVudHM6IHsKICAgIFNpZGViYXIsCiAgICBDcmVhdGVDYXRlZ29yeSwKICAgIEFzc2lnbm1lbnQsCiAgICBBc3NpZ25Vc2VyUG9wVXAsCiAgICBVbkFzc2lnblVzZXJQb3BVcCwKICAgIEltcG9ydEV4cG9ydERpYWxvZywKICAgIGxvYWRlciwKICB9LAogIHByb3BzOiB7fSwKCiAgZGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIGxvYWRlckZsYWc6IGZhbHNlLAogICAgICB0b2FzdEZsYWc6IDAsCiAgICAgIHRvYXN0TWVzc2FnZTogIiIsCiAgICAgIHRvYXN0VHlwZTogIiIsCiAgICAgIGN1cnJlbmN5OiAiIiwKICAgICAgaW1wb3J0RXhwb3J0RGlhbG9nOiBmYWxzZSwKICAgICAgYXNzZXRPYmo6IHsKICAgICAgICBpZDogIiIsCiAgICAgICAgbmFtZTogIiIsCiAgICAgICAgcXVhbnRpdHk6ICIiLAogICAgICAgIG1vZGVsTnVtYmVyOiAiIiwKICAgICAgICBhc3NldE51bWJlcjogIiIsCiAgICAgICAgY2F0ZWdvcnlVVUlEOiAiIiwKICAgICAgICBpbnZlbnRvcnk6ICIiLAogICAgICAgIG1hbnVmYWN0dXJlOiAiIiwKICAgICAgICB3YXJyYW50eTogIiIsCiAgICAgICAgd2FycmFudHlVbml0OiAiIiwKICAgICAgICBjb25zdW1wdGlvblVuaXQ6ICIiLAogICAgICAgIHByaW1hcnlVc2FnZVVuaXQ6ICIiLAogICAgICAgIHNlY29uZGFyeVVzYWdlVW5pdDogIiIsCiAgICAgICAgcHVyY2hhc2VEYXRlOiBudWxsLAogICAgICAgIHN0YXR1czogIiIsCiAgICAgICAgYXNzZXRGaWVsZHM6IFtdLAogICAgICB9LAogICAgICBzZWxlY3RJbnB1dDogMCwKICAgICAgU2hvd1VuUG9wVXA6IGZhbHNlLAogICAgICBpbmRleDogMCwKICAgICAgcG9wdXBJbWFnZTogIiIsCiAgICAgIGltYWdlRGlhbG9nOiBmYWxzZSwKICAgICAgaW1hZ2VWb2ljZXM6IFtdLAogICAgICBjYXRlSW5kZXg6IDAsCiAgICAgIHBhZ2U6IDAsCiAgICAgIHJvd3NQZXJQYWdlOiA1LAogICAgICBhc3NpZ25lZFVzZXJzOiBbXSwKICAgICAgc2VsZWN0ZWRDYXRlZ29yeUlkOiAiIiwKICAgICAgZGlzYWJsZUFkZEJ1dHRvbjogZmFsc2UsCiAgICAgIGRpc2FibGVFZGl0QnV0dG9uOiB0cnVlLAogICAgICBkYXRlOiAiIiwKICAgICAgY2FyZ29EYXRlOiAiIiwKICAgICAgZGVzY3JpcHRpb246ICIiLAogICAgICBjYXRlZ29yeTogIiIsCiAgICAgIEFzc2V0Q2F0ZWdvcnk6IFtdLAogICAgICB2YWx1ZTogIiIsCiAgICAgIGN1cnJlbnRVc2VyRGV0YWlsczogIiIsCiAgICAgIGNhdGVnb3J5UG9wVXA6IGZhbHNlLAogICAgICBjdXN0b21DYXRlZ29yeUZpZWxkczogW10sCiAgICAgIHNlbGVjdEFzc2V0Q2F0ZWdvcnk6ICIiLAogICAgICBhc3NldENhdGVnb3J5VVVJRDogIiIsCiAgICAgIGltYWdlUGF0aDogW10sCiAgICAgIG11bHRpcGFydEF0dGFjaG1lbnRzOiBbXSwKICAgICAgZG9jUGF0aDogW10sCiAgICAgIFNob3dQb3BVcDogZmFsc2UsCiAgICAgIHdhcnJhbnR5VW5pdE9wdGlvbjogWwogICAgICAgIHsgbGFiZWw6ICJZZWFycyIsIHZhbHVlOiAiWWVhcnMiIH0sCiAgICAgICAgeyBsYWJlbDogIk1vbnRocyIsIHZhbHVlOiAiTW9udGhzIiB9LAogICAgICAgIHsgbGFiZWw6ICJEYXlzIiwgdmFsdWU6ICJEYXlzIiB9LAogICAgICBdLAogICAgICBvcHRpb25zQm9vbGVhbjogWwogICAgICAgIHsgbGFiZWw6ICJZZXMiLCB2YWx1ZTogIk5vIiB9LAogICAgICAgIHsgbGFiZWw6ICJOTyIsIHZhbHVlOiAiTm8iIH0sCiAgICAgIF0sCiAgICAgIGluZGV4UmVtaW5kZXI6IDAsCiAgICAgIGFzc2V0U3RhdHVzOiBbCiAgICAgICAgeyBuYW1lOiAiQWN0aXZlIiwgdmFsdWU6ICJBY3RpdmUiIH0sCiAgICAgICAgeyBuYW1lOiAiSW5hY3RpdmUiLCB2YWx1ZTogIkluYWN0aXZlIiB9LAogICAgICAgIHsgbmFtZTogIk91dCBvZiBTZXJ2aWNlIiwgdmFsdWU6ICJPdXRvZlNlcnZpY2UiIH0sCiAgICAgICAgeyBuYW1lOiAiU3BhcmUiLCB2YWx1ZTogIlNwYXJlIiB9LAogICAgICAgIHsgbmFtZTogIkV4cGlyZWQgLyBkaXNwb3NlZCIsIHZhbHVlOiAiRXhwaXJlZC9kaXNwb3NlZCIgfSwKICAgICAgICB7IG5hbWU6ICJzb2xkIiwgdmFsdWU6ICJzb2xkIiB9LAogICAgICBdLAogICAgICB2YWx1ZUVkaXRBc3NpZ246IHt9LAogICAgICBhc3NldElEOiAiIiwKICAgICAgYXNzaWdubWVudEhpc3RvcnlVc2VyczogW10sCiAgICAgIFVzZXJzOiBbXSwKICAgICAgYWxsVXNlcnM6IFtdLAogICAgICBjb3N0OiAiIiwKICAgICAgYXNzaWduVGFibGVWYWx1ZTogIiIsCiAgICAgIGltYWdlVm9pY2VzQ2hlY2s6IFtdLAogICAgICBpbXBvcnRTdWNjZXNzOiBmYWxzZSwKICAgICAgYXNzZXREYXRhOiBbXSwKICAgICAgdXNlckFzc2lnbmVkOiB0cnVlLAogICAgICBzdHlsZUJ1dHRvbjE6ICJtYXJnaW4tbGVmdDo1cHg7IiwKICAgICAgc3R5bGVCdXR0b24yOiAibWFyZ2luLWxlZnQ6NXB4OyBwb2ludGVyLWV2ZW50czogbm9uZSIsCiAgICAgIEFkZEJ5Q2F0ZUZsYWc6ZmFsc2UsCiAgICAgIGFzc2V0Q2F0ZUlEOiAiIgogICAgfTsKICB9LAoKICBtZXRob2RzOiB7CiAgICB2YWxpZGF0ZURhdGUoZGF0ZSwgZmllbGQpIHsKICAgICAgbGV0IGN1cnJlbnREYXRlID0gbW9tZW50KCkuZm9ybWF0KCkuc3BsaXQoIlQiKTsKICAgICAgY3VycmVudERhdGUgPSBjdXJyZW50RGF0ZVswXTsKICAgICAgaWYgKG1vbWVudChkYXRlKS5pc0JlZm9yZShjdXJyZW50RGF0ZSkpIHsKICAgICAgICB0aGlzW2ZpZWxkXSA9ICIiOwogICAgICAgIHJldHVybiB0aGlzLiRzaG93VG9hc3QoCiAgICAgICAgICAic2hvd1RvYXN0IiwKICAgICAgICAgICJQbGVhc2UgU2VsZWN0IEN1cnJlbnQgRGF0ZSBvciBGdXR1cmUgRGF0ZS4iLAogICAgICAgICAgImVycm9yIgogICAgICAgICk7CiAgICAgIH0KICAgIH0sCiAgICBwdXJjaGFzZURhdGVIYW5kbGVyKHZhbHVlKSB7CiAgICAgIGxldCBjdXJyZW50RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgpLnNwbGl0KCJUIik7CiAgICAgIGN1cnJlbnREYXRlID0gY3VycmVudERhdGVbMF07CiAgICAgIGlmIChtb21lbnQoY3VycmVudERhdGUpLmlzQmVmb3JlKHZhbHVlKSkgewogICAgICAgIHRoaXMuZGF0ZSA9ICIiOwogICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgIllvdSBjYW4gbm90IHNlbGVjdCBmdXR1cmUgZGF0ZSBhcyBQdXJjaGFzZSBEYXRlIiwKICAgICAgICAgICJlcnJvciIKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBwdXJjaGFzZV9kYXRlID0gbW9tZW50KHZhbHVlKTsKICAgICAgICBwdXJjaGFzZV9kYXRlID0gcHVyY2hhc2VfZGF0ZS5mb3JtYXQoIllZWVktTU0tRERUSEg6TU06U1NaIik7CiAgICAgICAgdGhpcy5hc3NldE9iai5wdXJjaGFzZURhdGUgPSBtb21lbnQodmFsdWUpLmZvcm1hdCgiREQtTU0tWVlZWSIpOwogICAgICAgIHRoaXMuY2FyZ29EYXRlID0gcHVyY2hhc2VfZGF0ZTsKICAgICAgfQogICAgfSwKCiAgICB1cGxvYWRDU1YoKSB7CiAgICAgIHRoaXMuaW1wb3J0RXhwb3J0RGlhbG9nID0gdHJ1ZTsKICAgIH0sCgogICAgZXhwb3J0RXhjZWwoKSB7CiAgICAgIC8vIGxvZ2ljIHRvIGV4cG9ydCBBc3NldCBmaWxlCiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CiAgICAgIGxldCByZXF1ZXN0ID0gewogICAgICAgIGFzc2V0RXhjZWxEYXRhOiB0aGlzLmJ1aWxkRXhwb3J0RGF0YVJlcXVlc3QoKSwKICAgICAgfTsKICAgICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS5leHBvcnRFeGNlbEZpbGUocmVxdWVzdCkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIHNhbXBsZUFycmF5ID0gdGhpcy5iYXNlNjRUb0FycmF5QnVmZmVyKHJlc3BvbnNlLmRhdGEuZmlsZSk7CiAgICAgICAgICAgIGxldCBmaWxlVXJsID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoCiAgICAgICAgICAgICAgbmV3IEJsb2IoW3NhbXBsZUFycmF5XSwgewogICAgICAgICAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0IiwKICAgICAgICAgICAgICB9KQogICAgICAgICAgICApOwogICAgICAgICAgICB2YXIgZmlsZUxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAgIGZpbGVMaW5rLmhyZWYgPSBmaWxlVXJsOwogICAgICAgICAgICBmaWxlTGluay5zZXRBdHRyaWJ1dGUoImRvd25sb2FkIiwgcmVzcG9uc2UuZGF0YS5maWxlTmFtZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZmlsZUxpbmspOwogICAgICAgICAgICBmaWxlTGluay5jbGljaygpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIGJhc2U2NFRvQXJyYXlCdWZmZXIoYmFzZTY0KSB7CiAgICAgIHZhciBiaW5hcnlTdHJpbmcgPSB3aW5kb3cuYXRvYihiYXNlNjQpOwogICAgICB2YXIgYmluYXJ5TGVuID0gYmluYXJ5U3RyaW5nLmxlbmd0aDsKICAgICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoYmluYXJ5TGVuKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiaW5hcnlMZW47IGkrKykgewogICAgICAgIHZhciBhc2NpaSA9IGJpbmFyeVN0cmluZy5jaGFyQ29kZUF0KGkpOwogICAgICAgIGJ5dGVzW2ldID0gYXNjaWk7CiAgICAgIH0KICAgICAgcmV0dXJuIGJ5dGVzOwogICAgfSwKCiAgICBidWlsZEV4cG9ydERhdGFSZXF1ZXN0KCkgewogICAgICBsZXQgcmVxdWVzdCA9IHsKICAgICAgICBuYW1lOiB0aGlzLmFzc2V0T2JqLm5hbWUsCiAgICAgICAgY2F0ZWdvcnk6CiAgICAgICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZC5kaXNwbGF5ICE9PSB1bmRlZmluZWQKICAgICAgICAgICAgPyB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZC5kaXNwbGF5CiAgICAgICAgICAgIDogdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQubmFtZSwKICAgICAgICBtb2RlbE51bWJlcjogdGhpcy5hc3NldE9iai5tb2RlbE51bWJlciwKICAgICAgICBtYW51ZmFjdHVyZXI6IHRoaXMuYXNzZXRPYmoubWFudWZhY3R1cmUsCiAgICAgICAgcHVyY2hhc2VEYXRlOgogICAgICAgICAgdGhpcy5kYXRlICE9PSBudWxsICYmIHRoaXMuZGF0ZSAhPT0gIiIKICAgICAgICAgICAgPyBtb21lbnQodGhpcy5kYXRlLCAiREQvTU0veXl5eSBoaDptbSBhIikudG9JU09TdHJpbmcoKQogICAgICAgICAgICA6IG51bGwsCiAgICAgICAgc3RhdHVzOiB0aGlzLmFzc2V0T2JqLnN0YXR1cywKICAgICAgICB3YXJyYW50eVVuaXQ6IHRoaXMuYXNzZXRPYmoud2FycmFudHlVbml0LAogICAgICAgIHdhcnJhbnR5OiB0aGlzLmFzc2V0T2JqLndhcnJhbnR5LAogICAgICAgIHByaW1hcnlVc2FnZVVuaXQ6IHRoaXMuYXNzZXRPYmoucHJpbWFyeVVzYWdlVW5pdCwKICAgICAgICBzZWNvbmRhcnlVc2FnZVVuaXQ6IHRoaXMuYXNzZXRPYmouc2Vjb25kYXJ5VXNhZ2VVbml0LAogICAgICAgIGNvbnN1bXB0aW9uVW5pdDogdGhpcy5hc3NldE9iai5jb25zdW1wdGlvblVuaXQsCiAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuZGVzY3JpcHRpb24sCiAgICAgICAgYWRkaXRpb25hbEZpZWxkczogW10sCiAgICAgIH07CiAgICAgIHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHMubWFwKChmaWVsZCkgPT4gewogICAgICAgIHJlcXVlc3QuYWRkaXRpb25hbEZpZWxkcy5wdXNoKHsKICAgICAgICAgIGZpZWxkTGFiZWw6IGZpZWxkLmVsZW1lbnRDb25maWcubGFiZWwsCiAgICAgICAgICBmaWVsZFZhbHVlOiBmaWVsZC52YWx1ZSwKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXF1ZXN0OwogICAgfSwKCiAgICBpbXBvcnRFeGNlbCh2YWx1ZSkgewogICAgICAvL2xvZ2ljIHRvIGltcG9ydCBBc3NldCBmaWxlCiAgICAgIGlmICh2YWx1ZS5sYWJlbCA9PT0gIkltcG9ydCIpIHsKICAgICAgICBpZiAodmFsdWUuZmlsZSAhPT0gbnVsbCAmJiB2YWx1ZS5maWxlICE9PSAiIikgewogICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgICAgIGxldCBjYXRlZ29yeSA9CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRDYXRlZ29yeUlkLmRpc3BsYXkgIT09IHVuZGVmaW5lZAogICAgICAgICAgICAgID8gdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQuZGlzcGxheQogICAgICAgICAgICAgIDogdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQubmFtZTsKICAgICAgICAgIEFzc2V0TWFuYWdlbWVudFNlcnZpY2UuaW1wb3J0RXhjZWxGaWxlKHZhbHVlLmZpbGUsIGNhdGVnb3J5KQogICAgICAgICAgICAudGhlbigocmVzcG9zbmUpID0+IHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICByZXNwb3NuZS5zdGF0dXMgPT09IDIwMCAmJgogICAgICAgICAgICAgICAgcmVzcG9zbmUuZGF0YS5yZXNwb25zZUlkZW50aWZpZXIgPT09ICJTdWNjZXNzIgogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmFzc2V0RGF0YSA9IHJlc3Bvc25lLmRhdGEuYXNzZXRFeGNlbERhdGE7CiAgICAgICAgICAgICAgICB0aGlzLmltcG9ydFN1Y2Nlc3MgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXNzZXRPYmoubmFtZSA9IHRoaXMuYXNzZXREYXRhLm5hbWU7CiAgICAgICAgdGhpcy5hc3NldE9iai5tb2RlbE51bWJlciA9IHRoaXMuYXNzZXREYXRhLm1vZGVsTnVtYmVyOwogICAgICAgIHRoaXMuYXNzZXRPYmoubWFudWZhY3R1cmUgPSB0aGlzLmFzc2V0RGF0YS5tYW51ZmFjdHVyZXI7CiAgICAgICAgdGhpcy5hc3NldE9iai5zdGF0dXMgPSB0aGlzLmFzc2V0RGF0YS5zdGF0dXM7CiAgICAgICAgdGhpcy5hc3NldE9iai53YXJyYW50eSA9IHRoaXMuYXNzZXREYXRhLndhcnJhbnR5OwogICAgICAgIHRoaXMuYXNzZXRPYmoud2FycmFudHlVbml0ID0gdGhpcy5hc3NldERhdGEud2FycmFudHlVbml0OwogICAgICAgIHRoaXMuYXNzZXRPYmoucHJpbWFyeVVzYWdlVW5pdCA9IHRoaXMuYXNzZXREYXRhLnByaW1hcnlVc2FnZVVuaXQ7CiAgICAgICAgdGhpcy5hc3NldE9iai5zZWNvbmRhcnlVc2FnZVVuaXQgPSB0aGlzLmFzc2V0RGF0YS5zZWNvbmRhcnlVc2FnZVVuaXQ7CiAgICAgICAgdGhpcy5hc3NldE9iai5jb25zdW1wdGlvblVuaXQgPSB0aGlzLmFzc2V0RGF0YS5jb25zdW1wdGlvblVuaXQ7CiAgICAgICAgdGhpcy5kZXNjcmlwdGlvbiA9IHRoaXMuYXNzZXREYXRhLmRlc2NyaXB0aW9uOwogICAgICAgIHRoaXMuZGF0ZSA9IG1vbWVudCh0aGlzLmFzc2V0RGF0YS5wdXJjaGFzZURhdGUpLmZvcm1hdCgiREQtTU1NLVlZWVkiKTsKICAgICAgICB0aGlzLmNhcmdvRGF0ZSA9IHRoaXMuYXNzZXREYXRhLnB1cmNoYXNlRGF0ZTsKICAgICAgICBsZXQgZmluZENhdGVnb3J5ID0gdGhpcy5Bc3NldENhdGVnb3J5LmZpbmQoCiAgICAgICAgICAoY2F0ZWdvcnkpID0+IGNhdGVnb3J5Lm5hbWUgPT09IHRoaXMuYXNzZXREYXRhLmNhdGVnb3J5CiAgICAgICAgKTsKICAgICAgICBpZiAoCiAgICAgICAgICBmaW5kQ2F0ZWdvcnkgIT09IHVuZGVmaW5lZCAmJgogICAgICAgICAgZmluZENhdGVnb3J5ICE9PSBudWxsICYmCiAgICAgICAgICBmaW5kQ2F0ZWdvcnkgIT09ICIiCiAgICAgICAgKSB7CiAgICAgICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkgPSBmaW5kQ2F0ZWdvcnk7CiAgICAgICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZCA9IGZpbmRDYXRlZ29yeTsKICAgICAgICAgIHRoaXMuY2F0ZWdvcnkgPSBmaW5kQ2F0ZWdvcnkubmFtZTsKICAgICAgICAgIHRoaXMuY2F0ZUluZGV4Kys7CiAgICAgICAgfQogICAgICAgIHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHMubWFwKChmaWVsZCkgPT4gewogICAgICAgICAgbGV0IGZvdW5kRmllbGQgPSB0aGlzLmFzc2V0RGF0YS5hZGRpdGlvbmFsRmllbGRzLmZpbmQoCiAgICAgICAgICAgIChmKSA9PiBmLmZpZWxkTGFiZWwgPT09IGZpZWxkLmVsZW1lbnRDb25maWcubGFiZWwKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIGZvdW5kRmllbGQgIT09IHVuZGVmaW5lZCAmJgogICAgICAgICAgICBmb3VuZEZpZWxkICE9PSBudWxsICYmCiAgICAgICAgICAgIGZvdW5kRmllbGQgIT09ICIiCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKGZpZWxkLmVsZW1lbnRUeXBlID09PSAiaW5wdXQiKSB7CiAgICAgICAgICAgICAgZmllbGQudmFsdWUgPSBmb3VuZEZpZWxkLmZpZWxkVmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmllbGQuZWxlbWVudFR5cGUgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBmaWVsZC5lbGVtZW50Q29uZmlnLm9wdGlvbnM7CiAgICAgICAgICAgICAgbGV0IHZhbHVlID0gb3B0aW9ucy5maW5kKAogICAgICAgICAgICAgICAgKHYpID0+CiAgICAgICAgICAgICAgICAgIHYubGFiZWwudHJpbSgpID09PSBmb3VuZEZpZWxkLmZpZWxkVmFsdWUudG9Mb3dlckNhc2UoKS50cmltKCkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSAiIikgewogICAgICAgICAgICAgICAgZmllbGQudmFsdWUgPSBmb3VuZEZpZWxkLmZpZWxkVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zZWxlY3RJbnB1dCsrOwogICAgICAgIHRoaXMuaW1wb3J0RXhwb3J0RGlhbG9nID0gZmFsc2U7CiAgICAgICAgdGhpcy5pbXBvcnRTdWNjZXNzID0gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgZ2V0QXNzZXREZXRhaWxzKCkgewogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICBBc3NldE1hbmFnZW1lbnRTZXJ2aWNlLmdldEFzc2V0KHRoaXMuYXNzZXRJRCkudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICB0aGlzLmltYWdlVm9pY2VzQ2hlY2sgPSByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0SW1hZ2VzOwogICAgICAgIHRoaXMuYXNzZXRPYmouaWQgPSByZXNwb25zZS5kYXRhLmFzc2V0LmlkOwogICAgICAgIHRoaXMuYXNzZXRPYmoubmFtZSA9IHJlc3BvbnNlLmRhdGEuYXNzZXQubmFtZTsKICAgICAgICB0aGlzLmFzc2V0T2JqLmFzc2V0TnVtYmVyID0gcmVzcG9uc2UuZGF0YS5hc3NldC5hc3NldE51bWJlcjsKICAgICAgICBkb2N1bWVudC50aXRsZSA9IHRoaXMuYXNzZXRPYmouYXNzZXROdW1iZXIgKyAiIHwgIiArICJFcm9oYWwiOwogICAgICAgIHRoaXMuYXNzZXRPYmoubW9kZWxOdW1iZXIgPSByZXNwb25zZS5kYXRhLmFzc2V0Lm1vZGVsTnVtYmVyOwogICAgICAgIHRoaXMuYXNzZXRPYmouaW52ZW50b3J5ID0gcmVzcG9uc2UuZGF0YS5hc3NldC5pbnZlbnRvcnk7CiAgICAgICAgdGhpcy5hc3NldE9iai5tYW51ZmFjdHVyZSA9IHJlc3BvbnNlLmRhdGEuYXNzZXQubWFudWZhY3R1cmU7CiAgICAgICAgdGhpcy5hc3NldE9iai5zdGF0dXMgPSByZXNwb25zZS5kYXRhLmFzc2V0LnN0YXR1czsKICAgICAgICB0aGlzLmFzc2V0Q2F0ZWdvcnlVVUlEID0gcmVzcG9uc2UuZGF0YS5hc3NldC5jYXRlZ29yeVVVSUQ7CiAgICAgICAgdGhpcy5hc3NldE9iai53YXJyYW50eSA9IHJlc3BvbnNlLmRhdGEuYXNzZXQud2FycmFudHkuc3BsaXQoIiAiKVswXTsKICAgICAgICB0aGlzLmFzc2V0T2JqLndhcnJhbnR5VW5pdCA9IHJlc3BvbnNlLmRhdGEuYXNzZXQud2FycmFudHkuc3BsaXQoIiAiKVsxXTsKICAgICAgICB0aGlzLmRlc2NyaXB0aW9uID0gcmVzcG9uc2UuZGF0YS5hc3NldC5kZXNjcmlwdGlvbjsKICAgICAgICB0aGlzLmFzc2V0T2JqLmNvbnN1bXB0aW9uVW5pdCA9IHJlc3BvbnNlLmRhdGEuYXNzZXQuY29uc3VtcHRpb25Vbml0OwogICAgICAgIHRoaXMuYXNzZXRPYmoucHJpbWFyeVVzYWdlVW5pdCA9IHJlc3BvbnNlLmRhdGEuYXNzZXQucHJpbWFyeVVzYWdlVW5pdDsKICAgICAgICB0aGlzLmFzc2V0T2JqLnNlY29uZGFyeVVzYWdlVW5pdCA9CiAgICAgICAgICByZXNwb25zZS5kYXRhLmFzc2V0LnNlY29uZGFyeVVzYWdlVW5pdDsKICAgICAgICB0aGlzLmRhdGUgPSBtb21lbnQocmVzcG9uc2UuZGF0YS5hc3NldC5wdXJjaGFzZURhdGUpLmZvcm1hdCgKICAgICAgICAgICJERC1NTU0tWVlZWSIKICAgICAgICApOwogICAgICAgIHRoaXMuYXNzZXRPYmoucHVyY2hhc2VEYXRlID0gbW9tZW50KAogICAgICAgICAgcmVzcG9uc2UuZGF0YS5hc3NldC5wdXJjaGFzZURhdGUKICAgICAgICApLmZvcm1hdCgiREQtTU0tWVlZWSIpOwogICAgICAgIHRoaXMuYXNzZXRPYmouY29zdCA9IHRoaXMuY29zdDsKICAgICAgICB0aGlzLmFzc2V0T2JqLmFzc2V0RmllbGRzID0gcmVzcG9uc2UuZGF0YS5hc3NldC5hc3NldEZpZWxkczsKICAgICAgICBpZiAodGhpcy5hc3NzZXRDYXRlZ29yeVVVSUQgIT09ICIiKSB7CiAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5Bc3NldENhdGVnb3J5Lmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBpZiAodGhpcy5hc3NldENhdGVnb3J5VVVJRCA9PT0gdGhpcy5Bc3NldENhdGVnb3J5W2luZGV4XS51dWlkKSB7CiAgICAgICAgICAgICAgdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5ID0gdGhpcy5Bc3NldENhdGVnb3J5W2luZGV4XTsKICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZCA9IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF07CiAgICAgICAgICAgICAgdGhpcy5jYXRlZ29yeSA9IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF0ubmFtZTsKICAgICAgICAgICAgICB0aGlzLmNhdGVJbmRleCsrOwogICAgICAgICAgICAgIHRoaXMuZGlzYWJsZUFkZEJ1dHRvbiA9IHRydWU7CiAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlRWRpdEJ1dHRvbiA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICB0aGlzLmdldEFzc2lnbm1lbnRIaXN0b3J5QnlBc3NldCgpOwoKICAgICAgICBsZXQgY2F0ZWdvcnlBc3NldEZpZWxkcyA9IFtdOwogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUgIT0gbnVsbCkgewogICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZS5maWVsZHMgIT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKAogICAgICAgICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgICAgICAgaW5kZXggPCByZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzLmxlbmd0aDsKICAgICAgICAgICAgICBpbmRleCsrCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XS50eXBlID09PSAidGV4dCIpIHsKICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdOwogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogImlucHV0IiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLm1hcEZpZWxkVmFsdWVzKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gInNlbGVjdCIKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGZpZWxkLm9wdGlvbnMuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb25zID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb3B0aW9uLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goeyBsYWJlbDogb3B0aW9uW2luZGV4XSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJzZWxlY3QiLAogICAgICAgICAgICAgICAgICBlbGVtZW50Q29uZmlnOiB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogInNlbGVjdCIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLm1hcEZpZWxkVmFsdWVzKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gImJvb2xlYW4iCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSByZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb24gPSBmaWVsZC5vcHRpb25zLnNwbGl0KCIsIik7CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9ucyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9wdGlvbi5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wdXNoKHsgbGFiZWw6IG9wdGlvbltpbmRleF0gfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgY2F0ZWdvcnlGaWVsZCA9IHsKICAgICAgICAgICAgICAgICAgaWQ6IGZpZWxkLnV1aWQsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRUeXBlOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRDb25maWc6IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLm1hcEZpZWxkVmFsdWVzKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gImNhbGVuZGVyIgogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvcHRpb24ubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7IGxhYmVsOiBvcHRpb25baW5kZXhdIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogImNhbGVuZGVyIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjYWxlbmRlciIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLm1hcEZpZWxkVmFsdWVzKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gImNhbGVuZGVyIgogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvcHRpb24ubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7IGxhYmVsOiBvcHRpb25baW5kZXhdIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogImNhbGVuZGVyIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjYWxlbmRlciIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLm1hcEZpZWxkVmFsdWVzKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gIm51bWVyaWMiCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSByZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb24gPSBmaWVsZC5vcHRpb25zLnNwbGl0KCIsIik7CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9ucyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9wdGlvbi5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wdXNoKHsgbGFiZWw6IG9wdGlvbltpbmRleF0gfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgY2F0ZWdvcnlGaWVsZCA9IHsKICAgICAgICAgICAgICAgICAgaWQ6IGZpZWxkLnV1aWQsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRUeXBlOiAibnVtZXJpYyIsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRDb25maWc6IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAibnVtZXJpYyIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLm1hcEZpZWxkVmFsdWVzKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNhdGVnb3J5QXNzZXRGaWVsZHMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGNhdGVnb3J5QXNzZXRGaWVsZHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHNbaW5kZXhdLmVsZW1lbnRDb25maWcubGFiZWwuaW5jbHVkZXMoCiAgICAgICAgICAgICAgICAgICAgIkRpbWVuc2lvbiIKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHNbaW5kZXhdLnZhbHVlID0gdGhpcy5kaW1lbnNpb25zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmNhdGVnb3J5RmllbGRzUmVzZXJ2ZSA9IGNhdGVnb3J5QXNzZXRGaWVsZHM7CiAgICAgICAgdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcyA9IGNhdGVnb3J5QXNzZXRGaWVsZHMuZmlsdGVyKAogICAgICAgICAgKGZpZWxkcykgPT4gZmllbGRzLmVsZW1lbnRDb25maWcubGFiZWwgIT09ICIjIG9mIFdhc2hlcyIKICAgICAgICApOwogICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICB9KTsKICAgIH0sCgogICAgbWFwRmllbGRWYWx1ZXMoZmllbGRWYWx1ZSkgewogICAgICBsZXQgdmFsdWUgPSAiTm8gdmFsdWUgZm91bmQiOwogICAgICBpZiAoCiAgICAgICAgZmllbGRWYWx1ZSAhPT0gdW5kZWZpbmVkICYmCiAgICAgICAgZmllbGRWYWx1ZSAhPT0gbnVsbCAmJgogICAgICAgIGZpZWxkVmFsdWUgIT09ICIiCiAgICAgICkgewogICAgICAgIHZhbHVlID0gSlNPTi5wYXJzZShmaWVsZFZhbHVlKS52YWx1ZXNbMF07CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKCiAgICBnZXRDdXJyZW5jeSgpIHsKICAgICAgbGV0IGN1cnJlbnRVc2VyRGV0YWlscyA9IEpTT04ucGFyc2UoCiAgICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oImN1cnJlbnRVc2VyRGV0YWlscyIpCiAgICAgICk7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5nZXRDb21wYW55Q3VycmVuY3koCiAgICAgICAgY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQKICAgICAgKS50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgIHRoaXMuY3VycmVuY3kgPSByZXNwb25zZS5kYXRhLmN1cnJlbmN5OwogICAgICB9KTsKICAgIH0sCgogICAgZGVsZXRlQXNzZXRJbWFnZShpZCkgewogICAgICBBc3NldE1hbmFnZW1lbnRTZXJ2aWNlLmRlbGV0ZUFzc2V0SW1hZ2UoaWQpCiAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgaWYgKHJlcykgewogICAgICAgICAgICB0aGlzLmdldEFzc2V0SW1hZ2VzKCk7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJJbWFnZXMgZGVsZXRlZCBzdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdChlLmRhdGEuZGVzY3JpcHRpb24sICJlcnJvciIpOwogICAgICAgIH0pOwogICAgfSwKCiAgICBlZGl0QXNzaWduZWQoaW5kZXgsIHZhbCkgewogICAgICB0aGlzLlNob3dQb3BVcCA9IHRydWU7CiAgICAgIHRoaXMudmFsdWVFZGl0QXNzaWduID0gdmFsOwogICAgICB0aGlzLmluZGV4Kys7CiAgICB9LAoKICAgIHVuQXNzaWduQXNzZXQoaW5kZXgsIHZhbHVlKSB7CiAgICAgIHRoaXMuYXNzaWduVGFibGVWYWx1ZSA9IHZhbHVlOwogICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgaWYgKG1vbWVudCh2YWx1ZS5zdGFydERhdGUpLmZvcm1hdCgpID4gY3VycmVudERhdGUpIHsKICAgICAgICB0aGlzLmZ1dHVyZWRVbkFzc2lnbm1lbnQodmFsdWUuYXNzaWdubWVudElkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnZhbHVlRWRpdEFzc2lnbiA9IHZhbHVlOwogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICB0aGlzLlNob3dVblBvcFVwID0gdHJ1ZTsKICAgICAgICB0aGlzLnVzZXJJbmRleCA9IGluZGV4OwogICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZUFzc2lnblVzZXIodmFsdWUpIHsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgdmFyIHNlbGVjdGVkRGF0ZSA9IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KAogICAgICAgICJZWVlZLU1NLUREVEhIOk1NOlNTWiIKICAgICAgKTsKICAgICAgdmFyIGRhdGVTcGxpdCA9IHNlbGVjdGVkRGF0ZS5zcGxpdCgiVCIpOwogICAgICB2YXIgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgdmFyIHRpbWVTcGxpdCA9IHZhbHVlLmFzc2lnbm1lbnRUaW1lLnNwbGl0KCI6Iik7CiAgICAgIHZhciBob3VyID0gdGltZVNwbGl0WzBdOwogICAgICB2YXIgbWludHMgPSB0aW1lU3BsaXRbMV07CiAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9CiAgICAgICAgb2JqRGF0ZSArICJUIiArIGhvdXIgKyAiOiIgKyBtaW50cyArICI6IiArICIwMCswNTowMCI7CiAgICAgIHZhbHVlLnN0YXJ0RGF0ZSA9IGFzc2lnbm1lbnREYXRlOwogICAgICB0aGlzLnVwZGF0ZUN1cnJlbnRBc3NpZ25tZW50KHZhbHVlKTsKICAgIH0sCgogICAgdXBkYXRlQ3VycmVudEFzc2lnbm1lbnQodmFsdWUpIHsKICAgICAgaWYgKHZhbHVlLnVzZXIubGVuZ3RoID4gMSkgewogICAgICAgIHRoaXMuc2hvd1RvYXN0KCJTZWxlY3Qgb25seSBvbmUgdXNlciIsICJlcnJvciIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgSW5zcGVjdGlvblNlcnZpY2UuZ2V0SW5zcGVjdGlvblRlbXBhbHRlc0J5QXNzZXQodGhpcy5hc3NldElEKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PSAyMDApIHsKICAgICAgICAgICAgbGV0IFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QgPSB7CiAgICAgICAgICAgICAgYXNzaWdubWVudElkOiB2YWx1ZS5hc3NpZ25tZW50SWQsCiAgICAgICAgICAgICAgYXNzZXRJZDogdGhpcy5hc3NldElELAogICAgICAgICAgICAgIHVzZXJJZDogdmFsdWUudXNlclswXS51dWlkLAogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgICAgICAgaWYgKHZhbHVlLmN1cnJlbnREYXRlVGltZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5zdGFydERhdGUgPSBjdXJyZW50RGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0LnN0YXJ0RGF0ZSA9IHZhbHVlLnN0YXJ0RGF0ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmVkaXRBc3NpZ25tZW50UmVjb3JkKAogICAgICAgICAgICAgIFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QKICAgICAgICAgICAgKQogICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZTEpID0+IHsKICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZTEuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIlVzZXIgVXBkYXRlIHN1Y2Nlc3NmdWxseSIsICJzdWNjZXNzIik7CiAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgICAgICAgICAgdGhpcy5TaG93UG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yMSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGVycm9yMS5yZXNwb25zZS5zdGF0dXMgPT09IDQwNikgewogICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICAgICAgICAgICAiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwKICAgICAgICAgICAgICAgICAgICAiZXJyb3IiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICAgICAgICAgICAiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwKICAgICAgICAgICAgICAgICAgICAiZXJyb3IiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7CiAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICBjcmVhdGVBc3NldCgpIHsKICAgICAgdGhpcy4kdi4kdG91Y2goKTsKICAgICAgaWYgKHRoaXMuJHYuJGludmFsaWQpIHsKICAgICAgICB0aGlzLnNob3dUb2FzdCgiUGxlYXNlIGZpbGwgYWxsIHJlcXVpcmVkIGZpZWxkcyIsICJ3YXJuaW5nIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CiAgICAgIGxldCBhc3NldE9iaiA9IHsKICAgICAgICBjYXRlZ29yeUlkOgogICAgICAgICAgdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQudmFsdWUgIT09IHVuZGVmaW5lZAogICAgICAgICAgICA/IHRoaXMuc2VsZWN0ZWRDYXRlZ29yeUlkLnZhbHVlCiAgICAgICAgICAgIDogdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQudXVpZCwKICAgICAgICBpbWFnZXM6IFtdLAogICAgICAgIGRvY3VtZW50czogW10sCiAgICAgICAgYXNzZXQ6IHsKICAgICAgICAgIC8vCWlkOnRoaXMuYXNzZXRPYmouaWQsCiAgICAgICAgICB0ZW5hbnRVVUlEOiAiIiwKICAgICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLmRlc2NyaXB0aW9uLAogICAgICAgICAgbmFtZTogdGhpcy5hc3NldE9iai5uYW1lLAogICAgICAgICAgc3RhdHVzOiB0aGlzLmFzc2V0T2JqLnN0YXR1cywKICAgICAgICAgIC8vCXF1YW50aXR5OiB0aGlzLmFzc2V0T2JqLnF1YW50aXR5LAogICAgICAgICAgbW9kZWxOdW1iZXI6IHRoaXMuYXNzZXRPYmoubW9kZWxOdW1iZXIsCiAgICAgICAgICAvLwlpbnZlbnRvcnk6IHRoaXMuYXNzZXRPYmouaW52ZW50b3J5LAogICAgICAgICAgbWFudWZhY3R1cmU6IHRoaXMuYXNzZXRPYmoubWFudWZhY3R1cmUsCiAgICAgICAgICBwdXJjaGFzZURhdGU6IHRoaXMuY2FyZ29EYXRlLAogICAgICAgICAgd2FycmFudHk6IHRoaXMuYXNzZXRPYmoud2FycmFudHkgKyAiICIgKyB0aGlzLmFzc2V0T2JqLndhcnJhbnR5VW5pdCwKICAgICAgICAgIGNvbnN1bXB0aW9uVW5pdDogdGhpcy5hc3NldE9iai5jb25zdW1wdGlvblVuaXQsCiAgICAgICAgICBwcmltYXJ5VXNhZ2VVbml0OiB0aGlzLmFzc2V0T2JqLnByaW1hcnlVc2FnZVVuaXQsCiAgICAgICAgICBzZWNvbmRhcnlVc2FnZVVuaXQ6IHRoaXMuYXNzZXRPYmouc2Vjb25kYXJ5VXNhZ2VVbml0LAogICAgICAgICAgYXNzZXRGaWVsZHM6IFtdLAogICAgICAgICAgYXNzZXRJbWFnZXM6IFtdLAogICAgICAgICAgYXR0YWNobWVudHM6IFtdLAogICAgICAgIH0sCiAgICAgIH07CgogICAgICBsZXQgYXNzZXRGaWVsZHMgPSBbXTsKCiAgICAgIGlmICh0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgbGV0IGFzc2V0RmllbGQgPSB7fTsKICAgICAgICAgIGFzc2V0RmllbGQuZmllbGRUZW1wbGF0ZUlkID0KICAgICAgICAgICAgdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LmZpZWxkVGVtcGxhdGUudXVpZDsKICAgICAgICAgIGFzc2V0RmllbGQuZmllbGRJZCA9IHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHNbaW5kZXhdLmlkOwogICAgICAgICAgYXNzZXRGaWVsZC5maWVsZFZhbHVlID0KICAgICAgICAgICAgJ3sidmFsdWVzIjpbIicgKyB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzW2luZGV4XS52YWx1ZSArICciXX0nOwogICAgICAgICAgYXNzZXRGaWVsZHMucHVzaChhc3NldEZpZWxkKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgKGFzc2V0T2JqLmFzc2V0LnRlbmFudFVVSUQgPQogICAgICAgIHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS50ZW5hbnRVVUlEID09IHVuZGVmaW5lZAogICAgICAgICAgPyB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkudGVuYW50dXVpZAogICAgICAgICAgOiB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkudGVuYW50VVVJRCksCiAgICAgICAgKGFzc2V0T2JqLmFzc2V0LmFzc2V0RmllbGRzID0gYXNzZXRGaWVsZHMpOwogICAgICBhc3NldE9iai5hc3NldC5hc3NldEltYWdlcyA9IHRoaXMuaW1hZ2VQYXRoOwogICAgICBhc3NldE9iai5hc3NldC5hdHRhY2htZW50cyA9IHRoaXMuZG9jUGF0aDsKICAgICAgLy8JcmV0dXJuOwogICAgICBjb25zb2xlLmxvZygiYXNzZXRPYmoiLCBhc3NldE9iaik7CiAgICAgIEFzc2V0TWFuYWdlbWVudFNlcnZpY2UuYWRkQXNzZXQoYXNzZXRPYmopCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKHsKICAgICAgICAgICAgICBuYW1lOiAiYXNzZXRzIiwKICAgICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgIHRvYXN0RmxhZzogdHJ1ZSwKICAgICAgICAgICAgICAgIHRvYXN0VHlwZTogInN1Y2Nlc3MiLAogICAgICAgICAgICAgICAgdG9hc3N0TWVzc2FnZTogcmVzcG9uc2UuZGF0YS5kZXNjcmlwdGlvbiwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICJUaGVyZSB3YXMgYSBwcm9ibGVtIGluIGFkZGluZyBhc3NldC4gS2luZGx5IHRyeSBhZ2FpbiIsCiAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICAgICAiVGhlcmUgd2FzIGEgcHJvYmxlbSBpbiBhZGRpbmcgYXNzZXQuIEtpbmRseSB0cnkgYWdhaW4iLAogICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgogICAgdXBkYXRlQXNzZXQoKSB7CiAgICAgIHRoaXMuJHYuJHRvdWNoKCk7CiAgICAgIGlmICh0aGlzLiR2LiRpbnZhbGlkKSB7CiAgICAgICAgdGhpcy5zaG93VG9hc3QoIlBsZWFzZSBmaWxsIGFsbCByZXF1aXJlZCBmaWVsZHMiLCAid2FybmluZyIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICBsZXQgYXNzZXRPYmogPSB7CiAgICAgICAgY2F0ZWdvcnlJZDogdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQudXVpZCwKICAgICAgICBpbWFnZXM6IG51bGwsCiAgICAgICAgZG9jdW1lbnRzOiBudWxsLAogICAgICAgIGFzc2V0OiB7CiAgICAgICAgICBpZDogdGhpcy5hc3NldE9iai5pZCwKICAgICAgICAgIHRlbmFudFVVSUQ6ICIiLAogICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuZGVzY3JpcHRpb24sCiAgICAgICAgICBuYW1lOiB0aGlzLmFzc2V0T2JqLm5hbWUsCiAgICAgICAgICB1dWlkOiB0aGlzLmFzc2V0SUQsCiAgICAgICAgICBhc3NldE51bWJlcjogdGhpcy5hc3NldE9iai5hc3NldE51bWJlciwKICAgICAgICAgIGNhdGVnb3J5VVVJRDogdGhpcy5hc3NldE9iai5jYXRlZ29yeVVVSUQsCiAgICAgICAgICBzdGF0dXM6IHRoaXMuYXNzZXRPYmouc3RhdHVzLAogICAgICAgICAgLy8JcXVhbnRpdHk6IHRoaXMuYXNzZXRPYmoucXVhbnRpdHksCiAgICAgICAgICBtb2RlbE51bWJlcjogdGhpcy5hc3NldE9iai5tb2RlbE51bWJlciwKICAgICAgICAgIC8vCWludmVudG9yeTogdGhpcy5hc3NldE9iai5pbnZlbnRvcnksCiAgICAgICAgICBtYW51ZmFjdHVyZTogdGhpcy5hc3NldE9iai5tYW51ZmFjdHVyZSwKICAgICAgICAgIHB1cmNoYXNlRGF0ZTogdGhpcy5jYXJnb0RhdGUsCiAgICAgICAgICB3YXJyYW50eTogdGhpcy5hc3NldE9iai53YXJyYW50eSArICIgIiArIHRoaXMuYXNzZXRPYmoud2FycmFudHlVbml0LAogICAgICAgICAgY29uc3VtcHRpb25Vbml0OiB0aGlzLmFzc2V0T2JqLmNvbnN1bXB0aW9uVW5pdCwKICAgICAgICAgIHByaW1hcnlVc2FnZVVuaXQ6IHRoaXMuYXNzZXRPYmoucHJpbWFyeVVzYWdlVW5pdCwKICAgICAgICAgIHNlY29uZGFyeVVzYWdlVW5pdDogdGhpcy5hc3NldE9iai5zZWNvbmRhcnlVc2FnZVVuaXQsCiAgICAgICAgICBhc3NldEZpZWxkczogW10sCiAgICAgICAgICBhc3NldEltYWdlczogW10sCiAgICAgICAgICBhdHRhY2htZW50czogW10sCiAgICAgICAgfSwKICAgICAgfTsKICAgICAgbGV0IGFzc2V0RmllbGRzID0gW107CgogICAgICBpZiAodGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcy5sZW5ndGggIT09IDApIHsKICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGxldCBhc3NldEZpZWxkID0ge307CiAgICAgICAgICBhc3NldEZpZWxkLmlkID0KICAgICAgICAgICAgdGhpcy5hc3NldE9iai5hc3NldEZpZWxkc1t0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzW2luZGV4XS5pZF0uaWQ7CiAgICAgICAgICBhc3NldEZpZWxkLnV1aWQgPQogICAgICAgICAgICB0aGlzLmFzc2V0T2JqLmFzc2V0RmllbGRzW3RoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHNbaW5kZXhdLmlkXS51dWlkOwogICAgICAgICAgYXNzZXRGaWVsZC5hc3NldFVVSUQgPQogICAgICAgICAgICB0aGlzLmFzc2V0T2JqLmFzc2V0RmllbGRzWwogICAgICAgICAgICAgIHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHNbaW5kZXhdLmlkCiAgICAgICAgICAgIF0uYXNzZXRVVUlEOwogICAgICAgICAgYXNzZXRGaWVsZC5maWVsZFRlbXBsYXRlSWQgPQogICAgICAgICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS51dWlkOwogICAgICAgICAgYXNzZXRGaWVsZC5maWVsZElkID0gdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkc1tpbmRleF0uaWQ7CiAgICAgICAgICBhc3NldEZpZWxkLmZpZWxkVmFsdWUgPQogICAgICAgICAgICAneyJ2YWx1ZXMiOlsiJyArIHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHNbaW5kZXhdLnZhbHVlICsgJyJdfSc7CiAgICAgICAgICBhc3NldEZpZWxkcy5wdXNoKGFzc2V0RmllbGQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gbGV0IGFzc2V0RmllbGRzID0gW107CiAgICAgIC8vIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAvLyAJbGV0IGFzc2V0RmllbGQgPSB7fTsKICAgICAgLy8gCWFzc2V0RmllbGQuZmllbGRUZW1wbGF0ZUlkID0gdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LmZpZWxkVGVtcGxhdGUudXVpZDsKICAgICAgLy8gCWFzc2V0RmllbGQuZmllbGRJZCA9IHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHNbaW5kZXhdLmlkOwogICAgICAvLyAJYXNzZXRGaWVsZC5maWVsZFZhbHVlID0gJ3sidmFsdWVzIjpbIicgKyB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzW2luZGV4XS52YWx1ZSArICciXX0nOwogICAgICAvLyAJYXNzZXRGaWVsZHMucHVzaChhc3NldEZpZWxkKTsKICAgICAgLy8gfQogICAgICAoYXNzZXRPYmouYXNzZXQudGVuYW50VVVJRCA9IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS50ZW5hbnRVVUlEKSwKICAgICAgICAoYXNzZXRPYmouYXNzZXQuYXNzZXRGaWVsZHMgPSBhc3NldEZpZWxkcyk7CiAgICAgIGFzc2V0T2JqLmFzc2V0LmFzc2V0SW1hZ2VzID0gdGhpcy5pbWFnZVBhdGg7CgogICAgICBhc3NldE9iai5hc3NldC5hdHRhY2htZW50cyA9IHRoaXMuZG9jUGF0aDsKICAgICAgLy8gcmV0dXJuCiAgICAgIEFzc2V0TWFuYWdlbWVudFNlcnZpY2UuZWRpdEFzc2V0KGFzc2V0T2JqKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZUlkZW50aWZpZXIgPT09ICJTdWNjZXNzIikgewogICAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7CiAgICAgICAgICAgICAgbmFtZTogImFzc2V0cyIsCiAgICAgICAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgICAgICB0b2FzdEZsYWc6IHRydWUsCiAgICAgICAgICAgICAgICB0b2FzdFR5cGU6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICAgIHRvYXNzdE1lc3NhZ2U6ICJBc3NldCB1cGRhdGVkIHN1Y2Nlc3NmdWxseSIsCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICAgICAiVGhlcmUgd2FzIGEgcHJvYmxlbSBpbiBhZGRpbmcgYXNzZXQuIEtpbmRseSB0cnkgYWdhaW4iLAogICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgIlRoZXJlIHdhcyBhIHByb2JsZW0gaW4gYWRkaW5nIGFzc2V0LiBLaW5kbHkgdHJ5IGFnYWluIiwKICAgICAgICAgICAgICAiZXJyb3IiCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAoKICAgIHVuYXNzaWduQXNzZXQoaW5kZXgsIGlkKSB7CiAgICAgIHRoaXMudXNlckluZGV4ID0gaW5kZXg7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS51bmFzc2lnbkFzc2V0KHRoaXMuYXNzZXRJRCwgaWQpCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgLy8gZGVidWdnZXI7CiAgICAgICAgICAgIGxldCB1c2VycyA9IHRoaXMuYXNzaWduZWRVc2VyczsKICAgICAgICAgICAgbGV0IGhpc3RvcnlVc2VycyA9IHRoaXMuYXNzaWdubWVudEhpc3RvcnlVc2VyczsKICAgICAgICAgICAgbGV0IGhpc3RvcnlBZGRlZCA9IGZhbHNlOwogICAgICAgICAgICAvLwl0aGlzLmRlbGV0ZU1vZGVsID0gZmFsc2U7CiAgICAgICAgICAgIGhpc3RvcnlVc2Vycy5tYXAoKGhpc3RvcnlJdGVtKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGhpc3RvcnlJdGVtLnV1aWQgPT09IGlkKSB7CiAgICAgICAgICAgICAgICBoaXN0b3J5SXRlbS51c2VyRW5kaW5nRGF0ZXMucHVzaCgKICAgICAgICAgICAgICAgICAgbW9tZW50KCkuZm9ybWF0KCJERCBNTU0gWVlZWSBoaDptbSBhIikKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBoaXN0b3J5QWRkZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gaGlzdG9yeUl0ZW07CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKCFoaXN0b3J5QWRkZWQpIHsKICAgICAgICAgICAgICBsZXQgbmV3VXNlciA9IHsKICAgICAgICAgICAgICAgIHV1aWQ6IGlkLAogICAgICAgICAgICAgICAgbmFtZTogdXNlcnNbdGhpcy51c2VySW5kZXhdLm5hbWUsCiAgICAgICAgICAgICAgICB1c2VyRW5kaW5nRGF0ZXM6IFttb21lbnQoKS5mb3JtYXQoIkREIE1NTSBZWVlZIGhoOm1tIGEiKV0sCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBoaXN0b3J5VXNlcnMucHVzaChuZXdVc2VyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1c2Vycy5zcGxpY2UodGhpcy51c2VySW5kZXgsIDEpOwogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiVXNlciBVbi1Bc3NpZ25lZCBTdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIFVuLUFzc2lnbmluZyB0aGUgdXNlci4gUGxlYXNlIHRyeSBhZ2FpbiIsCiAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgLy8gIHRoaXMuc2V0U3RhdGUoeyBsb2FkaW5nOiBmYWxzZX0pOwogICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICJFcnJvciB3aGlsZSBVbi1Bc3NpZ25pbmcgdGhlIHVzZXIuIFBsZWFzZSB0cnkgYWdhaW4iLAogICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICJFcnJvciB3aGlsZSBVbi1Bc3NpZ25pbmcgdGhlIHVzZXIuIFBsZWFzZSB0cnkgYWdhaW4iLAogICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgogICAgYXNzaWduVXNlcih2YWx1ZSkgewogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICBpZiAodGhpcy52YWx1ZSAhPT0gbnVsbCkgewogICAgICAgIHZhciBzZWxlY3RlZERhdGUgPSBtb21lbnQodmFsdWUuYXNzaWdubWVudERhdGUpLmZvcm1hdCgKICAgICAgICAgICJZWVlZLU1NLUREVEhIOk1NOlNTWiIKICAgICAgICApOwogICAgICAgIHZhciBkYXRlU3BsaXQgPSBzZWxlY3RlZERhdGUuc3BsaXQoIlQiKTsKICAgICAgICB2YXIgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgICB2YXIgdGltZVNwbGl0ID0gdmFsdWUuYXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgICB2YXIgaG91ciA9IHRpbWVTcGxpdFswXTsKICAgICAgICB2YXIgbWludHMgPSB0aW1lU3BsaXRbMV07CiAgICAgICAgbGV0IGFzc2lnbm1lbnREYXRlID0KICAgICAgICAgIG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWludHMgKyAiOiIgKyAiMDArMDU6MDAiOwoKICAgICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgICBpZiAodmFsdWUuY3VycmVudERhdGVUaW1lID09IHRydWUpIHsKICAgICAgICAgIHZhbHVlLnN0YXJ0RGF0ZSA9IGFzc2lnbm1lbnREYXRlOwogICAgICAgICAgdGhpcy5hc3NpZ25tZW50VXNlckN1cnJlbnREYXRlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgYXNzaWdubWVudERhdGUgPiBjdXJyZW50RGF0ZSAmJgogICAgICAgICAgdmFsdWUuY3VycmVudERhdGVUaW1lID09IGZhbHNlCiAgICAgICAgKSB7CiAgICAgICAgICB2YWx1ZS5zdGFydERhdGUgPSBhc3NpZ25tZW50RGF0ZTsKICAgICAgICAgIHRoaXMuYXNzaWdubWVudFVzZXJMYXRlcih2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmIChhc3NpZ25tZW50RGF0ZSA8IGN1cnJlbnREYXRlKSB7CiAgICAgICAgICB2YWx1ZS5zdGFydERhdGUgPSBhc3NpZ25tZW50RGF0ZTsKICAgICAgICAgIHRoaXMucGFzdEFzc2lnbm1lbnRVc2VyQ3VycmVudERhdGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBwYXN0QXNzaWdubWVudFVzZXJDdXJyZW50RGF0ZSh2YWx1ZSkgewogICAgICBJbnNwZWN0aW9uU2VydmljZS5nZXRJbnNwZWN0aW9uVGVtcGFsdGVzQnlBc3NldCh0aGlzLmFzc2V0SUQpCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgLy8JZGVidWdnZXIKICAgICAgICAgICAgbGV0IGFzc2lnbm1lbnRSZWNvcmQgPSBbXTsKICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZhbHVlLnVzZXIubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgY29uc3QgdXNlcklkID0gdmFsdWUudXNlcltpbmRleF0udXVpZDsKICAgICAgICAgICAgICBsZXQgb2JqID0gewogICAgICAgICAgICAgICAgYXNzZXRJZDogdGhpcy5hc3NldElELAogICAgICAgICAgICAgICAgYXNzZXRNYW5hZ2VySWQ6IHVzZXJJZCwKICAgICAgICAgICAgICAgIHR5cGU6ICIiLAogICAgICAgICAgICAgICAgc3RhcnRlZEF0OiB2YWx1ZS5zdGFydERhdGUsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBhc3NpZ25tZW50UmVjb3JkLnB1c2gob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdCA9IHt9OwogICAgICAgICAgICBhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0Lmluc3BlY3Rpb25UZW1wbGF0ZXMgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgICAgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5hc3NpZ25tZW50UmVjb3JkID0gYXNzaWdubWVudFJlY29yZDsKICAgICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmFkZEFzc2lnbm1lbnRSZWNvcmQoYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdCkKICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UxKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UxLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZE5vdGlmaWNhdGlvblRvQXNzaWduZWRVc2VyT2ZBc3NldHMoCiAgICAgICAgICAgICAgICAgICAgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdAogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBsZXQgdXNlcmRldGFpbCA9IFtdOwogICAgICAgICAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuZ2V0VXNlckRldGFpbEJ5QXNzZXRJZEFuZFVzZXJJZCgKICAgICAgICAgICAgICAgICAgICB0aGlzLmFzc2V0SUQsCiAgICAgICAgICAgICAgICAgICAgdmFsdWUudmFsdWUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZTIpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZTIuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC51dWlkID0gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwubmFtZSA9IHZhbHVlLmRpc3BsYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwuc3RhcnREYXRlID0gcmVzcG9uc2UyLmRhdGEudXNlci5zdGFydERhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwuY291bnQgPSByZXNwb25zZTIuZGF0YS51c2VyLmNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFzc2lnbmVkVXNlcnMucHVzaCh1c2VyZGV0YWlsKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkFzc2V0IEFzc2lnbmVkIHRvIHVzZXIgU3VjY2Vzc2Z1bGx5IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLlNob3dQb3BVcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IyKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IyLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IxKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IxLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAoKICAgIHVuQXNzaWduVXNlcih2YWx1ZSkgewogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgdmFyIHNlbGVjdGVkRGF0ZSA9IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KAogICAgICAgICJZWVlZLU1NLUREVEhIOk1NOlNTWiIKICAgICAgKTsKICAgICAgdmFyIGRhdGVTcGxpdCA9IHNlbGVjdGVkRGF0ZS5zcGxpdCgiVCIpOwogICAgICB2YXIgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgdmFyIHRpbWVTcGxpdCA9IHZhbHVlLmFzc2lnbm1lbnRUaW1lLnNwbGl0KCI6Iik7CiAgICAgIHZhciBob3VyID0gdGltZVNwbGl0WzBdOwogICAgICB2YXIgbWludHMgPSB0aW1lU3BsaXRbMV07CiAgICAgIHZhciBhc3NpZ25tZW50RGF0ZSA9CiAgICAgICAgb2JqRGF0ZSArICJUIiArIGhvdXIgKyAiOiIgKyBtaW50cyArICI6IiArICIwMCswNTowMCI7CiAgICAgIGlmICgKICAgICAgICBEYXRlLnBhcnNlKHRoaXMuYXNzaWduVGFibGVWYWx1ZS5zdGFydERhdGUpID4gRGF0ZS5wYXJzZShhc3NpZ25tZW50RGF0ZSkKICAgICAgKSB7CiAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAiU2VsZWN0IERhdGUgYW5kIHRpbWUgbGF0ZXIgdG8gY3VycmVudCBhc3NpZ25tZW50IGRhdGUgYW5kIHRpbWUuIiwKICAgICAgICAgICJlcnJvciIKICAgICAgICApOwogICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodmFsdWUuY3VycmVudERhdGVUaW1lID09IHRydWUpIHsKICAgICAgICBsZXQgRGVsZXRlQXNzaWdubWVudFJlY29yZFJlcXVlc3QgPSB7CiAgICAgICAgICBhc3NldFVVSUQ6IHRoaXMuYXNzZXRJRCwKICAgICAgICAgIHVzZXJVVUlEOiB2YWx1ZS51dWlkLAogICAgICAgICAgZW5kaW5nRGF0ZTogY3VycmVudERhdGUsCiAgICAgICAgfTsKICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UudW5hc3NpZ25Bc3NldChEZWxldGVBc3NpZ25tZW50UmVjb3JkUmVxdWVzdCkudGhlbigKICAgICAgICAgIChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgdXNlcnMgPSB0aGlzLmFzc2lnbmVkVXNlcnM7CiAgICAgICAgICAgIGxldCBoaXN0b3J5VXNlcnMgPSB0aGlzLmFzc2lnbm1lbnRIaXN0b3J5VXNlcnM7CiAgICAgICAgICAgIGxldCBoaXN0b3J5QWRkZWQgPSBmYWxzZTsKICAgICAgICAgICAgaGlzdG9yeVVzZXJzLm1hcCgoaGlzdG9yeUl0ZW0pID0+IHsKICAgICAgICAgICAgICBpZiAoaGlzdG9yeUl0ZW0udXVpZCA9PT0gdmFsdWUudXVpZCkgewogICAgICAgICAgICAgICAgaGlzdG9yeUl0ZW0udXNlckVuZGluZ0RhdGVzOwogICAgICAgICAgICAgICAgaGlzdG9yeUl0ZW0udXNlclN0YXJ0RGF0ZXM7CiAgICAgICAgICAgICAgICBoaXN0b3J5QWRkZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gaGlzdG9yeUl0ZW07CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKCFoaXN0b3J5QWRkZWQpIHsKICAgICAgICAgICAgICBsZXQgbmV3VXNlciA9IHsKICAgICAgICAgICAgICAgIHV1aWQ6IHZhbHVlLnV1aWQsCiAgICAgICAgICAgICAgICBuYW1lOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0ubmFtZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uczogdXNlcnNbdGhpcy51c2VySW5kZXhdLmR1cmF0aW9ucywKICAgICAgICAgICAgICAgIHVzZXJTdGFydERhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlclN0YXJ0RGF0ZXMsCiAgICAgICAgICAgICAgICB1c2VyRW5kaW5nRGF0ZXM6IHVzZXJzW3RoaXMudXNlckluZGV4XS51c2VyRW5kaW5nRGF0ZXMsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBoaXN0b3J5VXNlcnMucHVzaChuZXdVc2VyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1c2Vycy5zcGxpY2UodGhpcy51c2VySW5kZXgsIDEpOwogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiVXNlciBVbi1Bc3NpZ25lZCBTdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgICAgICAgIHRoaXMuZ2V0QXNzaWdubWVudEhpc3RvcnlCeUFzc2V0KCk7CiAgICAgICAgICAgIHRoaXMuU2hvd1VuUG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudXNlcmFzOwogICAgICAgICAgfQogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgdmFsdWUuY3VycmVudERhdGVUaW1lID09IGZhbHNlICYmCiAgICAgICAgY3VycmVudERhdGUgPiBtb21lbnQoYXNzaWdubWVudERhdGUpLmZvcm1hdCgpCiAgICAgICkgewogICAgICAgIHNlbGVjdGVkRGF0ZSA9IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KAogICAgICAgICAgIllZWVktTU0tRERUSEg6TU06U1NaIgogICAgICAgICk7CiAgICAgICAgZGF0ZVNwbGl0ID0gc2VsZWN0ZWREYXRlLnNwbGl0KCJUIik7CiAgICAgICAgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgICB0aW1lU3BsaXQgPSB2YWx1ZS5hc3NpZ25tZW50VGltZS5zcGxpdCgiOiIpOwogICAgICAgIGhvdXIgPSB0aW1lU3BsaXRbMF07CiAgICAgICAgbWludHMgPSB0aW1lU3BsaXRbMV07CiAgICAgICAgbGV0IGFzc2lnbm1lbnREYXRlID0KICAgICAgICAgIG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWludHMgKyAiOiIgKyAiMDArMDU6MDAiOwogICAgICAgIGxldCBEZWxldGVBc3NpZ25tZW50UmVjb3JkUmVxdWVzdCA9IHsKICAgICAgICAgIGFzc2V0VVVJRDogdGhpcy5hc3NldElELAogICAgICAgICAgdXNlclVVSUQ6IHZhbHVlLnV1aWQsCiAgICAgICAgICBlbmRpbmdEYXRlOiBtb21lbnQoYXNzaWdubWVudERhdGUpLmZvcm1hdCgpLAogICAgICAgIH07CiAgICAgICAgLy8JcmV0dXJuOwogICAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS51bmFzc2lnbkFzc2V0KERlbGV0ZUFzc2lnbm1lbnRSZWNvcmRSZXF1ZXN0KS50aGVuKAogICAgICAgICAgKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB1c2VycyA9IHRoaXMuYXNzaWduZWRVc2VyczsKICAgICAgICAgICAgbGV0IGhpc3RvcnlVc2VycyA9IHRoaXMuYXNzaWdubWVudEhpc3RvcnlVc2VyczsKICAgICAgICAgICAgbGV0IGhpc3RvcnlBZGRlZCA9IGZhbHNlOwogICAgICAgICAgICAvL3JldHVybjsKICAgICAgICAgICAgaGlzdG9yeVVzZXJzLm1hcCgoaGlzdG9yeUl0ZW0pID0+IHsKICAgICAgICAgICAgICBpZiAoaGlzdG9yeUl0ZW0udXVpZCA9PT0gdmFsdWUudXVpZCkgewogICAgICAgICAgICAgICAgaGlzdG9yeUl0ZW0udXNlckVuZGluZ0RhdGVzOwogICAgICAgICAgICAgICAgaGlzdG9yeUl0ZW0udXNlclN0YXJ0RGF0ZXM7CiAgICAgICAgICAgICAgICBoaXN0b3J5QWRkZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gaGlzdG9yeUl0ZW07CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKCFoaXN0b3J5QWRkZWQpIHsKICAgICAgICAgICAgICBsZXQgbmV3VXNlciA9IHsKICAgICAgICAgICAgICAgIHV1aWQ6IHZhbHVlLnV1aWQsCiAgICAgICAgICAgICAgICBuYW1lOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0ubmFtZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uczogdXNlcnNbdGhpcy51c2VySW5kZXhdLmR1cmF0aW9ucywKICAgICAgICAgICAgICAgIHVzZXJTdGFydERhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlclN0YXJ0RGF0ZXMsCiAgICAgICAgICAgICAgICB1c2VyRW5kaW5nRGF0ZXM6IHVzZXJzW3RoaXMudXNlckluZGV4XS51c2VyRW5kaW5nRGF0ZXMsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBoaXN0b3J5VXNlcnMucHVzaChuZXdVc2VyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1c2Vycy5zcGxpY2UodGhpcy51c2VySW5kZXgsIDEpOwogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiVXNlciBVbi1Bc3NpZ25lZCBTdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgICAgICAgIHRoaXMuZ2V0QXNzaWdubWVudEhpc3RvcnlCeUFzc2V0KCk7CiAgICAgICAgICAgIHRoaXMuU2hvd1VuUG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudXNlcmFzOwogICAgICAgICAgfQogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgY3VycmVudERhdGUgPCBtb21lbnQoYXNzaWdubWVudERhdGUpLmZvcm1hdCgpICYmCiAgICAgICAgdmFsdWUuY3VycmVudERhdGVUaW1lID09IGZhbHNlCiAgICAgICkgewogICAgICAgIHNlbGVjdGVkRGF0ZSA9IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KAogICAgICAgICAgIllZWVktTU0tRERUSEg6TU06U1NaIgogICAgICAgICk7CiAgICAgICAgZGF0ZVNwbGl0ID0gc2VsZWN0ZWREYXRlLnNwbGl0KCJUIik7CiAgICAgICAgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgICB0aW1lU3BsaXQgPSB2YWx1ZS5hc3NpZ25tZW50VGltZS5zcGxpdCgiOiIpOwogICAgICAgIGhvdXIgPSB0aW1lU3BsaXRbMF07CiAgICAgICAgbWludHMgPSB0aW1lU3BsaXRbMV07CiAgICAgICAgbGV0IGFzc2lnbm1lbnREYXRlID0KICAgICAgICAgIG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWludHMgKyAiOiIgKyAiMDArMDU6MDAiOwogICAgICAgIHZhbHVlLnN0YXJ0RGF0ZSA9IGFzc2lnbm1lbnREYXRlOwogICAgICAgIHRoaXMudW5Bc3NpZ25tZW50VXNlckxhdGVyKHZhbHVlKTsKICAgICAgfQogICAgfSwKCiAgICB1bkFzc2lnbm1lbnRVc2VyTGF0ZXIodmFsdWUpIHsKICAgICAgSW5zcGVjdGlvblNlcnZpY2UuZ2V0SW5zcGVjdGlvblRlbXBhbHRlc0J5QXNzZXQodGhpcy5hc3NldElEKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIGxldCBwb3N0QXNzaWdubWVudCA9IFtdOwogICAgICAgICAgICBsZXQgb2JqID0gewogICAgICAgICAgICAgIGFzc2lnbm1lbnRVVUlEOiB2YWx1ZS5hc3NpZ25tZW50VVVJRCwKICAgICAgICAgICAgICBhc3NldElkOiB0aGlzLmFzc2V0SUQsCiAgICAgICAgICAgICAgdXNlcklkOiB2YWx1ZS51dWlkLAogICAgICAgICAgICAgIGFzc2lnbjogZmFsc2UsCiAgICAgICAgICAgICAgZW5kRGF0ZTogdmFsdWUuc3RhcnREYXRlLAogICAgICAgICAgICB9OwogICAgICAgICAgICBwb3N0QXNzaWdubWVudC5wdXNoKG9iaik7CiAgICAgICAgICAgIGxldCBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0ID0ge307CiAgICAgICAgICAgIFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QuaW5zcGVjdGlvblRlbXBsYXRlcyA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5pbnNwZWN0aW9uVGVtcGxhdGVzOwogICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0LnBvc3RBc3NpZ25tZW50ID0gcG9zdEFzc2lnbm1lbnQ7CiAgICAgICAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5hZGRQb3N0QXNzaWdubWVudE9yVW5Bc3NpZ25tZW50KAogICAgICAgICAgICAgIFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QKICAgICAgICAgICAgKQogICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KHJlcy5kYXRhLmRlc2NyaXB0aW9uLCAic3VjY2VzcyIpOwogICAgICAgICAgICAgICAgdGhpcy5TaG93VW5Qb3BVcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgICAgICAgICAgICB0aGlzLmdldEFzc2lnbm1lbnRIaXN0b3J5QnlBc3NldCgpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICBjb25zb2xlLmxvZygiZXJyb3IiLCBlKTsKICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgIH0pOwogICAgfSwKCiAgICBhc3NpZ25tZW50VXNlckxhdGVyKHZhbHVlKSB7CiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLmdldEluc3BlY3Rpb25UZW1wYWx0ZXNCeUFzc2V0KHRoaXMuYXNzZXRJRCkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICBsZXQgcG9zdEFzc2lnbm1lbnQgPSBbXTsKICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZhbHVlLnVzZXIubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgY29uc3QgdXNlcklkID0gdmFsdWUudXNlcltpbmRleF0udXVpZDsKICAgICAgICAgICAgICBsZXQgb2JqID0gewogICAgICAgICAgICAgICAgYXNzaWdubWVudFVVSUQ6ICIiLAogICAgICAgICAgICAgICAgYXNzZXRJZDogdGhpcy5hc3NldElELAogICAgICAgICAgICAgICAgdXNlcklkOiB1c2VySWQsCiAgICAgICAgICAgICAgICBhc3NpZ246IHRydWUsCiAgICAgICAgICAgICAgICBzdGFydERhdGU6IHZhbHVlLnN0YXJ0RGF0ZSwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHBvc3RBc3NpZ25tZW50LnB1c2gob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdCA9IHt9OwogICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0Lmluc3BlY3Rpb25UZW1wbGF0ZXMgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgICAgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5wb3N0QXNzaWdubWVudCA9IHBvc3RBc3NpZ25tZW50OwogICAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuYWRkUG9zdEFzc2lnbm1lbnRPclVuQXNzaWdubWVudCgKICAgICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0CiAgICAgICAgICAgICkKICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdChyZXMuZGF0YS5kZXNjcmlwdGlvbiwgInN1Y2Nlc3MiKTsKICAgICAgICAgICAgICAgIHRoaXMuU2hvd1BvcFVwID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgY29uc29sZS5sb2coImVycm9yIiwgZSk7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICB9KTsKICAgIH0sCgogICAgc2VuZE5vdGlmaWNhdGlvblRvQXNzaWduZWRVc2VyT2ZBc3NldHMoYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdCkgewogICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2Uuc2VuZE5vdGlmaWNhdGlvblRvQXNzaWduZWRVc2VycygKICAgICAgICBhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0CiAgICAgICkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpOwogICAgICAgIH0pOwogICAgfSwKCiAgICBhc3NpZ25tZW50VXNlckN1cnJlbnREYXRlKHZhbHVlKSB7CiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLmdldEluc3BlY3Rpb25UZW1wYWx0ZXNCeUFzc2V0KHRoaXMuYXNzZXRJRCkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIHZhciBjdXJyZW50RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgpOwogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIGxldCBhc3NpZ25tZW50UmVjb3JkID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2YWx1ZS51c2VyLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgIGNvbnN0IHVzZXJJZCA9IHZhbHVlLnVzZXJbaW5kZXhdLnV1aWQ7CiAgICAgICAgICAgICAgbGV0IG9iaiA9IHsKICAgICAgICAgICAgICAgIGFzc2V0SWQ6IHRoaXMuYXNzZXRJRCwKICAgICAgICAgICAgICAgIGFzc2V0TWFuYWdlcklkOiB1c2VySWQsCiAgICAgICAgICAgICAgICB0eXBlOiAiIiwKICAgICAgICAgICAgICAgIHN0YXJ0ZWRBdDogY3VycmVudERhdGUsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBhc3NpZ25tZW50UmVjb3JkLnB1c2gob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdCA9IHt9OwogICAgICAgICAgICBhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0Lmluc3BlY3Rpb25UZW1wbGF0ZXMgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgICAgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5hc3NpZ25tZW50UmVjb3JkID0gYXNzaWdubWVudFJlY29yZDsKCiAgICAgICAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5hZGRBc3NpZ25tZW50UmVjb3JkKGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QpCiAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlMSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlMS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICB0aGlzLnNlbmROb3RpZmljYXRpb25Ub0Fzc2lnbmVkVXNlck9mQXNzZXRzKAogICAgICAgICAgICAgICAgICAgIGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgbGV0IHVzZXJkZXRhaWwgPSBbXTsKICAgICAgICAgICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmdldFVzZXJEZXRhaWxCeUFzc2V0SWRBbmRVc2VySWQoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hc3NldFV1aWQsCiAgICAgICAgICAgICAgICAgICAgdmFsdWUudmFsdWUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZTIpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZTIuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC51dWlkID0gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwubmFtZSA9IHZhbHVlLmRpc3BsYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwuc3RhcnREYXRlID0gcmVzcG9uc2UyLmRhdGEudXNlci5zdGFydERhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwuY291bnQgPSByZXNwb25zZTIuZGF0YS51c2VyLmNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFzc2lnbmVkVXNlcnMucHVzaCh1c2VyZGV0YWlsKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkFzc2V0IEFzc2lnbmVkIHRvIHVzZXIgU3VjY2Vzc2Z1bGx5IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLlNob3dQb3BVcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IyKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IyLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IxKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IxLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAoKICAgIGdldEFzc2lnbm1lbnRIaXN0b3J5QnlBc3NldCgpIHsKICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmdldEFzc2lnbm1lbnRIaXN0b3J5QnlBc3NldCgKICAgICAgICB0aGlzLmFzc2V0SUQsCiAgICAgICAgdGhpcy5wYWdlLAogICAgICAgIHRoaXMucm93c1BlclBhZ2UKICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIGxldCB1c2VycyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVzcG9uc2UuZGF0YS5kZXRhaWxzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgIGxldCBvYmogPSB7fTsKICAgICAgICAgICAgICBvYmoubmFtZSA9IHJlc3BvbnNlLmRhdGEuZGV0YWlsc1tpbmRleF0ubmFtZTsKICAgICAgICAgICAgICBvYmouY291bnQgPSByZXNwb25zZS5kYXRhLmRldGFpbHNbaW5kZXhdLmNvdW50OwogICAgICAgICAgICAgIG9iai51c2VyU3RhcnREYXRlcyA9IG1vbWVudCgKICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGV0YWlsc1tpbmRleF0uc3RhcnREYXRlCiAgICAgICAgICAgICAgKS5mb3JtYXQoIkREIE1NTSBZWVlZIGhoOm1tIGEiKTsKICAgICAgICAgICAgICBvYmoudXNlckVuZGluZ0RhdGVzID0gbW9tZW50KAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kZXRhaWxzW2luZGV4XS5lbmREYXRlCiAgICAgICAgICAgICAgKS5mb3JtYXQoIkREIE1NTSBZWVlZIGhoOm1tIGEiKTsKICAgICAgICAgICAgICBvYmoudXVpZCA9IHJlc3BvbnNlLmRhdGEuZGV0YWlsc1tpbmRleF0udXVpZDsKICAgICAgICAgICAgICBvYmouZHVyYXRpb25zID0gcmVzcG9uc2UuZGF0YS5kZXRhaWxzW2luZGV4XS5kdXJhdGlvbjsKICAgICAgICAgICAgICBvYmouc3RhdHVzID0gcmVzcG9uc2UuZGF0YS5kZXRhaWxzW2luZGV4XS5zdGF0dXM7CiAgICAgICAgICAgICAgdXNlcnMucHVzaChvYmopOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXNzaWdubWVudEhpc3RvcnlVc2VycyA9IHVzZXJzOwogICAgICAgICAgICB0aGlzLmFzc2lnbm1lbnRIaXN0b3J5VXNlcnMudG90YWxQYWdlcyA9IHJlc3BvbnNlLmRhdGEudG90YWxQYWdlczsKICAgICAgICAgICAgdGhpcy5hc3NpZ25tZW50SGlzdG9yeVVzZXJzLnRvdGFsRWxlbWVudHMgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEudG90YWxFbGVtZW50czsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwNikgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiT3BwcyBpdHMgbG9vayBsaWtlIG91ciBzZXJ2ZXIgaXMgb2ZmbGluZSIsICJlcnJvciIpOwogICAgICAgICAgfQogICAgICAgICAgLy8gICB0aGlzLnNldFN0YXRlKHsgbG9hZGluZzogZmFsc2V9KTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiT3BwcyBpdHMgbG9vayBsaWtlIG91ciBzZXJ2ZXIgaXMgb2ZmbGluZSIsICJlcnJvciIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICBmdXR1cmVkVW5Bc3NpZ25tZW50KHV1aWQpIHsKICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmRlbGV0ZVBvc3RBc3NpZ25tZW50QnlVVUlEKHV1aWQpCiAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgdGhpcy5zaG93VG9hc3QocmVzLmRhdGEuZGVzY3JpcHRpb24sICJzdWNjZXNzIik7CiAgICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KGUuZGF0YS5kZXNjcmlwdGlvbiwgImVycm9yIik7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIHNlbGVjdFVzZXIoKSB7CiAgICAgIGxldCBjdXJyZW50VXNlckRldGFpbHMgPSBKU09OLnBhcnNlKAogICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjdXJyZW50VXNlckRldGFpbHMiKQogICAgICApOwogICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuZ2V0QWxsVXNlcnMoCiAgICAgICAgY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQKICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgbGV0IHVzZXJzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVzcG9uc2UuZGF0YS51c2Vycy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgbGV0IHVzZXIgPSB7fTsKICAgICAgICAgICAgdXNlci5sYWJlbCA9IHJlc3BvbnNlLmRhdGEudXNlcnNbaW5kZXhdLm5hbWU7CiAgICAgICAgICAgIHVzZXIudmFsdWUgPSByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5uYW1lOwogICAgICAgICAgICB1c2VyLnV1aWQgPSByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS51dWlkOwogICAgICAgICAgICB1c2VyLm5hbWUgPSByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5uYW1lOwogICAgICAgICAgICB1c2Vycy5wdXNoKHVzZXIpOwogICAgICAgICAgICB0aGlzLmFsbFVzZXJzLnB1c2goewogICAgICAgICAgICAgIGZpcnN0TmFtZTogcmVzcG9uc2UuZGF0YS51c2Vyc1tpbmRleF0uZmlyc3ROYW1lLAogICAgICAgICAgICAgIGxhc3ROYW1lOiByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5sYXN0TmFtZSwKICAgICAgICAgICAgICBwcm9maWxlSW1hZ2U6IHJlc3BvbnNlLmRhdGEudXNlcnNbaW5kZXhdLmltYWdlVXJsLAogICAgICAgICAgICAgIHV1aWQ6IHJlc3BvbnNlLmRhdGEudXNlcnNbaW5kZXhdLnV1aWQsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5Vc2VycyA9IHVzZXJzOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgZmV0Y2hpbmcgdGhlIHVzZXJzIiwgImVycm9yIik7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIHNob3dBc3NpZ25Qb3BVcCgpIHsKICAgICAgdGhpcy5TaG93UG9wVXAgPSB0cnVlOwogICAgfSwKCiAgICBvcGVuUG9wVXAoKSB7CiAgICAgIHRoaXMuY2F0ZWdvcnlQb3BVcCA9IHRydWU7CiAgICB9LAoKICAgIGNsb3NlKCkgewogICAgICB0aGlzLmNhdGVnb3J5UG9wVXAgPSBmYWxzZTsKICAgICAgdGhpcy5TaG93UG9wVXAgPSBmYWxzZTsKICAgICAgdGhpcy5pbWFnZURpYWxvZyA9IGZhbHNlOwogICAgICB0aGlzLlNob3dVblBvcFVwID0gZmFsc2U7CiAgICAgIHRoaXMuaW1wb3J0RXhwb3J0RGlhbG9nID0gZmFsc2U7CiAgICAgIHRoaXMuaW1wb3J0U3VjY2VzcyA9IGZhbHNlOwogICAgfSwKCiAgICBmdWxsc2NyZWVuSW1hZ2UodmFsdWUpIHsKICAgICAgdGhpcy5wb3B1cEltYWdlID0gdmFsdWU7CiAgICAgIHRoaXMuaW1hZ2VEaWFsb2cgPSB0cnVlOwogICAgfSwKCiAgICBvblNlbGVjdGVkKHZhbHVlKSB7CiAgICAgIC8vIGNvbnNvbGUubG9nKCJzZWxldGVkIHZhbHVlIiwgdmFsdWUpOwogICAgfSwKCiAgICBjbGVhclNlbGVjdGVkU3RhdHVzKCkgewogICAgICB0aGlzLmFzc2V0T2JqLnN0YXR1cyA9ICIiOwogICAgICB0aGlzLmNhdGVJbmRleCsrOwogICAgfSwKCiAgICBjbGVhclNlbGVjdGVkV2FycmFudHlVbml0KCkgewogICAgICB0aGlzLmFzc2V0T2JqLndhcnJhbnR5VW5pdCA9ICIiOwogICAgICB0aGlzLmNhdGVJbmRleCsrOwogICAgfSwKCiAgICBzYXZlQWRkQ2F0ZWdvcnkodmFsdWUpIHsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgbGV0IGFkZENhdGVnb3J5ID0gewogICAgICAgIGNhdGVnb3J5OiB7CiAgICAgICAgICBuYW1lOiB2YWx1ZS5jYXRlZ29yeU5hbWUsCiAgICAgICAgICBkZXNjcmlwdGlvbjogdmFsdWUubWVzc2FnZUJveCwKICAgICAgICAgIHRlbmFudFVVSUQ6IHRoaXMuY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQsCiAgICAgICAgICBmaWVsZFRlbXBsYXRlOiB7CiAgICAgICAgICAgIHR5cGU6IHZhbHVlLmNhdGVnb3J5TmFtZSArICIgZmllbGQgdGVtcGxhdGUiLAogICAgICAgICAgICB0ZW5hbnRVVUlEOiB0aGlzLmN1cnJlbnRVc2VyRGV0YWlscy5wcm9maWxlLm9yZ2FuaXphdGlvbklkLAogICAgICAgICAgICBmaWVsZHM6IFtdLAogICAgICAgICAgfSwKICAgICAgICB9LAogICAgICB9OwoKICAgICAgbGV0IGZpZWxkcyA9IFtdOwogICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdmFsdWUuY2F0ZWdvcnlGaWVsZHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgbGV0IGFkZENhdGVnb3J5RmllbGQgPSB2YWx1ZS5jYXRlZ29yeUZpZWxkc1tpbmRleF07CiAgICAgICAgbGV0IGZpZWxkID0ge307CiAgICAgICAgZmllbGQubGFiZWwgPSBhZGRDYXRlZ29yeUZpZWxkLmxhYmVsOwogICAgICAgIGZpZWxkLnR5cGUgPSBhZGRDYXRlZ29yeUZpZWxkLnR5cGU7CiAgICAgICAgZmllbGQuZmllbGRQb3NpdGlvbiA9IGFkZENhdGVnb3J5RmllbGQucG9zaXRpb247CiAgICAgICAgZmllbGQubWFuZGF0b3J5ID0gYWRkQ2F0ZWdvcnlGaWVsZC5tYW5kYXRvcnk7CiAgICAgICAgZmllbGQub3B0aW9ucyA9IGFkZENhdGVnb3J5RmllbGQub3B0aW9uczsKICAgICAgICBmaWVsZHMucHVzaChmaWVsZCk7CiAgICAgIH0KICAgICAgYWRkQ2F0ZWdvcnkuY2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS5maWVsZHMgPSBmaWVsZHM7CiAgICAgIEFzc2V0TWFuYWdlbWVudFNlcnZpY2UuYWRkQ2F0ZWdvcnkoYWRkQ2F0ZWdvcnkpCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZUlkZW50aWZpZXIgPT09ICJTdWNjZXNzIikgewogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jYXRlZ29yeVBvcFVwID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJDYXRlZ29yeSBhZGRlZCBzdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dUb2FzdChlcnJvci5kYXRhLmRlc2NyaXB0aW9uLCAiZXJyb3IiKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgogICAgdXBkYXRlQWRkQ2F0ZWdvcnkodmFsdWUpIHsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgbGV0IGFkZENhdGVnb3J5ID0gewogICAgICAgIGNhdGVnb3J5OiB7CiAgICAgICAgICBpZDogdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LmlkLAogICAgICAgICAgdXVpZDogdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LnV1aWQsCiAgICAgICAgICBuYW1lOiB2YWx1ZS5jYXRlZ29yeU5hbWUsCiAgICAgICAgICBkZXNjcmlwdGlvbjogdmFsdWUubWVzc2FnZUJveCwKICAgICAgICAgIGljb25Vcmw6IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5pY29uVXJsLAogICAgICAgICAgdGVuYW50VVVJRDogdGhpcy5jdXJyZW50VXNlckRldGFpbHMucHJvZmlsZS5vcmdhbml6YXRpb25JZCwKICAgICAgICAgIGluc3BlY3Rpb25UZW1wbGF0ZTogdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5Lmluc3BlY3Rpb25UZW1wbGF0ZSwKICAgICAgICAgIGFzc2V0czogdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LmFzc2V0cywKICAgICAgICAgIGZpZWxkVGVtcGxhdGU6IHsKICAgICAgICAgICAgaWQ6IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5maWVsZFRlbXBsYXRlLmlkLAogICAgICAgICAgICB1dWlkOiB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS51dWlkLAogICAgICAgICAgICB0eXBlOiB2YWx1ZS5jYXRlZ29yeU5hbWUgKyAiIGZpZWxkIHRlbXBsYXRlIiwKICAgICAgICAgICAgdGVuYW50VVVJRDogdGhpcy5jdXJyZW50VXNlckRldGFpbHMucHJvZmlsZS5vcmdhbml6YXRpb25JZCwKICAgICAgICAgICAgZmllbGRzOiBbXSwKICAgICAgICAgICAgcHJpdmF0ZTogdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LmZpZWxkVGVtcGxhdGUucHJpdmF0ZSwKICAgICAgICAgIH0sCiAgICAgICAgfSwKICAgICAgfTsKCiAgICAgIGxldCBmaWVsZHMgPSBbXTsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZhbHVlLmNhdGVnb3J5RmllbGRzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIGxldCBhZGRDYXRlZ29yeUZpZWxkID0gdmFsdWUuY2F0ZWdvcnlGaWVsZHNbaW5kZXhdOwogICAgICAgIGxldCBmaWVsZCA9IHt9OwogICAgICAgIGZpZWxkLmxhYmVsID0gYWRkQ2F0ZWdvcnlGaWVsZC5sYWJlbDsKICAgICAgICBmaWVsZC5maWVsZE1ldGFkYXRhID0gIiI7CiAgICAgICAgZmllbGQudHlwZSA9IGFkZENhdGVnb3J5RmllbGQudHlwZTsKICAgICAgICBmaWVsZC5maWVsZFBvc2l0aW9uID0gYWRkQ2F0ZWdvcnlGaWVsZC5wb3NpdGlvbjsKICAgICAgICBmaWVsZC5maWVsZFRlbXBsYXRlVVVJRCA9IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5maWVsZFRlbXBsYXRlLnV1aWQ7CiAgICAgICAgZmllbGQubWFuZGF0b3J5ID0gYWRkQ2F0ZWdvcnlGaWVsZC5tYW5kYXRvcnk7CiAgICAgICAgZmllbGQub3B0aW9ucyA9IGFkZENhdGVnb3J5RmllbGQub3B0aW9uczsKICAgICAgICBmaWVsZC5pY29uVXJsID0gIiI7CiAgICAgICAgZmllbGRzLnB1c2goZmllbGQpOwogICAgICB9CiAgICAgIGFkZENhdGVnb3J5LmNhdGVnb3J5LmZpZWxkVGVtcGxhdGUuZmllbGRzID0gZmllbGRzOwogICAgICAKICAgICAgCiAgICAgIC8vIGNvbnNvbGUubG9nKCdhZGRDYXRlZ29yeS1vbGQnLGFkZENhdGVnb3J5KQogICAgICAvLyBkZWJ1Z2dlcgogICAgICBBc3NldE1hbmFnZW1lbnRTZXJ2aWNlLmVkaXRDYXRlZ29yeShhZGRDYXRlZ29yeSkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNhdGVnb3J5UG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkNhdGVnb3J5IHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5IiwgInN1Y2Nlc3MiKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoZXJyb3IuZGF0YS5kZXNjcmlwdGlvbiwgImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAoKICAgIEVkaXRDYXRlZ29yeSgpIHsKICAgICAgaWYgKHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeSA9PSAiIikgewogICAgICAgIHRoaXMuc2hvd1RvYXN0KCJQbGVhc2UgU2VsZWN0IENhdGVnb3J5LiIsICJlcnJvciIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLmNhdGVnb3J5UG9wVXAgPSB0cnVlOwogICAgfSwKCiAgICBzZWxlY3RBc3NldENhdGUodmFsdWUpIHsKICAgICAgdGhpcy5kaXNhYmxlQWRkQnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5kaXNhYmxlRWRpdEJ1dHRvbiA9IGZhbHNlOwogICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZCA9IHZhbHVlOwogICAgICB0aGlzLiRyZWZzLmNhdGVnb3J5RmllbGRBY2NvcmRpb24ub3BlbkZsYWcgPSB0cnVlOwogICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkgPSB2YWx1ZS5zZWxlY3RlZE9iamVjdDsKICAgICAgICBpZiAodmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICBpZiAodmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHMgIT0gbnVsbCkgewogICAgICAgICAgICB2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkcy5zb3J0KChhLCBiKSA9PiB7CiAgICAgICAgICAgICAgcmV0dXJuIGEuZmllbGRQb3NpdGlvbiAtIGIuZmllbGRQb3NpdGlvbjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBjYXRlZ29yeUFzc2V0RmllbGRzID0gW107CiAgICAgICAgaWYgKHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUgIT0gbnVsbCkgewogICAgICAgICAgaWYgKHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzICE9IG51bGwpIHsKICAgICAgICAgICAgZm9yICgKICAgICAgICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgICAgICAgIGluZGV4IDwgdmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHMubGVuZ3RoOwogICAgICAgICAgICAgIGluZGV4KysKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgdmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdLnR5cGUgPT09ICJ0ZXh0IgogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gdmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdOwogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogImlucHV0IiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIiwKICAgICAgICAgICAgICAgICAgdmFsaWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgIHRvdWNoZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZC5tYW5kYXRvcnkpIHsKICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlGaWVsZC52YWxpZGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0ZWdvcnlBc3NldEZpZWxkcy5wdXNoKGNhdGVnb3J5RmllbGQpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICB2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0KICAgICAgICAgICAgICAgICJzZWxlY3QiCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSB2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvcHRpb24ubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7IGxhYmVsOiBvcHRpb25baW5kZXhdIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogInNlbGVjdCIsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRDb25maWc6IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAic2VsZWN0IiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLAogICAgICAgICAgICAgICAgICB2YWxpZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgdG91Y2hlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKGZpZWxkLm1hbmRhdG9yeSkgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlGaWVsZC52YWxpZGF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICAgIHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XS50eXBlID09PQogICAgICAgICAgICAgICAgIm51bWVyaWMiCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSB2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvcHRpb24ubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7IGxhYmVsOiBvcHRpb25baW5kZXhdIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogIm51bWVyaWMiLAogICAgICAgICAgICAgICAgICBlbGVtZW50Q29uZmlnOiB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogIm51bWVyaWMiLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogIiIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgdmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdLnR5cGUgPT09CiAgICAgICAgICAgICAgICAiYm9vbGVhbiIKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb24gPSBmaWVsZC5vcHRpb25zLnNwbGl0KCIsIik7CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9ucyA9IFtdOwogICAgICAgICAgICAgICAgb3B0aW9ucy5wdXNoKHsgbGFiZWw6IG9wdGlvblswXSB9KTsKICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7IGxhYmVsOiBvcHRpb25bMV0gfSk7CiAgICAgICAgICAgICAgICAvLyBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb3B0aW9uLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgLy8gICBvcHRpb25zLnB1c2goeyBsYWJlbDogb3B0aW9uW2luZGV4XSB9KTsKICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLAogICAgICAgICAgICAgICAgICB2YWxpZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgdG91Y2hlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKGZpZWxkLm1hbmRhdG9yeSkgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlGaWVsZC52YWxpZGF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICAgIHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XS50eXBlID09PQogICAgICAgICAgICAgICAgImNhbGVuZGVyIgogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gdmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGZpZWxkLm9wdGlvbnMuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb25zID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb3B0aW9uLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goeyBsYWJlbDogb3B0aW9uW2luZGV4XSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJjYWxlbmRlciIsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRDb25maWc6IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY2FsZW5kZXIiLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogIiIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNhdGVnb3J5QXNzZXRGaWVsZHMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGNhdGVnb3J5QXNzZXRGaWVsZHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHNbaW5kZXhdLmVsZW1lbnRDb25maWcubGFiZWwuaW5jbHVkZXMoCiAgICAgICAgICAgICAgICAgICAgIkRpbWVuc2lvbiIKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHNbaW5kZXhdLnZhbHVlID0gdGhpcy5kaW1lbnNpb25zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmNhdGVnb3J5RmllbGRzUmVzZXJ2ZSA9IGNhdGVnb3J5QXNzZXRGaWVsZHM7CiAgICAgICAgdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcyA9IGNhdGVnb3J5QXNzZXRGaWVsZHMuZmlsdGVyKAogICAgICAgICAgKGZpZWxkcykgPT4gZmllbGRzLmVsZW1lbnRDb25maWcubGFiZWwgIT09ICIjIG9mIFdhc2hlcyIKICAgICAgICApOwogICAgICB9CiAgICB9LAoKICAgIGNsZWFyU2VsZWN0ZWRBc3NldENhdGUoKSB7CiAgICAgIHRoaXMuY2F0ZWdvcnkgPSAiIjsKICAgICAgdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcyA9IFtdOwogICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZCA9IG51bGw7CiAgICAgIHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeSA9ICIiOwogICAgICB0aGlzLmNhdGVJbmRleCsrOwogICAgICB0aGlzLmRpc2FibGVBZGRCdXR0b24gPSBmYWxzZTsKICAgICAgdGhpcy5kaXNhYmxlRWRpdEJ1dHRvbiA9IHRydWU7CiAgICB9LAoKICAgIGFzc2V0SW5mb3JtYXRpb25BY2NvcmRpb25GdW5jdGlvbih2YWwpIHsKICAgICAgaWYgKHRoaXMuJHJlZnMuYXNzZXRJbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuJHJlZnMuY2F0ZWdvcnlGaWVsZEFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRXYXJyYW50eUFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMudXNhZ2VEZXNjcmlwdGlvbkluZm9ybWF0aW9uQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hdHRhY2hJbWFnZUFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRBc3NpZ25tZW50QWNjb3JkaW9uLm9wZW5GbGFnID09PSBmYWxzZTsKICAgICAgfQogICAgfSwKCiAgICBhc3NldEFzc2lnbm1lbnRBY2NvcmRpb25GdW5jdGlvbih2YWwpIHsKICAgICAgaWYgKHRoaXMuJHJlZnMuYXNzZXRBc3NpZ25tZW50QWNjb3JkaW9uLm9wZW5GbGFnID09PSB0cnVlKSB7CiAgICAgICAgdGhpcy4kcmVmcy5jYXRlZ29yeUZpZWxkQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hc3NldFdhcnJhbnR5QWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy51c2FnZURlc2NyaXB0aW9uSW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmF0dGFjaEltYWdlQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hc3NldEluZm9ybWF0aW9uQWNjb3JkaW9uLm9wZW5GbGFnID09PSBmYWxzZTsKICAgICAgfQogICAgfSwKCiAgICBjYXRlZ29yeUZpZWxkQWNjb3JkaW9uRnVuY3Rpb24odmFsKSB7CiAgICAgIGlmICh0aGlzLiRyZWZzLmNhdGVnb3J5RmllbGRBY2NvcmRpb24ub3BlbkZsYWcgPT09IHRydWUpIHsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0SW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0V2FycmFudHlBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLnVzYWdlRGVzY3JpcHRpb25JbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXR0YWNoSW1hZ2VBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0QXNzaWdubWVudEFjY29yZGlvbi5vcGVuRmxhZyA9PT0gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgYXNzZXRXYXJyYW50eUFjY29yZGlvbkZ1bmN0aW9uKHZhbCkgewogICAgICBpZiAodGhpcy4kcmVmcy5hc3NldFdhcnJhbnR5QWNjb3JkaW9uLm9wZW5GbGFnID09PSB0cnVlKSB7CiAgICAgICAgdGhpcy4kcmVmcy5jYXRlZ29yeUZpZWxkQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hc3NldEluZm9ybWF0aW9uQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy51c2FnZURlc2NyaXB0aW9uSW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmF0dGFjaEltYWdlQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgdXNhZ2VEZXNjcmlwdGlvbkluZm9ybWF0aW9uQWNjb3JkaW9uRnVuY3Rpb24odmFsKSB7CiAgICAgIGlmICh0aGlzLiRyZWZzLnVzYWdlRGVzY3JpcHRpb25JbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuJHJlZnMuY2F0ZWdvcnlGaWVsZEFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRXYXJyYW50eUFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRJbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXR0YWNoSW1hZ2VBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgfQogICAgfSwKCiAgICBhdHRhY2hJbWFnZUFjY29yZGlvbkZ1bmN0aW9uKHZhbCkgewogICAgICBpZiAodGhpcy4kcmVmcy5hdHRhY2hJbWFnZUFjY29yZGlvbi5vcGVuRmxhZyA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuJHJlZnMuY2F0ZWdvcnlGaWVsZEFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRXYXJyYW50eUFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRJbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMudXNhZ2VEZXNjcmlwdGlvbkluZm9ybWF0aW9uQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgaWYgKHRoaXMuaW1hZ2VWb2ljZXNDaGVjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLmdldEFzc2V0SW1hZ2VzKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGdldEFzc2V0SW1hZ2VzKCkgewogICAgICBBc3NldE1hbmFnZW1lbnRTZXJ2aWNlLmdldEFzc2V0SW1hZ2VzQnlVdWlkKHRoaXMuYXNzZXRJRCkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIHRoaXMuaW1hZ2VWb2ljZXMgPSByZXNwb25zZS5kYXRhLmFzc2V0SW1hZ2VzOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICJBbiBFcnJvciBPY2N1cnJlZCB3aGlsZSBnZXR0aW5nIEFzc2V0IEltYWdlcy4iLAogICAgICAgICAgICAiZXJyb3IiCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgfSwKCiAgICBidWlsZEltYWdlQXJyYXkoZmlsZSkgewogICAgICB0aGlzLm11bHRpcGFydEF0dGFjaG1lbnRzLnB1c2goewogICAgICAgIGZpbGVOYW1lOiBmaWxlLm5hbWUsCiAgICAgICAgZmlsZTogZmlsZSwKICAgICAgICB0eXBlOiBmaWxlLm5hbWUsCiAgICAgIH0pOwogICAgfSwKCiAgICBoYW5kbGVJbWFnZUZpbGUodmFsdWUpIHsKICAgICAgdGhpcy5pbWFnZVBhdGggPSBbXTsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgdGhpcy5idWlsZEltYWdlQXJyYXkodmFsdWUpOwogICAgICAgIHZhciBleHRWaWRlbyA9IHRoaXMudmFsdWUubmFtZS5zcGxpdCgiLiIpLnBvcCgpOwogICAgICAgIGlmIChleHRWaWRlbyA9PT0gIm1wNCIgfHwgZXh0VmlkZW8gPT09ICJ3ZWJtIikgewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIlZpZGVvIHVwbG9hZCBub3Qgc3VwcG9ydGVkLiIsICJ3YXJuaW5nIik7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS51cGxvYWRGaWxlVG9zMyh0aGlzLnZhbHVlKQogICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZUlkZW50aWZpZXIgPT09ICJTdWNjZXNzIikgewogICAgICAgICAgICAgICAgdmFyIGV4dCA9IHJlc3BvbnNlLmRhdGEuZmlsZU5hbWUuc3BsaXQoIi4iKS5wb3AoKTsKICAgICAgICAgICAgICAgIGlmIChleHQgPT09ICJqcGVnIiB8fCBleHQgPT09ICJwbmciIHx8IGV4dCA9PT0gImpwZyIpIHsKICAgICAgICAgICAgICAgICAgbGV0IG9iaiA9IHt9OwogICAgICAgICAgICAgICAgICAob2JqLmlkID0gdGhpcy5hc3NldE9iai5pZCksCiAgICAgICAgICAgICAgICAgICAgKG9iai5hc3NldFVVSUQgPSB0aGlzLmFzc2V0SUQpLAogICAgICAgICAgICAgICAgICAgIChvYmouaW1hZ2VVcmwgPSByZXNwb25zZS5kYXRhLmZpbGVVcmwpOwogICAgICAgICAgICAgICAgICBvYmouaW1hZ2VGbGFnID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhpcy5pbWFnZVBhdGgucHVzaChvYmopOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICJwZGYiKSB7CiAgICAgICAgICAgICAgICAgIGxldCBvYmogPSB7fTsKICAgICAgICAgICAgICAgICAgKG9iai5pZCA9IHRoaXMuYXNzZXRPYmouaWQpLAogICAgICAgICAgICAgICAgICAgIChvYmouYXNzZXRVVUlEID0gdGhpcy5hc3NldElEKSwKICAgICAgICAgICAgICAgICAgICAob2JqLmNvbnRlbnRVcmwgPSByZXNwb25zZS5kYXRhLmZpbGVVcmwpOwogICAgICAgICAgICAgICAgICBvYmouZmlsZU5hbWUgPSByZXNwb25zZS5kYXRhLmZpbGVOYW1lOwogICAgICAgICAgICAgICAgICB0aGlzLmRvY1BhdGgucHVzaChvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICAgICAgIGV4dCA9PT0gImpwZWciIHx8IGV4dCA9PT0gInBuZyIgfHwgZXh0ID09PSAianBnIgogICAgICAgICAgICAgICAgICA/ICJJbWFnZSBhZGRlZCBTdWNjZXNzZnVsbHkuIgogICAgICAgICAgICAgICAgICA6ICJEb2N1bWVudCBhZGRlZCBTdWNjZXNzZnVsbHkuIiwKICAgICAgICAgICAgICAgICJzdWNjZXNzIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgYWRkaW5nIEltYWdlIG9yIGZpbGUiLAogICAgICAgICAgICAgICAgICAiZXJyb3IiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgZ2V0Rm9ybUVycm9yTWVzc2FnZShmaWVsZFZhbGlkYXRpb24pIHsKICAgICAgaWYgKGZpZWxkVmFsaWRhdGlvbi4kZGlydHkpIHsKICAgICAgICByZXR1cm4gRnVuY3Rpb25zLmdldEZvcm1GaWVsZEVycm9yTWVzc2FnZShmaWVsZFZhbGlkYXRpb24pOwogICAgICB9CiAgICB9LAoKICAgIGdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCkgewogICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQodGhpcy5hc3NldElEKQogICAgICAgIC50aGVuKChyZXNwb25zZTEpID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZTEuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlMS5kYXRhLmRldGFpbHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHRoaXMudXNlckFzc2lnbmVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IHVzZXJzID0gW107CiAgICAgICAgICAgIGZvciAoCiAgICAgICAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICAgICAgICBpbmRleCA8IHJlc3BvbnNlMS5kYXRhLmRldGFpbHMubGVuZ3RoOwogICAgICAgICAgICAgIGluZGV4KysKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgbGV0IG9iaiA9IHt9OwogICAgICAgICAgICAgIG9iai5uYW1lID0gcmVzcG9uc2UxLmRhdGEuZGV0YWlsc1tpbmRleF0ubmFtZTsKICAgICAgICAgICAgICBvYmouY291bnQgPSByZXNwb25zZTEuZGF0YS5kZXRhaWxzW2luZGV4XS5jb3VudDsKICAgICAgICAgICAgICBvYmouc3RhdHVzID0gcmVzcG9uc2UxLmRhdGEuZGV0YWlsc1tpbmRleF0uc3RhdHVzOwogICAgICAgICAgICAgIG9iai5zdGFydERhdGUgPSBtb21lbnQoCiAgICAgICAgICAgICAgICByZXNwb25zZTEuZGF0YS5kZXRhaWxzW2luZGV4XS5zdGFydERhdGUKICAgICAgICAgICAgICApLmZvcm1hdCgiREQgTU1NIFlZWVkgaGg6bW0gYSIpOwogICAgICAgICAgICAgIG9iai51dWlkID0gcmVzcG9uc2UxLmRhdGEuZGV0YWlsc1tpbmRleF0udXVpZDsKICAgICAgICAgICAgICBvYmoudXNlckVuZGluZ0RhdGVzID0KICAgICAgICAgICAgICAgIHJlc3BvbnNlMS5kYXRhLmRldGFpbHNbaW5kZXhdLnVzZXJFbmRpbmdEYXRlczsKICAgICAgICAgICAgICBvYmouYXNzaWdubWVudElkID0gcmVzcG9uc2UxLmRhdGEuZGV0YWlsc1tpbmRleF0uYXNzaWdubWVudElkOwogICAgICAgICAgICAgIHVzZXJzLnB1c2gob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFzc2lnbmVkVXNlcnMgPSB1c2VyczsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwNikgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiQW4gdW5leHBlY3RlZCBFcnJvciBPY2N1cnJlZCIsICJlcnJvciIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkFuIHVuZXhwZWN0ZWQgRXJyb3IgT2NjdXJyZWQiLCAiZXJyb3IiKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgogICAgdGl0bGVGdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuYXNzZXRJRCA9PSB1bmRlZmluZWQpIHsKICAgICAgICBkb2N1bWVudC50aXRsZSA9IHRoaXMuJHJvdXRlLm1ldGEudGl0bGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9jdW1lbnQudGl0bGUgPSAiRXJvaGFsIC0gRWRpdCBBc3NldCI7CiAgICAgIH0KICAgIH0sCgogICAgZ2V0TWFpbnRhaW5hbmNlQ29zdChhc3NldElkKSB7CiAgICAgIHsKICAgICAgICBXb3JrT3JkZXJTZXJ2aWNlLmdldEFzc2V0TWFpbnRlbmFuY2VDb3N0QnlBc3NldFVVSUQoYXNzZXRJZCkKICAgICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgICAgdGhpcy5jb3N0ID0gcmVzLmRhdGEubWFpbnRlbmFuY2VDb3N0OwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiQW4gdW5leHBlY3RlZCBFcnJvciBPY2N1cnJlZCIsICJlcnJvciIpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgc2hvd1RvYXN0KG1lc3NhZ2UsIHR5cGUpIHsKICAgICAgdGhpcy50b2FzdE1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICB0aGlzLnRvYXN0VHlwZSA9IHR5cGU7CiAgICAgIHRoaXMudG9hc3RGbGFnKys7CiAgICB9LAogIH0sCgogIGNyZWF0ZWQoKSB7CgogICAgdGhpcy5hc3NldElEID0gdGhpcy4kcm91dGUucGFyYW1zLmFzc2V0SUQ7CiAgICAKCiAgICB0aGlzLnRpdGxlRnVuY3Rpb24oKTsKICAgIHRoaXMuZ2V0Q3VycmVuY3koKTsKICAgIHRoaXMuY3VycmVudFVzZXJEZXRhaWxzID0gSlNPTi5wYXJzZSgKICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oImN1cnJlbnRVc2VyRGV0YWlscyIpCiAgICApOwogICAgdGhpcy5zZWxlY3RVc2VyKCk7CgogICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS5nZXRBbGxBc3NldENhdGVnb3JpZXMoCiAgICAgIHRoaXMuY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQKICAgICkudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgcmVzcG9uc2UuZGF0YS5jYXRlZ29yaWVzLnNvcnQoKGNhdGVnb3J5MSwgY2F0ZWdvcnkyKSA9PiB7CiAgICAgICAgbGV0IHZhbHVlID0gMDsgLy8gbm8gY2hhbmdlCiAgICAgICAgaWYgKGNhdGVnb3J5MS5uYW1lIDwgY2F0ZWdvcnkyLm5hbWUpIHsKICAgICAgICAgIHZhbHVlID0gLTE7IC8vIDIgYmVmb3JlIDEKICAgICAgICB9IGVsc2UgaWYgKGNhdGVnb3J5Mi5uYW1lIDwgY2F0ZWdvcnkxLm5hbWUpIHsKICAgICAgICAgIHZhbHVlID0gMTsgLy8gMSBiZWZvcmUgMgogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0pOwogICAgICB0aGlzLkFzc2V0Q2F0ZWdvcnkgPSByZXNwb25zZS5kYXRhLmNhdGVnb3JpZXM7CiAgICAgIGlmICh0aGlzLmFzc2V0SUQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuZ2V0QXNzZXREZXRhaWxzKCk7CiAgICAgICAgdGhpcy5nZXRNYWludGFpbmFuY2VDb3N0KHRoaXMuYXNzZXRJRCk7CiAgICAgICAgdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICB9CgoKICAgaWYgKHRoaXMuJHJvdXRlLm5hbWUgPT0gJ2NyZWF0ZS1hc3NldC1ieS1jYXRlZ29yeScpewogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiQWRkQnlDYXRlRmxhZyIsdGhpcy4kcm91dGUucGFyYW1zLkFkZEJ5Q2F0ZUZsYWcpOwogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiYXNzZXRDYXRlSUQiLHRoaXMuJHJvdXRlLnBhcmFtcy5hc3NldENhdGVJRCk7CiAgICAgIHRoaXMuQWRkQnlDYXRlRmxhZyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJBZGRCeUNhdGVGbGFnIik7CiAgICAgIHRoaXMuYXNzZXRDYXRlSUQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiYXNzZXRDYXRlSUQiKTsKCiAgICAgIGlmKHRoaXMuQWRkQnlDYXRlRmxhZyl7CiAgICAgIGlmICh0aGlzLmFzc2V0Q2F0ZUlEICE9PSAiIikgewogICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuQXNzZXRDYXRlZ29yeS5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgaWYgKHRoaXMuYXNzZXRDYXRlSUQgPT09IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF0udXVpZCkgewogICAgICAgICAgICAgIHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeSA9IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF07CiAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQgPSB0aGlzLkFzc2V0Q2F0ZWdvcnlbaW5kZXhdOwogICAgICAgICAgICAgIHRoaXMuY2F0ZWdvcnkgPSB0aGlzLkFzc2V0Q2F0ZWdvcnlbaW5kZXhdLm5hbWU7CiAgICAgICAgICAgICAgdGhpcy5jYXRlSW5kZXgrKzsKICAgICAgICAgICAgICB0aGlzLmRpc2FibGVBZGRCdXR0b24gPSB0cnVlOwogICAgICAgICAgICAgIHRoaXMuZGlzYWJsZUVkaXRCdXR0b24gPSBmYWxzZTsKICAgICAgICAgICAgICBsZXQgb2JqID0gewogICAgICAgICAgICAgICAgImRpc3BsYXkiOnRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF0ubmFtZSwKICAgICAgICAgICAgICAgICJzZWxlY3RlZE9iamVjdCI6dGhpcy5Bc3NldENhdGVnb3J5W2luZGV4XSwKICAgICAgICAgICAgICAgICJ2YWx1ZSI6dGhpcy5Bc3NldENhdGVnb3J5W2luZGV4XS51dWlkCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZShvYmopCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICB9CiAgICAgfQogICAgfSk7CiAgfSwKCiAgdmFsaWRhdGlvbnM6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB7CiAgICAgIGN1c3RvbUNhdGVnb3J5RmllbGRzOiB7CiAgICAgICAgJGVhY2g6IHsKICAgICAgICAgIHZhbHVlOiB7IHJlcXVpcmVkIH0sCiAgICAgICAgfSwKICAgICAgfSwKICAgICAgYXNzZXRPYmo6IHsKICAgICAgICBuYW1lOiB7IHJlcXVpcmVkLCBtYXhMZW5ndGg6IG1heExlbmd0aCgxOTApIH0sCiAgICAgICAgbW9kZWxOdW1iZXI6IHsgcmVxdWlyZWQsIG1heExlbmd0aDogbWF4TGVuZ3RoKDE5MCkgfSwKICAgICAgICBtYW51ZmFjdHVyZTogeyByZXF1aXJlZCwgbWF4TGVuZ3RoOiBtYXhMZW5ndGgoMTkwKSB9LAogICAgICAgIHdhcnJhbnR5OiB7IG1heExlbmd0aDogbWF4TGVuZ3RoKDE5MCkgfSwKICAgICAgICB3YXJyYW50eVVuaXQ6IHsgcmVxdWlyZWQgfSwKICAgICAgICBjb25zdW1wdGlvblVuaXQ6IHsgcmVxdWlyZWQsIG1heExlbmd0aDogbWF4TGVuZ3RoKDE5MCkgfSwKICAgICAgICBwcmltYXJ5VXNhZ2VVbml0OiB7IHJlcXVpcmVkLCBtYXhMZW5ndGg6IG1heExlbmd0aCgxOTApIH0sCiAgICAgICAgc2Vjb25kYXJ5VXNhZ2VVbml0OiB7IHJlcXVpcmVkLCBtYXhMZW5ndGg6IG1heExlbmd0aCgxOTApIH0sCiAgICAgICAgLy8gcXVhbnRpdHk6IHsgcmVxdWlyZWQgfSwKICAgICAgICAvLyBpbnZlbnRvcnk6IHsgcmVxdWlyZWQgfSwKICAgICAgfSwKICAgICAgY2F0ZWdvcnk6IHsgcmVxdWlyZWQgfSwKICAgICAgZGVzY3JpcHRpb246IHsgcmVxdWlyZWQsIG1heExlbmd0aDogbWF4TGVuZ3RoKDUwMCkgfSwKICAgIH07CiAgfSwKCiAgY29tcHV0ZWQ6IHt9LAp9Owo="},null]}