{"remainingRequest":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/src/views/calendar/Scheduler.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/src/views/calendar/Scheduler.vue","mtime":1661968702432},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/cache-loader/dist/cjs.js","mtime":1662622637759},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/babel-loader/lib/index.js","mtime":1662622637719},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/cache-loader/dist/cjs.js","mtime":1662622637759},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/vue-loader/lib/index.js","mtime":1662622639723}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCB7CiAgU2NoZWR1bGVQbHVnaW4sCiAgRGF5LAogIFdlZWssCiAgV29ya1dlZWssCiAgTW9udGgsCiAgQWdlbmRhLAogIFJlc2l6ZSwKRHJhZ0FuZERyb3AKfSBmcm9tICJAc3luY2Z1c2lvbi9lajItdnVlLXNjaGVkdWxlIjsKaW1wb3J0IGxvYWRlciBmcm9tICJAL2NvbXBvbmVudHMvTG9hZGVyLnZ1ZSI7CmltcG9ydCBpbnNwZWN0aW9uU2VydmljZSBmcm9tICIuLi8uLi9zZXJ2aWNlcy9JbnNwZWN0aW9uU2VydmljZSI7CmltcG9ydCBHSW5zcGVjdGlvblRlbXBsYXRlcyBmcm9tICIuLi8uLi9jb21wb25lbnRzL0dfSW5zcGVjdGlvblRlbXBsYXRlLnZ1ZSI7CmltcG9ydCBJbnNwZWN0aW9uQXNzaWdubWVudCBmcm9tICIuLi9jYWxlbmRhci9jb21wb25lbnRzL0luc3BlY3Rpb25Bc3NpZ25tZW50LnZ1ZSI7CmltcG9ydCBTZXJ2aWNlUmVxdWVzdEFzc2lnbm1lbnQgZnJvbSAiLi4vY2FsZW5kYXIvY29tcG9uZW50cy9TZXJ2aWNlUmVxdWVzdEFzc2lnbm1lbnQudnVlIjsKaW1wb3J0IElzc3VlQXNzaWdubWVudCBmcm9tICIuLi9jYWxlbmRhci9jb21wb25lbnRzL0lzc3VlQXNzaWdubWVudC52dWUiOwppbXBvcnQgQXNzZXRBc3NpZ25tZW50VW5Bc3NpZ25tZW50IGZyb20gIi4vY29tcG9uZW50cy9Bc3NldEFzc2lnbm1lbnRVbkFzc2lnbm1lbnQudnVlIjsKaW1wb3J0IFdvcmtPcmRlckFzc2lnbm1lbnQgZnJvbSAiLi4vY2FsZW5kYXIvY29tcG9uZW50cy9Xb3JrT3JkZXJBc3NpZ25tZW50LnZ1ZSI7CmltcG9ydCBBc3NpZ25Vc2VyUG9wVXAgZnJvbSAiLi4vY2FsZW5kYXIvY29tcG9uZW50cy9Bc3NpZ25Vc2VyUG9wVXAudnVlIjsKaW1wb3J0IFVuQXNzaWduVXNlclBvcFVwIGZyb20gIi4uL2NhbGVuZGFyL2NvbXBvbmVudHMvVW5Bc3NpZ25Vc2VyUG9wVXAudnVlIjsKLy8gaW1wb3J0IHsgc2NoZWR1bGVEYXRhIH0gZnJvbSAnLi9kYXRhc291cmNlJzsgLy8gb25seSBmb3IgdGVzdGluZwovLyBTY2hlZHVsZXIgQXBpCmltcG9ydCBzY2hlZHVsZXJTZXJ2aWNlIGZyb20gIi4uLy4uL3NlcnZpY2VzL3NjaGVkdWxlclNlcnZpY2UiOwovLwppbXBvcnQgSW5zcGVjdGlvblNlcnZpY2UgZnJvbSAiLi4vLi4vc2VydmljZXMvSW5zcGVjdGlvblNlcnZpY2UiOwppbXBvcnQgV29ya09yZGVyU2VydmljZSBmcm9tICIuLi8uLi9zZXJ2aWNlcy9Xb3JrT3JkZXJTZXJ2aWNlIjsKaW1wb3J0IEFzc2V0UGVyc29ubmVsU2VydmljZSBmcm9tICIuLi8uLi9zZXJ2aWNlcy9Bc3NldFBlcnNvbm5lbFNlcnZpY2UiOwppbXBvcnQgU2lkZUJhckZpbHRlciBmcm9tICIuLi9jYWxlbmRhci9jb21wb25lbnRzL1NpZGVCYXJGaWx0ZXIudnVlIjsKaW1wb3J0IERlbGV0ZURpYWxvZyBmcm9tICIuLi8uLi9jb21wb25lbnRzL0RlbGV0ZURpYWxvZyI7CmltcG9ydCBtb21lbnQgZnJvbSAibW9tZW50IjsKdmFyIHNjaGVkdWxlRGF0YSA9IFtdOwoKZXhwb3J0IGRlZmF1bHQgewogIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBoZWlnaHQ6ICI1NTBweCIsCiAgICAgIGV2ZW50U2V0dGluZ3M6IHsKICAgICAgICBkYXRhU291cmNlOiBzY2hlZHVsZURhdGEsCiAgICAgIH0sCiAgICAgIFVzZXJzOiBbXSwKICAgICAgYWxsVXNlcnM6IFtdLAogICAgICBTaG93UG9wVXA6IGZhbHNlLAogICAgICBTaG93VW5Qb3BVcDogZmFsc2UsCiAgICAgIGFzc2lnbmVkVXNlcnM6IFtdLAogICAgICB2YWx1ZUVkaXRBc3NpZ246IHt9LAogICAgICBhc3NpZ25tZW50SGlzdG9yeVVzZXJzOiBbXSwKICAgICAgcGFnZTogMCwKICAgICAgcm93c1BlclBhZ2U6IDUsCiAgICAgIGN1cnJlbnRVc2VyRGV0YWlsczogbnVsbCwKICAgICAga2V5SW5kZXg6IDAsCiAgICAgIGZpbHRlckluZGV4OiAwLAogICAgICBzY2hlZHVsZUtleTogMCwKICAgICAgaW5kZXg6IDAsCiAgICAgIHdvcmtIb3VyczogeyBoaWdobGlnaHQ6IHRydWUsIHN0YXJ0OiAiMDg6MDAiLCBlbmQ6ICIxNjowMCIgfSwKICAgICAgc2VsZWN0ZWREYXRlOiBuZXcgRGF0ZSgpLAogICAgICBFdmVudERpYWxvZzogZmFsc2UsCiAgICAgIGV2ZW50VGFiczogImluc3BlY3Rpb24iLAogICAgICBhc3NldFV1aWQ6ICIiLAogICAgICBldmVudFRhYnNPcHRpb25zOiBbCiAgICAgICAgewogICAgICAgICAgbGFiZWw6ICJJbnNwZWN0aW9uIiwKICAgICAgICAgIHZhbHVlOiAiaW5zcGVjdGlvbiIsCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBsYWJlbDogIldvcmsgT3JkZXIiLAogICAgICAgICAgdmFsdWU6ICJ3b3JrT3JkZXIiLAogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgbGFiZWw6ICJBc3NpZ25tZW50IiwKICAgICAgICAgIHZhbHVlOiAiYXNzaWdubWVudCIsCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBsYWJlbDogIlJlcG9ydCBJc3N1ZSIsCiAgICAgICAgICB2YWx1ZTogImlzc3VlcyIsCiAgICAgICAgICBpZDogImdqaGdqIiwKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgIGxhYmVsOiAiU2VydmljZSBSZXF1ZXN0IiwKICAgICAgICAgIHZhbHVlOiAic3JSZXF1ZXN0IiwKICAgICAgICB9LAogICAgICBdLAogICAgICBDYXRlZ29yeU9wdGlvbjogW10sCiAgICAgIHNlYXJjaE1vZGVsOiAiIiwKICAgICAgQ2F0ZWdvcnlWYWx1ZTogIiIsCiAgICAgIHRlbXBPYmo6IHt9LAogICAgICBsb2FkZXJGbGFnOiBmYWxzZSwKICAgICAgdG9hc3RGbGFnOiBmYWxzZSwKICAgICAgdG9hc3RNZXNzYWdlOiAiIiwKICAgICAgdG9hc3RUeXBlOiAiIiwKICAgICAgY2FsZW5kZXJEYXRlT2JqOiAiIiwKICAgICAgc3VibWl0dGVkYnlVc2VyVVVJRDogIiIsCiAgICAgIGlzc3VlQ2F0ZWdvcnk6ICIiLAogICAgICBlZGl0RmxhZzogZmFsc2UsCiAgICAgIGlzc3VlSUQ6ICIiLAogICAgICBzZXJ2aWNlUmVxdWVzdFVVSUQ6ICIiLAogICAgICB0ZW1wU2NoZWR1bGVOYW1lOiAiIiwKICAgICAgZmxhZzogZmFsc2UsCiAgICAgIHNjaGVkdWxlck5hbWU6ICJzY2hlZHVsZXIiLAogICAgICBFZGl0U2NoZVRlbmFudFVVSWQ6ICIiLAogICAgICBFZGl0U2NoZUlkOiAiIiwKICAgICAgZGVsZXRlSWQ6ICIiLAogICAgICBkZWxldGVJbnNwZWN0aW9uRGlhbG9nOiBmYWxzZSwKICAgICAgYXJjaGl2ZUluc3BlY3Rpb25EaWFsb2c6IGZhbHNlLAogICAgICBzY2hlZHVsZXJTdGFydFRpbWU6ICIiLAogICAgICBzY2hlZHVsZXJFbmRUaW1lOiAiIiwKICAgIH07CiAgfSwKICBwcm92aWRlOiB7CiAgICBzY2hlZHVsZTogW0RheSwgV2VlaywgV29ya1dlZWssIE1vbnRoLCBBZ2VuZGEsIFJlc2l6ZSwgRHJhZ0FuZERyb3BdLAogIH0sCiAgY29tcG9uZW50czogewogICAgR0luc3BlY3Rpb25UZW1wbGF0ZXMsCiAgICBJbnNwZWN0aW9uQXNzaWdubWVudCwKICAgIGxvYWRlciwKICAgIFdvcmtPcmRlckFzc2lnbm1lbnQsCiAgICBTZXJ2aWNlUmVxdWVzdEFzc2lnbm1lbnQsCiAgICBJc3N1ZUFzc2lnbm1lbnQsCiAgICBBc3NldEFzc2lnbm1lbnRVbkFzc2lnbm1lbnQsCiAgICBBc3NpZ25Vc2VyUG9wVXAsCiAgICBVbkFzc2lnblVzZXJQb3BVcCwKICAgIFNpZGVCYXJGaWx0ZXIsCiAgICBEZWxldGVEaWFsb2csCiAgfSwKICBtZXRob2RzOiB7CiAgICBnZXREYXRlTmF2aWdhdGUoKXsKICAgIHZhciBzY2hlZHVsZU9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJTY2hlZHVsZSIpLmVqMl9pbnN0YW5jZXNbMF07CiAgICB2YXIgc2VsRGF0ZSA9IHNjaGVkdWxlT2JqLnNlbGVjdGVkRGF0ZTsKICAgIHZhciBjdXJyZW50Vmlld0RhdGVzID0gc2NoZWR1bGVPYmouZ2V0Q3VycmVudFZpZXdEYXRlcygpOwogICAgdmFyIHN0YXJ0RGF0ZSA9IGN1cnJlbnRWaWV3RGF0ZXNbMF07CiAgICB2YXIgZW5kRGF0ZSA9IGN1cnJlbnRWaWV3RGF0ZXNbY3VycmVudFZpZXdEYXRlcy5sZW5ndGggLSAxXTsKICAgIHRoaXMuc2NoZWR1bGVTdGFydFRpbWUgPSBlbmREYXRlLCAKICAgIHRoaXMuc2NoZWR1bGVyRW5kVGltZSA9IHN0YXJ0RGF0ZQogICAgfSwKICAgIGNsb3NlRGlhbG9nKCkgewogICAgICAgIHRoaXMuZGVsZXRlSW5zcGVjdGlvbkRpYWxvZyA9IGZhbHNlOwogICAgICAgIHRoaXMuYXJjaGl2ZUluc3BlY3Rpb25EaWFsb2cgPSBmYWxzZTsKICAgIH0sCiAgICBkZWxldGVEaWFsb2coKSB7CiAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgICB0aGlzLmRlbGV0ZUluc3BlY3Rpb25EaWFsb2cgPSB0cnVlOwogICAgICAgIGluc3BlY3Rpb25TZXJ2aWNlCiAgICAgICAgICAuZGVsZXRlSW5zcGVjdGlvblRlbXBsYXRlQnlVVUlEKHRoaXMuZGVsZXRlSWQsICJkZWxldGUiKQogICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgICAgICAgdGhpcy4kZW1pdCgKICAgICAgICAgICAgICAgICJzaG93VG9hc3QiLAogICAgICAgICAgICAgICAgIlBlbmRpbmcgSW5zcGVjdGlvbiBEZWxldGVkIFN1Y2Nlc3NmdWxseSIsCiAgICAgICAgICAgICAgICAic3VjY2VzcyIKICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICBsZXQgc2NoZWR1bGVPYmogPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiU2NoZWR1bGUiKS5lajJfaW5zdGFuY2VzWzBdOyAKICAgICAgICAgICAgICB2YXIgbGlzdCA9IHNjaGVkdWxlT2JqLmV2ZW50U2V0dGluZ3MuZGF0YVNvdXJjZSAKICAgICAgICAgICAgICB2YXIgbGlzdHMgPSBsaXN0LmZpbHRlcih4ID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiB4LmlkICE9IHRoaXMuZGVsZXRlSWQ7CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICBzY2hlZHVsZU9iai5ldmVudFNldHRpbmdzLmRhdGFTb3VyY2UgPSBbe31dCiAgICAgICAgICAgICAgc2NoZWR1bGVPYmouZXZlbnRTZXR0aW5ncy5kYXRhU291cmNlID0gbGlzdHMKICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICB0aGlzLmRlbGV0ZUluc3BlY3Rpb25EaWFsb2cgPSBmYWxzZTsKICAgICAgICAgICAgICAvLyB0aGlzLkdldFNjaGVkdWxlclRpY2tldHMoKTsKICAgICAgICAgICAgICAvLyB0aGlzLnNjaGVkdWxlclN0YXJ0VGltZSA9ICIiOwogICAgICAgICAgICAgIC8vIHRoaXMuc2NoZWR1bGVyRW5kVGltZSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2UgIT09IHVuZGVmaW5lZCAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwNikgewogICAgICAgICAgICAgIHRoaXMuJGVtaXQoInNob3dUb2FzdCIsIGVycm9yLnJlc3BvbnNlLmRhdGEuZGVzY3JpcHRpb24sICJlcnJvciIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuJGVtaXQoInNob3dUb2FzdCIsICJBbiB1bmV4cGVjdGVkIEVycm9yIE9jY3VycmVkLiIsICJlcnJvciIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgIAogICAgfSwKCiAgICBhZGRFdmVudDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHRoaXMua2V5SW5kZXgrKzsKICAgICAgdGhpcy5FdmVudERpYWxvZyA9IHRydWU7CiAgICB9LAogICAgZGVsZXRlRXZlbnQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB0aGlzLmtleUluZGV4Kys7CiAgICB9LAogICAgb25DZWxsQ2xpY2s6IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIC8vCiAgICAgIGFyZ3MuY2FuY2VsID0gdHJ1ZTsKICAgICAgdGhpcy5jYWxlbmRlckRhdGVPYmogPSBhcmdzOwogICAgICB0aGlzLmtleUluZGV4Kys7CiAgICAgIHRoaXMuRXZlbnREaWFsb2cgPSB0cnVlOwogICAgICAvLyBEYXRlCiAgICAgIHRoaXMuc2NoZWR1bGVyU3RhcnRUaW1lID0gYXJncy5zdGFydFRpbWU7CiAgICAgIGxldCBudW1XZWVrcyA9IDI7CiAgICAgIGxldCBub3cgPSBhcmdzLmVuZFRpbWU7CiAgICAgIG5vdy5zZXREYXRlKG5vdy5nZXREYXRlKCkgKyBudW1XZWVrcyAqIDcpOwogICAgICB0aGlzLnNjaGVkdWxlckVuZFRpbWUgPSBub3c7CiAgICB9LAogICAgb25ldmVudFJlbmRlcmVkOiBmdW5jdGlvbiAoYXJncykgewogICAgICAvLwljb25zb2xlLmxvZygib24gZXZlbnQgcmVuZGVyIiwgIGFyZ3MuZGF0YS5DYXRlZ29yeUNvbG9yKTsKICAgICAgbGV0IGNhdGVnb3J5Q29sb3IgPSBhcmdzLmRhdGEuQ2F0ZWdvcnlDb2xvcjsKICAgICAgaWYgKCFhcmdzLmVsZW1lbnQgfHwgIWNhdGVnb3J5Q29sb3IpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgYXJncy5lbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNhdGVnb3J5Q29sb3I7CiAgICB9LAogICAgb25TYXZlOiBmdW5jdGlvbiAoYXJncykgewogICAgICBsZXQgc2NoZWR1bGVPYmogPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiU2NoZWR1bGUiKS5lajJfaW5zdGFuY2VzWzBdOwogICAgICAvLwljb25zb2xlLmxvZyhzY2hlZHVsZU9iaik7CiAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoKTsKICAgICAgdmFyIHN1Yk9uZUhvdXIgPSBtb21lbnQoZGF0ZSkuc3VidHJhY3QoMSwgImgiKS5mb3JtYXQoKTsKICAgICAgbGV0IGV2ZW50RGF0YSA9IHsKICAgICAgICAvLwlJZDogaW5kZXgsCiAgICAgICAgU3ViamVjdDogIiIsCiAgICAgICAgU3RhcnRUaW1lOiBuZXcgRGF0ZShzdWJPbmVIb3VyKSwKICAgICAgICBFbmRUaW1lOiBuZXcgRGF0ZSgpLAogICAgICAgIElzQWxsRGF5OiBmYWxzZSwKICAgICAgICBjYXJkVHlwZTogIlNlcnZpY2UgUmVxdWVzdCIsCiAgICAgICAgaXNzdWVJZDogImMwNjI5NWMxLTAzNTUtNGE0ZC04YjhkLTM1NDNmN2Y1MGE5NSIsCiAgICAgICAgc3JJZDogImMwNjI5NWMxLTAzNTUtNGE0ZC04YjhkLTM1NDNmN2Y1MGE5NSIsCiAgICAgICAgLy8gU3RhcnRUaW1lem9uZTogbnVsbCwKICAgICAgICAvLyBEZXNjcmlwdGlvbjogInVuZGVmaW5lZCIsCiAgICAgICAgLy8gRW5kVGltZXpvbmU6IG51bGwsCiAgICAgICAgLy8gR3VpZDogIjhiNTM3MGEyLTljZmEtYjk1Ny0wYjVmLTFlODZiOTRhYmViYiIsCiAgICAgICAgSWQ6IDEsCiAgICAgICAgLy8gTG9jYXRpb246ICJ1bmRlZmluZWQiLAogICAgICAgIC8vIFJlY3VycmVuY2VSdWxlOiBudWxsLAogICAgICB9OwogICAgICBjb25zb2xlLmxvZygic2F2ZSIsIGV2ZW50RGF0YSk7CiAgICAgIHNjaGVkdWxlT2JqLmFkZEV2ZW50KGV2ZW50RGF0YSk7CiAgICAgIGNvbnNvbGUubG9nKCJzY2hlZHVsZURhdGEiLCBzY2hlZHVsZURhdGEpOwogICAgICAvL2RvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIi5lLXNjaGVkdWxlIC5lLXZlcnRpY2FsLXZpZXcgLmUtZGF5LXdyYXBwZXIgLmUtYXBwb2ludG1lbnQuZS1saWIuZS1kcmFnZ2FibGUiKS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAiZ3JlZW4iOwogICAgfSwKICAgIG9uQWN0aW9uQmVnaW46IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIC8vIGNvbnNvbGUubG9nKCJvbkFjdGlvbkJlZ2luIixhcmdzKQogICAgICBpZiAoYXJncy5yZXF1ZXN0VHlwZSA9PT0gImV2ZW50UmVtb3ZlIikgewogICAgICAgIHZhciBjaGFuZ2VkUmVjb3JkcyA9IGFyZ3MuY2hhbmdlZFJlY29yZHMKICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY2hhbmdlZFJlY29yZHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgIHZhciByZWNvcmRJZCA9IGNoYW5nZWRSZWNvcmRzW2luZGV4XS5pZCAKICAgICAgICB9CiAgICAgICAgYXJncy5jYW5jZWwgPSB0cnVlOwogICAgICAgIHRoaXMuZGVsZXRlSW5zcGVjdGlvbkRpYWxvZyA9IHRydWU7CiAgICAgICAgdGhpcy5kZWxldGVJZCA9IHJlY29yZElkOwoKICAgICAgICAKICAgICAgfQoKICAgICAgLy8gaWYgKGFyZ3MucmVxdWVzdFR5cGUgPT09ICJkYXRlTmF2aWdhdGUiKSB7CiAgICAgIC8vICAgY29uc29sZS5sb2coIiMjIyBuYXZpZ2F0aW5nIHRvOiAiLCBhcmdzLmN1cnJlbnREYXRlKTsKICAgICAgLy8gICAvLyB0aGlzLnNjaGVkdWxlT2JqLnNjcm9sbFRvKCcxMjowMCcsIGFyZ3MuY3VycmVudERhdGUpOwogICAgICAvLyB9CiAgICAgIC8vIGxldCBzY2hlZHVsZU9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJTY2hlZHVsZSIpLmVqMl9pbnN0YW5jZXNbMF07CiAgICAgIC8vICAgaWYgKGFyZ3MucmVxdWVzdFR5cGUgPT09ICdldmVudENyZWF0ZScgfHwgYXJncy5yZXF1ZXN0VHlwZSA9PT0gJ2V2ZW50Q2hhbmdlJykgewogICAgICAvLyAgICAgICBsZXQgZGF0YTsKICAgICAgLy8gICAgICAgaWYgKGFyZ3MucmVxdWVzdFR5cGUgPT09ICdldmVudENyZWF0ZScpIHsKICAgICAgLy8gICAgICAgICAgIGRhdGEgPSBhcmdzLmRhdGFbMF07CiAgICAgIC8vICAgICAgIH0gZWxzZSBpZiAoYXJncy5yZXF1ZXN0VHlwZSA9PT0gJ2V2ZW50Q2hhbmdlJykgewogICAgICAvLyAgICAgICAgICAgZGF0YSA9IGFyZ3MuZGF0YTsKICAgICAgLy8gCS8vCWRhdGEuU3ViamVjdCA9IHRoaXMudGVtcFNjaGVkdWxlTmFtZTsKICAgICAgLy8gCQljb25zb2xlLmxvZygidXBkYXRlIGRhdGEgc2F2ZSBmdW5jdGlvbiIsZGF0YSk7CiAgICAgIC8vIAkJcmV0dXJuIGRhdGE7CiAgICAgIC8vICAgICAgIH0KICAgICAgLy8gICAgICAgaWYgKCFzY2hlZHVsZU9iai5pc1Nsb3RBdmFpbGFibGUoZGF0YS5TdGFydFRpbWUsIGRhdGEuRW5kVGltZSkpIHsKICAgICAgLy8gCQljb25zb2xlLmxvZygiaXMgc2xvdCBhdmFsYSIpOwogICAgICAvLyAgICAgICAgIC8vICBhcmdzLmNhbmNlbCA9IHRydWU7CiAgICAgIC8vICAgICAgIH1lbHNlewogICAgICAvLyAJCWNvbnNvbGUubG9nKCJjcmVhdGUgbmV3Iik7CiAgICAgIC8vIAkJLy9zY2hlZHVsZU9iai5zYXZlRXZlbnQoZGF0YSkKICAgICAgLy8gCX1lbmREYXRlCiAgICAgIC8vICAgfQogICAgfSwKICAgIG9uQWN0aW9uQ29tcGxldGU6IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIGlmICgKICAgICAgICBhcmdzLnJlcXVlc3RUeXBlID09PSAidmlld05hdmlnYXRlIiB8fAogICAgICAgIGFyZ3MucmVxdWVzdFR5cGUgPT09ICJkYXRlTmF2aWdhdGUiCiAgICAgICkgewogICAgICAgIHZhciBzY2hlZHVsZU9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJTY2hlZHVsZSIpLmVqMl9pbnN0YW5jZXNbMF07CiAgICAgICAgdmFyIHNlbERhdGUgPSBzY2hlZHVsZU9iai5zZWxlY3RlZERhdGU7CiAgICAgICAgdmFyIGN1cnJlbnRWaWV3RGF0ZXMgPSBzY2hlZHVsZU9iai5nZXRDdXJyZW50Vmlld0RhdGVzKCk7CiAgICAgICAgdmFyIHN0YXJ0RGF0ZSA9IGN1cnJlbnRWaWV3RGF0ZXNbMF07CiAgICAgICAgdmFyIGVuZERhdGUgPSBjdXJyZW50Vmlld0RhdGVzW2N1cnJlbnRWaWV3RGF0ZXMubGVuZ3RoIC0gMV07CiAgICAgICAgLy8gY29uc29sZS5sb2coImUtbW9udGgtdmlldy1zdGFydERhdGU6ICIgKyBzdGFydERhdGUpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCJlLW1vbnRoLXZpZXctZW5kRGF0ZWVuZERhdGU6ICIgKyBlbmREYXRlKTsKCiAgICAgICAgaWYgKHNjaGVkdWxlT2JqLmFjdGl2ZVZpZXcudmlld0NsYXNzID09PSAiZS1tb250aC12aWV3IikgewogICAgICAgICAgLy8gY29uc29sZS5sb2coImUtbW9udGgtdmlldyIpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBvblBvcHVwT3BlbjogZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgLy8gY29uc29sZS5sb2coInNjaGVkdWxlciIsIGFyZ3MpOwoKICAgICAgaWYgKGFyZ3MudHlwZSA9PT0gIkVkaXRvciIpIHsKICAgICAgICBhcmdzLmNhbmNlbCA9IHRydWU7CiAgICAgICAgdGhpcy5FZGl0U2NoZVRlbmFudFVVSWQgPSBhcmdzLmRhdGEudGVuYW50VVVJRDsKICAgICAgICB0aGlzLkVkaXRTY2hlSWQgPSBhcmdzLmRhdGEuaWQ7CiAgICAgICAgdGhpcy50ZW1wT2JqLmVkaXRGbGFnID0gdHJ1ZTsKICAgICAgICAvLyB0aGlzLmVkaXRGbGFnID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzc3VlSUQgPSBhcmdzLmRhdGEuc3JJZDsKICAgICAgICB0aGlzLnNlcnZpY2VSZXF1ZXN0VVVJRCA9IGFyZ3MuZGF0YS5zcklkOwogICAgICAgIHRoaXMuRXZlbnREaWFsb2cgPSB0cnVlOwogICAgICAgIC8vIGZvciBkYXRlCiAgICAgICAgdGhpcy5zY2hlZHVsZXJTdGFydFRpbWUgPSBhcmdzLmRhdGEuU3RhcnRUaW1lOwogICAgICAgIGxldCBudW1XZWVrcyA9IDI7CiAgICAgICAgbGV0IG5vdyA9IGFyZ3MuZGF0YS5FbmRUaW1lOwogICAgICAgIG5vdy5zZXREYXRlKG5vdy5nZXREYXRlKCkgKyBudW1XZWVrcyAqIDcpOwogICAgICAgIHRoaXMuc2NoZWR1bGVyRW5kVGltZSA9IG5vdzsKICAgICAgfSBlbHNlIGlmIChhcmdzLnR5cGUgPT09ICJEZWxldGVBbGVydCIpIHsKICAgICAgICBhcmdzLmNhbmNlbCA9IHRydWU7CiAgICAgICAgdGhpcy5kZWxldGVJbnNwZWN0aW9uRGlhbG9nID0gdHJ1ZTsKICAgICAgICB0aGlzLmRlbGV0ZUlkID0gYXJncy5kYXRhLmlkOwogICAgICAgIC8vIHRoaXMuJHJlZnMuU2NoZWR1bGVPYmouZGVsZXRlRXZlbnQoYXJncy5kYXRhKTsKCiAgICAgIH0gZWxzZSBpZiAoYXJncy50eXBlID09PSAiUmVjdXJyZW5jZUFsZXJ0IikgewogICAgICB9CiAgICB9LAogICAgc2VsZWN0RXZlbnRUeXBlKG9iaikgewogICAgICB0aGlzLmV2ZW50VGFicyA9IG9iai52YWx1ZTsKICAgICAgLy8JdGhpcy5jYWxlbmRlckRhdGVPYmogPSAiIjsKICAgIH0sCiAgICBjbG9zZSgpIHsKICAgICAgKHRoaXMuZXZlbnRUYWJzID0gImluc3BlY3Rpb24iKSwgKHRoaXMuRXZlbnREaWFsb2cgPSBmYWxzZSk7CiAgICAgIHRoaXMudGVtcE9iai5lZGl0RmxhZyA9IGZhbHNlOwogICAgIGlmICh0aGlzLkVkaXRTY2hlVGVuYW50VVVJZCAhPT0gIiIgJiYgdGhpcy5FZGl0U2NoZUlkICE9PSAiIil7CiAgICAgICB0aGlzLkVkaXRTY2hlVGVuYW50VVVJZCA9ICIiLAogICAgICAgdGhpcy5FZGl0U2NoZUlkID0gIiIKICAgICB9CiAgICB9LAogICAgY2xvc2VQb3BVcCgpIHsKICAgICAgdGhpcy5TaG93UG9wVXAgPSBmYWxzZTsKICAgICAgdGhpcy5TaG93VW5Qb3BVcCA9IGZhbHNlOwogICAgfSwKICAgIG9uU2VsZWN0ZWQodmFsdWUpIHsKICAgICAgY29uc29sZS5sb2coInNlbGV0ZWQgdmFsdWUiLCB2YWx1ZSk7CiAgICB9LAogICAgb25TZWxlY3RlZENhdGVnb3J5KCkge30sCiAgICBzZWFyY2hGdW5jdGlvbigpIHt9LAogICAgZmlsdGVyRnVuKCkgewogICAgICB0aGlzLmZsYWc7CiAgICAgIHRoaXMuZmxhZyA9ICF0aGlzLmZsYWc7CiAgICAgIHRoaXMuZmlsdGVySW5kZXgrKzsKICAgIH0sCiAgICBTY2hlZHVsZXJFZGl0RnVuYygpewoKCiAgICAgIGxldCBzY2hlZHVsZU9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJTY2hlZHVsZSIpLmVqMl9pbnN0YW5jZXNbMF07IAogICAgICB2YXIgYXJyT2ZPYmogPSBzY2hlZHVsZU9iai5ldmVudFNldHRpbmdzLmRhdGFTb3VyY2UKICAgIAogICAgICB2YXIgZGF0YUFyciA9IGFyck9mT2JqLm1hcChpdGVtPT57CiAgICAgICAgICByZXR1cm4gW2l0ZW0uaWQsaXRlbV0KICAgICAgfSk7IAogICAgICB2YXIgbWFwYXJyID0gbmV3IE1hcChkYXRhQXJyKTsgCiAgICAgIHZhciByZXN1bHQgPSBbLi4ubWFwYXJyLnZhbHVlcygpXTsKCiAgICAgIHNjaGVkdWxlT2JqLmV2ZW50U2V0dGluZ3MuZGF0YVNvdXJjZSA9IFt7fV0KICAgICAgc2NoZWR1bGVPYmouZXZlbnRTZXR0aW5ncy5kYXRhU291cmNlID0gcmVzdWx0CiAgICB9LAogICAgYXN5bmMgaW5zcGVjdGlvbkFzc2lnbm1lbnQob2JqKSB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCJvYmoiLG9iaikKICAgICAgdHJ5IHsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgaWYgKG9iai5mcmVxdWVuY3lUeXBlID09PSAiYWQtaG9jIikgewogICAgICAgIGxldCBkYXRlID0gb2JqLmRlYWRMaW5lRGF0ZTsKICAgICAgICBsZXQgdGltZSA9IG9iai5kZWFkTGluZVRpbWU7CiAgICAgICAgdmFyIGRhdGVTcGxpdCA9IGRhdGUuc3BsaXQoIlQiKTsKICAgICAgICB2YXIgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgICB2YXIgdGltZVNwbGl0ID0gdGltZS5zcGxpdCgiOiIpOwogICAgICAgIHZhciBob3VyID0gdGltZVNwbGl0WzBdOwogICAgICAgIHZhciBtaW4gPSB0aW1lU3BsaXRbMV07CiAgICAgICAgdmFyIHN0YXJ0RGF0ZSA9IG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWluICsgIjoiICsgIjAwKzA1OjAwIjsKICAgICAgICB2YXIgc3ViT25lSG91ciA9IG1vbWVudChzdGFydERhdGUpLnN1YnRyYWN0KDEsICJoIikuZm9ybWF0KCk7CiAgICAgICAgbGV0IGVuZFRpbWUgPSBuZXcgRGF0ZShzdGFydERhdGUpOwogICAgICAgIGxldCBzdGFydFRpbWUgPSBuZXcgRGF0ZShzdWJPbmVIb3VyKTsKICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBJbnNwZWN0aW9uU2VydmljZS5hc3NpZ25TY2hlZHVsZUluc3BlY3Rpb25UZW1wbGF0ZShvYmopCiAgICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIHRoaXMudGVtcEFzc2lnbm1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KHJlcy5kYXRhLmRlc2NyaXB0aW9uLCAic3VjY2VzcyIpOwogICAgICAgICAgIGF3YWl0IHRoaXMuR2V0U2NoZWR1bGVyVGlja2V0cygpOwogICAgICAgICAgIGF3YWl0IHRoaXMuU2NoZWR1bGVyRWRpdEZ1bmMoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAob2JqLmZyZXF1ZW5jeVR5cGUgPT09ICJkYWlseSIpIHsKICAgICAgICBsZXQgY2VpbERhdGUgPSBtb21lbnQodGhpcy5jZWlsU3RhcnREYXRlVGltZSkuZm9ybWF0KCJZWVlZLU1NLUREIik7CiAgICAgICAgbGV0IGFwcGVuZFRpbWUgPSBtb21lbnQob2JqLmRlYWRMaW5lRGF0ZSkuZm9ybWF0KCJISDptbSIpOwogICAgICAgIGxldCB0aW1lID0gYXBwZW5kVGltZSsiOjAwKzA1OjAwIjsKICAgICAgICBzdGFydERhdGUgPSBjZWlsRGF0ZSArICJUIiArIHRpbWU7CiAgICAgICAgLy8gb2JqLmRlYWRMaW5lRGF0ZSA9IG1vbWVudChzdGFydERhdGUpLmZvcm1hdCgpOwoKICAgICAgIGxldCByZXMgPSBhd2FpdCBJbnNwZWN0aW9uU2VydmljZS5hc3NpZ25TY2hlZHVsZUluc3BlY3Rpb25UZW1wbGF0ZShvYmopCiAgICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgIAogICAgICAgICAgdGhpcy50ZW1wQXNzaWdubWVudCA9IGZhbHNlOwogICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KHJlcy5kYXRhLmRlc2NyaXB0aW9uLCAic3VjY2VzcyIpOwogICAgICAgICAgIGF3YWl0IHRoaXMuR2V0U2NoZWR1bGVyVGlja2V0cygpOwogICAgICAgICAgIGF3YWl0IHRoaXMuU2NoZWR1bGVyRWRpdEZ1bmMoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYob2JqLmZyZXF1ZW5jeVR5cGUgPT09ICJ3ZWVrbHkiIHx8IG9iai5mcmVxdWVuY3lUeXBlID09PSAibW9udGhseSIgfHwgb2JqLmZyZXF1ZW5jeVR5cGUgPT09ICJ5ZWFybHkiKXsKICAgICAgIGxldCByZXMgPSBhd2FpdCBJbnNwZWN0aW9uU2VydmljZS5hc3NpZ25TY2hlZHVsZUluc3BlY3Rpb25UZW1wbGF0ZShvYmopCiAgICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgIAogICAgICAgICAgdGhpcy50ZW1wQXNzaWdubWVudCA9IGZhbHNlOwogICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KHJlcy5kYXRhLmRlc2NyaXB0aW9uLCAic3VjY2VzcyIpOwogICAgICAgICAgIGF3YWl0IHRoaXMuR2V0U2NoZWR1bGVyVGlja2V0cygpOwogICAgICAgICAgIGF3YWl0IHRoaXMuU2NoZWR1bGVyRWRpdEZ1bmMoKTsKICAgICAgICAgIH0KICAgICAgICB9IAogICAgICAgIH1jYXRjaCAoZSkgewogICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdChlLmRhdGEuZGVzY3JpcHRpb24sICJlcnJvciIpOwogICAgICAgICAgdGhyb3cgZTsKICAgICAgfQogICAgfSwKICAgIHBvcHVwT3BlbihhcmdzKXsKICAgICAgY29uc29sZS5sb2coJ3BvcHVwT3BlbicpCiAgICB9LAogICAgYXN5bmMgdXBkYXRlQXNzaWduZWRUZW1wbGF0ZShvYmopIHsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGxldCByZXMgPSBhd2FpdCBpbnNwZWN0aW9uU2VydmljZS51cGRhdGVBc3NpZ25TY2hlZHVsZUluc3BlY3Rpb25UZW1wbGF0ZShvYmopCiAgICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCl7CiAgICAgICAgICB0aGlzLnRlbXBBc3NpZ25tZW50ID0gZmFsc2U7CiAgICAgICAgICB0aGlzLiRlbWl0KCJzaG93VG9hc3QiLCByZXMuZGF0YS5kZXNjcmlwdGlvbiwgInN1Y2Nlc3MiKTsKICAgICAgICAgIGF3YWl0IHRoaXMuR2V0U2NoZWR1bGVyVGlja2V0cygpOwogICAgICAgICAgYXdhaXQgdGhpcy5TY2hlZHVsZXJFZGl0RnVuYygpOwogICAgICAgICAgCiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICB9CiAgICAgICAgIAogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRoaXMuJGVtaXQoInNob3dUb2FzdCIsIGUuZGF0YS5yZXNwb25zZSwgImVycm9yIik7CiAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgIH0sCiAgICB3b3JrT3JkZXJBc3NpZ25tZW50KGNyZWF0ZVdvcmtPcmRlclJlcXVlc3QpIHsKICAgICAgY29uc29sZS5sb2coY3JlYXRlV29ya09yZGVyUmVxdWVzdCk7CgogICAgICBXb3JrT3JkZXJTZXJ2aWNlLmFkZFdvcmtPcmRlcigKICAgICAgICBjcmVhdGVXb3JrT3JkZXJSZXF1ZXN0LAogICAgICAgIHRoaXMuY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQKICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJyZXNwb25zZSIsIHJlc3BvbnNlKTsKICAgICAgICAgICAgbGV0IHN0YXJ0RGF0ZSA9CiAgICAgICAgICAgICAgY3JlYXRlV29ya09yZGVyUmVxdWVzdC53b3JrT3JkZXIuc2NoZWR1bGUuZm9ybWF0KCJNTSBERCBZWVlZIik7CiAgICAgICAgICAgIHZhciB0b2RheSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgIHZhciB0aW1lID0KICAgICAgICAgICAgICB0b2RheS5nZXRIb3VycygpICsKICAgICAgICAgICAgICAiOiIgKwogICAgICAgICAgICAgIHRvZGF5LmdldE1pbnV0ZXMoKSArCiAgICAgICAgICAgICAgIjoiICsKICAgICAgICAgICAgICB0b2RheS5nZXRTZWNvbmRzKCk7CiAgICAgICAgICAgIHZhciBkYXRlVGltZSA9IHN0YXJ0RGF0ZSArICIgIiArIHRpbWU7CiAgICAgICAgICAgIHZhciBkYXRlID0gbW9tZW50KGRhdGVUaW1lKS5mb3JtYXQoKTsKICAgICAgICAgICAgbGV0IGVuZERhdGUgPSBtb21lbnQoZGF0ZSkuc3VidHJhY3QoMSwgImgiKS5mb3JtYXQoKTsKICAgICAgICAgICAgbGV0IHNjaGVkdWxlT2JqID0KICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiU2NoZWR1bGUiKS5lajJfaW5zdGFuY2VzWzBdOwogICAgICAgICAgICBsZXQgZXZlbnREYXRhID0gewogICAgICAgICAgICAgIElkOiB0aGlzLmdlbmVyYXRlVVVJRCgpLAogICAgICAgICAgICAgIFN1YmplY3Q6ICJXb3JrIE9yZGVyIiwKICAgICAgICAgICAgICBTdGFydFRpbWU6IG5ldyBEYXRlKGVuZERhdGUpLAogICAgICAgICAgICAgIEVuZFRpbWU6IG5ldyBEYXRlKGRhdGVUaW1lKSwKICAgICAgICAgICAgICBJc0FsbERheTogZmFsc2UsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJkYXRhIiwgZXZlbnREYXRhKTsKICAgICAgICAgICAgc2NoZWR1bGVPYmouYWRkRXZlbnQoZXZlbnREYXRhKTsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoZXJyb3IuZGF0YS5yZXNwb25zZSwgImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgaXNzdWVBc3NpZ25tZW50KGlzc3VlUmVxdWVzdCkgewogICAgICBjb25zb2xlLmxvZygiaXNzdWVSZXF1ZXN0IiwgaXNzdWVSZXF1ZXN0KTsKICAgICAgLy9yZXR1cm47CiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLmFkZElzc3VlKGlzc3VlUmVxdWVzdCkKICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICBjb25zb2xlLmxvZyhyZXMpOwogICAgICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICBsZXQgc2NoZWR1bGVPYmogPQogICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJTY2hlZHVsZSIpLmVqMl9pbnN0YW5jZXNbMF07CiAgICAgICAgICAgIGxldCBldmVudERhdGEgPSB7CiAgICAgICAgICAgICAgSWQ6IHRoaXMuZ2VuZXJhdGVVVUlEKCksCiAgICAgICAgICAgICAgU3ViamVjdDogaXNzdWVSZXF1ZXN0Lmlzc3VlUmVwb3J0aW5nLmlzc3VlTmFtZSwKICAgICAgICAgICAgICBTdGFydFRpbWU6IHRoaXMuY2FsZW5kZXJEYXRlT2JqLnN0YXJ0VGltZSwKICAgICAgICAgICAgICBFbmRUaW1lOiB0aGlzLmNhbGVuZGVyRGF0ZU9iai5lbmRUaW1lLAogICAgICAgICAgICAgIElzQWxsRGF5OiBmYWxzZSwKICAgICAgICAgICAgICBJc3N1ZUlkOiByZXMuZGF0YS5vYmplY3RJZCwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc29sZS5sb2coImRhdGEiLCBldmVudERhdGEpOwogICAgICAgICAgICBzY2hlZHVsZU9iai5hZGRFdmVudChldmVudERhdGEpOwogICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnIpID0+IHsKICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KGVyci5yZXNwb25zZS5kYXRhLmRlc2NyaXB0aW9uLCAiZXJyb3IiKTsKICAgICAgICB9KTsKICAgIH0sCiAgICB1cGRhdGVJc3N1ZUFzc2lnbm1lbnQodXBkYXRlSXNzdWVSZXF1ZXN0KSB7CiAgICAgIHRoaXMudGVtcFNjaGVkdWxlTmFtZSA9IHVwZGF0ZUlzc3VlUmVxdWVzdC5pc3N1ZVJlcG9ydGluZy5pc3N1ZU5hbWU7CiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLnVwZGF0ZUlzc3VlKHVwZGF0ZUlzc3VlUmVxdWVzdCkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICAvL3RoaXMub25BY3Rpb25CZWdpbigpOwogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoZXJyb3IuZGF0YS5yZXNwb25zZSwgImVycm9yIik7CiAgICAgICAgfSk7CiAgICB9LAogICAgY3JlYXRlU2VydmljZVJlcXVlc3QoaXNzdWVSZXF1ZXN0KSB7CiAgICAgIGNvbnNvbGUubG9nKGlzc3VlUmVxdWVzdCk7CiAgICAgIGNvbnNvbGUubG9nKHRoaXMuY2FsZW5kZXJEYXRlT2JqKTsKICAgICAgSW5zcGVjdGlvblNlcnZpY2UuYWRkSXNzdWUoaXNzdWVSZXF1ZXN0KQogICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KHJlcy5kYXRhLmRlc2NyaXB0aW9uLCAic3VjY2VzcyIpOwogICAgICAgICAgICBsZXQgc2NoZWR1bGVPYmogPQogICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJTY2hlZHVsZSIpLmVqMl9pbnN0YW5jZXNbMF07CiAgICAgICAgICAgIGxldCBldmVudERhdGEgPSB7CiAgICAgICAgICAgICAgSWQ6IHRoaXMuZ2VuZXJhdGVVVUlEKCksCiAgICAgICAgICAgICAgU3ViamVjdDogaXNzdWVSZXF1ZXN0Lmlzc3VlUmVwb3J0aW5nLmlzc3VlTmFtZSwKICAgICAgICAgICAgICBTdGFydFRpbWU6IHRoaXMuY2FsZW5kZXJEYXRlT2JqLnN0YXJ0VGltZSwKICAgICAgICAgICAgICBFbmRUaW1lOiB0aGlzLmNhbGVuZGVyRGF0ZU9iai5lbmRUaW1lLAogICAgICAgICAgICAgIElzQWxsRGF5OiBmYWxzZSwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc29sZS5sb2coImRhdGEiLCBldmVudERhdGEpOwogICAgICAgICAgICBzY2hlZHVsZU9iai5hZGRFdmVudChldmVudERhdGEpOwogICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGVycikgPT4gewogICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdChlcnIsICJlcnJvciIpOwogICAgICAgICAgY29uc29sZS5sb2coZXJyKTsKICAgICAgICB9KTsKICAgIH0sCiAgICBzaG93VG9hc3QobWVzc2FnZSwgdHlwZSkgewogICAgICB0aGlzLnRvYXN0TWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgIHRoaXMudG9hc3RUeXBlID0gdHlwZTsKICAgICAgdGhpcy50b2FzdEZsYWcrKzsKICAgIH0sCiAgICBnZW5lcmF0ZVVVSUQoKSB7CiAgICAgIGxldCBkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgIGlmIChEYXRlLm5vdygpKSB7CiAgICAgICAgZCA9IERhdGUubm93KCk7CiAgICAgIH0KCiAgICAgIGxldCB1dWlkID0gInh4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCIucmVwbGFjZSgKICAgICAgICAvW3h5XS9nLAogICAgICAgIChjKSA9PiB7CiAgICAgICAgICBsZXQgciA9IChkICsgTWF0aC5yYW5kb20oKSAqIDE2KSAlIDE2IHwgMDsKICAgICAgICAgIGQgPSBNYXRoLmZsb29yKGQgLyAxNik7CiAgICAgICAgICByZXR1cm4gKGMgPT09ICJ4IiA/IHIgOiAociAmIDB4MykgfCAweDgpLnRvU3RyaW5nKDE2KTsKICAgICAgICB9CiAgICAgICk7CiAgICAgIHJldHVybiB1dWlkOwogICAgfSwKICAgIHNlbGVjdFVzZXIoKSB7CiAgICAgIGxldCBjdXJyZW50VXNlckRldGFpbHMgPSBKU09OLnBhcnNlKAogICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjdXJyZW50VXNlckRldGFpbHMiKQogICAgICApOwogICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuZ2V0QWxsVXNlcnMoCiAgICAgICAgY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQKICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgbGV0IHVzZXJzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVzcG9uc2UuZGF0YS51c2Vycy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgbGV0IHVzZXIgPSB7fTsKICAgICAgICAgICAgdXNlci5sYWJlbCA9IHJlc3BvbnNlLmRhdGEudXNlcnNbaW5kZXhdLm5hbWU7CiAgICAgICAgICAgIHVzZXIudmFsdWUgPSByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5uYW1lOwogICAgICAgICAgICB1c2VyLnV1aWQgPSByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS51dWlkOwogICAgICAgICAgICB1c2VyLm5hbWUgPSByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5uYW1lOwogICAgICAgICAgICB1c2Vycy5wdXNoKHVzZXIpOwogICAgICAgICAgICB0aGlzLmFsbFVzZXJzLnB1c2goewogICAgICAgICAgICAgIGZpcnN0TmFtZTogcmVzcG9uc2UuZGF0YS51c2Vyc1tpbmRleF0uZmlyc3ROYW1lLAogICAgICAgICAgICAgIGxhc3ROYW1lOiByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5sYXN0TmFtZSwKICAgICAgICAgICAgICBwcm9maWxlSW1hZ2U6IHJlc3BvbnNlLmRhdGEudXNlcnNbaW5kZXhdLmltYWdlVXJsLAogICAgICAgICAgICAgIHV1aWQ6IHJlc3BvbnNlLmRhdGEudXNlcnNbaW5kZXhdLnV1aWQsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5Vc2VycyA9IHVzZXJzOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICB9KTsKICAgIH0sCiAgICB1bkFzc2lnbkFzc2V0KGluZGV4LCB2YWx1ZSkgewogICAgICB0aGlzLmFzc2lnblRhYmxlVmFsdWUgPSB2YWx1ZTsKICAgICAgdmFyIGN1cnJlbnREYXRlID0gbW9tZW50KCkuZm9ybWF0KCk7CiAgICAgIGlmIChtb21lbnQodmFsdWUuc3RhcnREYXRlKS5mb3JtYXQoKSA+IGN1cnJlbnREYXRlKSB7CiAgICAgICAgdGhpcy5mdXR1cmVkVW5Bc3NpZ25tZW50KHZhbHVlLmFzc2lnbm1lbnRJZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2codmFsdWUpOwogICAgICAgIHRoaXMudmFsdWVFZGl0QXNzaWduID0gdmFsdWU7CiAgICAgICAgdGhpcy51c2VySW5kZXggPSBpbmRleDsKICAgICAgICB0aGlzLmFzc2V0VXVpZCA9IHZhbHVlLmFzc2V0VXVpZDsKICAgICAgICB0aGlzLmtleUluZGV4Kys7CiAgICAgICAgdGhpcy5TaG93VW5Qb3BVcCA9IHRydWU7CiAgICAgIH0KICAgIH0sCiAgICBmdXR1cmVkVW5Bc3NpZ25tZW50KHV1aWQpIHsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmRlbGV0ZVBvc3RBc3NpZ25tZW50QnlVVUlEKHV1aWQpCiAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgdGhpcy5zaG93VG9hc3QocmVzLmRhdGEuZGVzY3JpcHRpb24sICJzdWNjZXNzIik7CiAgICAgICAgICAvLyAgIHRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICB9KTsKICAgIH0sCiAgICBlZGl0QXNzaWduZWQoaW5kZXgsIHZhbCkgewogICAgICAvLyBjb25zb2xlLmxvZygiZWRpdCIsIHZhbCk7CiAgICAgIHRoaXMudmFsdWVFZGl0QXNzaWduID0gdmFsOwogICAgICB0aGlzLmFzc2V0VXVpZCA9IHZhbC5hc3NldFV1aWQ7CiAgICAgIHRoaXMua2V5SW5kZXgrKzsKICAgICAgdGhpcy5TaG93UG9wVXAgPSB0cnVlOwogICAgICAvL2NvbnNvbGUubG9nKCJ0ZXN0Iik7CiAgICB9LAogICAgb3BlblBvcFVwKHZhbCkgewogICAgICB0aGlzLmFzc2V0VXVpZCA9IHZhbDsKICAgICAgdGhpcy5TaG93UG9wVXAgPSB0cnVlOwogICAgfSwKICAgIHVuQXNzaWduVXNlcih2YWx1ZSkgewogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICBjb25zb2xlLmxvZyh2YWx1ZSk7CiAgICAgIHZhciBjdXJyZW50RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgpOwogICAgICB2YXIgc2VsZWN0ZWREYXRlID0gbW9tZW50KHZhbHVlLmFzc2lnbm1lbnREYXRlKS5mb3JtYXQoCiAgICAgICAgIllZWVktTU0tRERUSEg6TU06U1NaIgogICAgICApOwogICAgICB2YXIgZGF0ZVNwbGl0ID0gc2VsZWN0ZWREYXRlLnNwbGl0KCJUIik7CiAgICAgIHZhciBvYmpEYXRlID0gZGF0ZVNwbGl0WzBdOwogICAgICB2YXIgdGltZVNwbGl0ID0gdmFsdWUuYXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgdmFyIGhvdXIgPSB0aW1lU3BsaXRbMF07CiAgICAgIHZhciBtaW4gPSB0aW1lU3BsaXRbMV07CiAgICAgIHZhciBhc3NpZ25tZW50RGF0ZSA9IG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWluICsgIjoiICsgIjAwKzA1OjAwIjsKICAgICAgaWYgKAogICAgICAgIERhdGUucGFyc2UodGhpcy5hc3NpZ25UYWJsZVZhbHVlLnN0YXJ0RGF0ZSkgPiBEYXRlLnBhcnNlKGFzc2lnbm1lbnREYXRlKQogICAgICApIHsKICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICJTZWxlY3QgRGF0ZSBhbmQgdGltZSBsYXRlciB0byBjdXJyZW50IGFzc2lnbm1lbnQgZGF0ZSBhbmQgdGltZS4iLAogICAgICAgICAgInN1Y2Nlc3MiCiAgICAgICAgKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHZhbHVlLmN1cnJlbnREYXRlVGltZSA9PSB0cnVlKSB7CiAgICAgICAgbGV0IERlbGV0ZUFzc2lnbm1lbnRSZWNvcmRSZXF1ZXN0ID0gewogICAgICAgICAgYXNzZXRVVUlEOiB0aGlzLmFzc2V0VXVpZCwKICAgICAgICAgIHVzZXJVVUlEOiB2YWx1ZS51dWlkLAogICAgICAgICAgZW5kaW5nRGF0ZTogY3VycmVudERhdGUsCiAgICAgICAgfTsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICJEZWxldGVBc3NpZ25tZW50UmVjb3JkUmVxdWVzdCIsCiAgICAgICAgICBEZWxldGVBc3NpZ25tZW50UmVjb3JkUmVxdWVzdAogICAgICAgICk7CiAgICAgICAgLy9yZXR1cm47CiAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLnVuYXNzaWduQXNzZXQoRGVsZXRlQXNzaWdubWVudFJlY29yZFJlcXVlc3QpLnRoZW4oCiAgICAgICAgICAocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vCWxldCB1c2VycyA9IHRoaXMuYXNzaWduZWRVc2VyczsKICAgICAgICAgICAgLy8JbGV0IGhpc3RvcnlVc2VycyA9IHRoaXMuYXNzaWdubWVudEhpc3RvcnlVc2VyczsKICAgICAgICAgICAgLy8JbGV0IGhpc3RvcnlBZGRlZCA9IGZhbHNlOwogICAgICAgICAgICAvLwljb25zb2xlLmxvZyh1c2Vycyk7CiAgICAgICAgICAgIC8vCWRlYnVnZ2VyCiAgICAgICAgICAgIC8vCXRoaXMuZGVsZXRlTW9kZWwgPSBmYWxzZTsKICAgICAgICAgICAgLy8gaGlzdG9yeVVzZXJzLm1hcCgoaGlzdG9yeUl0ZW0pID0+IHsKICAgICAgICAgICAgLy8gCWlmIChoaXN0b3J5SXRlbS51dWlkID09PSB2YWx1ZS51dWlkKSB7CiAgICAgICAgICAgIC8vIAkJaGlzdG9yeUl0ZW0udXNlckVuZGluZ0RhdGVzOwogICAgICAgICAgICAvLyAJCWhpc3RvcnlJdGVtLnVzZXJTdGFydERhdGVzOwogICAgICAgICAgICAvLyAJCWhpc3RvcnlBZGRlZCA9IHRydWU7CiAgICAgICAgICAgIC8vIAl9CiAgICAgICAgICAgIC8vIAlyZXR1cm4gaGlzdG9yeUl0ZW07CiAgICAgICAgICAgIC8vIH0pOwoKICAgICAgICAgICAgLy8gaWYgKCFoaXN0b3J5QWRkZWQpIHsKICAgICAgICAgICAgLy8gCWxldCBuZXdVc2VyID0gewogICAgICAgICAgICAvLyAJCXV1aWQ6IHZhbHVlLnV1aWQsCiAgICAgICAgICAgIC8vIAkJbmFtZTogdXNlcnNbdGhpcy51c2VySW5kZXhdLm5hbWUsCiAgICAgICAgICAgIC8vIAkJZHVyYXRpb25zOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0uZHVyYXRpb25zLAogICAgICAgICAgICAvLyAJCXVzZXJTdGFydERhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlclN0YXJ0RGF0ZXMsCiAgICAgICAgICAgIC8vIAkJdXNlckVuZGluZ0RhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlckVuZGluZ0RhdGVzLAogICAgICAgICAgICAvLyAJfTsKICAgICAgICAgICAgLy8gaGlzdG9yeVVzZXJzLnB1c2gobmV3VXNlcik7CiAgICAgICAgICAgIC8vfQogICAgICAgICAgICAvLwl1c2Vycy5zcGxpY2UodGhpcy51c2VySW5kZXgsIDEpOwogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiVXNlciBVbi1Bc3NpZ25lZCBTdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgICAvL3RoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgICAgLy90aGlzLmdldEFzc2lnbm1lbnRIaXN0b3J5QnlBc3NldCgpOwogICAgICAgICAgICB0aGlzLlNob3dVblBvcFVwID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgdmFsdWUuY3VycmVudERhdGVUaW1lID09IGZhbHNlICYmCiAgICAgICAgY3VycmVudERhdGUgPiBtb21lbnQodmFsdWUuYXNzaWdubWVudERhdGUpLmZvcm1hdCgpCiAgICAgICkgewogICAgICAgIHNlbGVjdGVkRGF0ZSA9IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KAogICAgICAgICAgIllZWVktTU0tRERUSEg6TU06U1NaIgogICAgICAgICk7CiAgICAgICAgZGF0ZVNwbGl0ID0gc2VsZWN0ZWREYXRlLnNwbGl0KCJUIik7CiAgICAgICAgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgICB0aW1lU3BsaXQgPSB2YWx1ZS5hc3NpZ25tZW50VGltZS5zcGxpdCgiOiIpOwogICAgICAgIGhvdXIgPSB0aW1lU3BsaXRbMF07CiAgICAgICAgbWluID0gdGltZVNwbGl0WzFdOwogICAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9CiAgICAgICAgICBvYmpEYXRlICsgIlQiICsgaG91ciArICI6IiArIG1pbiArICI6IiArICIwMCswNTowMCI7CiAgICAgICAgbGV0IERlbGV0ZUFzc2lnbm1lbnRSZWNvcmRSZXF1ZXN0ID0gewogICAgICAgICAgYXNzZXRVVUlEOiB2YWx1ZS5hc3NldFV1aWQsCiAgICAgICAgICB1c2VyVVVJRDogdmFsdWUudXVpZCwKICAgICAgICAgIGVuZGluZ0RhdGU6IG1vbWVudChhc3NpZ25tZW50RGF0ZSkuZm9ybWF0KCksCiAgICAgICAgfTsKICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UudW5hc3NpZ25Bc3NldChEZWxldGVBc3NpZ25tZW50UmVjb3JkUmVxdWVzdCkudGhlbigKICAgICAgICAgIChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IHVzZXJzID0gdGhpcy5hc3NpZ25lZFVzZXJzOwogICAgICAgICAgICBsZXQgaGlzdG9yeVVzZXJzID0gdGhpcy5hc3NpZ25tZW50SGlzdG9yeVVzZXJzOwogICAgICAgICAgICBsZXQgaGlzdG9yeUFkZGVkID0gZmFsc2U7CiAgICAgICAgICAgIGhpc3RvcnlVc2Vycy5tYXAoKGhpc3RvcnlJdGVtKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGhpc3RvcnlJdGVtLnV1aWQgPT09IHZhbHVlLnV1aWQpIHsKICAgICAgICAgICAgICAgIGhpc3RvcnlJdGVtLnVzZXJFbmRpbmdEYXRlczsKICAgICAgICAgICAgICAgIGhpc3RvcnlJdGVtLnVzZXJTdGFydERhdGVzOwogICAgICAgICAgICAgICAgaGlzdG9yeUFkZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGhpc3RvcnlJdGVtOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICghaGlzdG9yeUFkZGVkKSB7CiAgICAgICAgICAgICAgbGV0IG5ld1VzZXIgPSB7CiAgICAgICAgICAgICAgICB1dWlkOiB2YWx1ZS51dWlkLAogICAgICAgICAgICAgICAgbmFtZTogdXNlcnNbdGhpcy51c2VySW5kZXhdLm5hbWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbnM6IHVzZXJzW3RoaXMudXNlckluZGV4XS5kdXJhdGlvbnMsCiAgICAgICAgICAgICAgICB1c2VyU3RhcnREYXRlczogdXNlcnNbdGhpcy51c2VySW5kZXhdLnVzZXJTdGFydERhdGVzLAogICAgICAgICAgICAgICAgdXNlckVuZGluZ0RhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlckVuZGluZ0RhdGVzLAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaGlzdG9yeVVzZXJzLnB1c2gobmV3VXNlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXNlcnMuc3BsaWNlKHRoaXMudXNlckluZGV4LCAxKTsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIlVzZXIgVW4tQXNzaWduZWQgU3VjY2Vzc2Z1bGx5IiwgInN1Y2Nlc3MiKTsKICAgICAgICAgICAgLy8JdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgICAgICAvL3RoaXMuZ2V0QXNzaWdubWVudEhpc3RvcnlCeUFzc2V0KCk7CiAgICAgICAgICAgIHRoaXMuU2hvd1VuUG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmICgKICAgICAgICBjdXJyZW50RGF0ZSA8IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KCkgJiYKICAgICAgICB2YWx1ZS5jdXJyZW50RGF0ZVRpbWUgPT0gZmFsc2UKICAgICAgKSB7CiAgICAgICAgc2VsZWN0ZWREYXRlID0gbW9tZW50KHZhbHVlLmFzc2lnbm1lbnREYXRlKS5mb3JtYXQoCiAgICAgICAgICAiWVlZWS1NTS1ERFRISDpNTTpTU1oiCiAgICAgICAgKTsKICAgICAgICBkYXRlU3BsaXQgPSBzZWxlY3RlZERhdGUuc3BsaXQoIlQiKTsKICAgICAgICBvYmpEYXRlID0gZGF0ZVNwbGl0WzBdOwogICAgICAgIHRpbWVTcGxpdCA9IHZhbHVlLmFzc2lnbm1lbnRUaW1lLnNwbGl0KCI6Iik7CiAgICAgICAgaG91ciA9IHRpbWVTcGxpdFswXTsKICAgICAgICBtaW4gPSB0aW1lU3BsaXRbMV07CiAgICAgICAgbGV0IGFzc2lnbm1lbnREYXRlID0KICAgICAgICAgIG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWluICsgIjoiICsgIjAwKzA1OjAwIjsKICAgICAgICB2YWx1ZS5zdGFydERhdGUgPSBhc3NpZ25tZW50RGF0ZTsKICAgICAgICB0aGlzLnVuQXNzaWdubWVudFVzZXJMYXRlcih2YWx1ZSk7CiAgICAgIH0KICAgIH0sCiAgICB1bkFzc2lnbm1lbnRVc2VyTGF0ZXIodmFsdWUpIHsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgSW5zcGVjdGlvblNlcnZpY2UuZ2V0SW5zcGVjdGlvblRlbXBhbHRlc0J5QXNzZXQodGhpcy5hc3NldFV1aWQpCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgbGV0IHBvc3RBc3NpZ25tZW50ID0gW107CiAgICAgICAgICAgIGxldCBvYmogPSB7CiAgICAgICAgICAgICAgYXNzaWdubWVudFVVSUQ6IHZhbHVlLmFzc2lnbm1lbnRVVUlELAogICAgICAgICAgICAgIGFzc2V0SWQ6IHRoaXMuYXNzZXRVdWlkLAogICAgICAgICAgICAgIHVzZXJJZDogdmFsdWUudXVpZCwKICAgICAgICAgICAgICBhc3NpZ246IGZhbHNlLAogICAgICAgICAgICAgIGVuZERhdGU6IHZhbHVlLnN0YXJ0RGF0ZSwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcG9zdEFzc2lnbm1lbnQucHVzaChvYmopOwogICAgICAgICAgICBsZXQgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdCA9IHt9OwogICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0Lmluc3BlY3Rpb25UZW1wbGF0ZXMgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgICAgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5wb3N0QXNzaWdubWVudCA9IHBvc3RBc3NpZ25tZW50OwogICAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuYWRkUG9zdEFzc2lnbm1lbnRPclVuQXNzaWdubWVudCgKICAgICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0CiAgICAgICAgICAgICkKICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdChyZXMuZGF0YS5kZXNjcmlwdGlvbiwgInN1Y2Nlc3MiKTsKICAgICAgICAgICAgICAgIHRoaXMuU2hvd1VuUG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vCXRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgICAgICAgIC8vCXRoaXMuZ2V0QXNzaWdubWVudEhpc3RvcnlCeUFzc2V0KCk7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJlcnJvciIsIGUpOwogICAgICAgIH0pOwogICAgfSwKICAgIHVwZGF0ZUFzc2lnblVzZXIodmFsdWUpIHsKICAgICAgY29uc29sZS5sb2coImJlZm9yZSB2YWx1ZSIsIHZhbHVlKTsKICAgICAgLy8JdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKCiAgICAgIHZhciBzZWxlY3RlZERhdGUgPSBtb21lbnQodmFsdWUuYXNzaWdubWVudERhdGUpLmZvcm1hdCgKICAgICAgICAiWVlZWS1NTS1ERFRISDpNTTpTU1oiCiAgICAgICk7CiAgICAgIHZhciBkYXRlU3BsaXQgPSBzZWxlY3RlZERhdGUuc3BsaXQoIlQiKTsKICAgICAgdmFyIG9iakRhdGUgPSBkYXRlU3BsaXRbMF07CiAgICAgIHZhciB0aW1lU3BsaXQgPSB2YWx1ZS5hc3NpZ25tZW50VGltZS5zcGxpdCgiOiIpOwogICAgICB2YXIgaG91ciA9IHRpbWVTcGxpdFswXTsKICAgICAgdmFyIG1pbiA9IHRpbWVTcGxpdFsxXTsKICAgICAgbGV0IGZ1dHVyZUFzc2lnbm1lbnREYXRlID0KICAgICAgICBvYmpEYXRlICsgIlQiICsgaG91ciArICI6IiArIG1pbiArICI6IiArICIwMCswNTowMCI7CiAgICAgIHZhbHVlLnN0YXJ0RGF0ZSA9IGZ1dHVyZUFzc2lnbm1lbnREYXRlOwogICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgY29uc29sZS5sb2coImFmdGVyIHZhbHVlIiwgdmFsdWUpOwogICAgICBjb25zb2xlLmxvZyhuZXcgRGF0ZShjdXJyZW50RGF0ZSkpOwogICAgICAvLyBlbmQgRGF0ZSBIYW5kbGVyCiAgICAgIHZhciB1bkFzc2lnbm1lbnREYXRlID0gbW9tZW50KHZhbHVlLnVuQXNzaWdubWVudERhdGUpLmZvcm1hdCgKICAgICAgICAiWVlZWS1NTS1ERCIKICAgICAgKTsKICAgICAgdmFyIHVuVGltZVNwbGl0ID0gdmFsdWUudW5Bc3NpZ25tZW50VGltZS5zcGxpdCgiOiIpOwogICAgICB2YXIgZW5kSG91ciA9IHVuVGltZVNwbGl0WzBdOwogICAgICB2YXIgZW5kTWluID0gdW5UaW1lU3BsaXRbMV07CiAgICAgIGxldCBlbmRBc3NpZ25tZW50RGF0ZSA9CiAgICAgICAgdW5Bc3NpZ25tZW50RGF0ZSArICJUIiArIGVuZEhvdXIgKyAiOiIgKyBlbmRNaW4gKyAiOiIgKyAiMDArMDU6MDAiOwoKICAgICAgbGV0IHNjaGVkdWxlT2JqID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlNjaGVkdWxlIikuZWoyX2luc3RhbmNlc1swXTsKICAgICAgbGV0IGV2ZW50RGF0YSA9IHsKICAgICAgICBJZDogdGhpcy5nZW5lcmF0ZVVVSUQoKSwKICAgICAgICBTdWJqZWN0OiAiQXNzZXQgQXNzaWdubWVudCIsCiAgICAgICAgLy8gU3RhcnRUaW1lOiBjdXJyZW50RGF0ZSwKICAgICAgICAvLyBFbmRUaW1lOiBuZXcgRGF0ZShmdXR1cmVBc3NpZ25tZW50RGF0ZSksCiAgICAgICAgSXNBbGxEYXk6IGZhbHNlLAogICAgICB9OwogICAgICBpZiAodmFsdWUuY3VycmVudERhdGVUaW1lICYmIHZhbHVlLmVuZEN1cnJlbnREYXRlVGltZSkgewogICAgICAgIGNvbnNvbGUubG9nKCIxIik7CiAgICAgICAgZXZlbnREYXRhLlN0YXJ0VGltZSA9IG5ldyBEYXRlKGN1cnJlbnREYXRlKTsKICAgICAgICBldmVudERhdGEuRW5kVGltZSA9IG5ldyBEYXRlKGN1cnJlbnREYXRlKTsKICAgICAgfSBlbHNlIGlmICgKICAgICAgICB2YWx1ZS5jdXJyZW50RGF0ZVRpbWUgPT09IGZhbHNlICYmCiAgICAgICAgdmFsdWUuZW5kQ3VycmVudERhdGVUaW1lID09PSBmYWxzZQogICAgICApIHsKICAgICAgICBjb25zb2xlLmxvZygiMiIpOwogICAgICAgIChldmVudERhdGEuU3RhcnRUaW1lID0gbmV3IERhdGUoZnV0dXJlQXNzaWdubWVudERhdGUpKSwKICAgICAgICAgIChldmVudERhdGEuRW5kVGltZSA9IG5ldyBEYXRlKGVuZEFzc2lnbm1lbnREYXRlKSk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlLmVuZEN1cnJlbnREYXRlVGltZSAmJiB2YWx1ZS5jdXJyZW50RGF0ZVRpbWUgPT09IGZhbHNlKSB7CiAgICAgICAgY29uc29sZS5sb2coIjMiKTsKICAgICAgICBldmVudERhdGEuU3RhcnRUaW1lID0gbmV3IERhdGUoZnV0dXJlQXNzaWdubWVudERhdGUpOwogICAgICAgIGV2ZW50RGF0YS5lbmRUaW1lID0gbmV3IERhdGUoY3VycmVudERhdGUpOwogICAgICB9IGVsc2UgaWYgKAogICAgICAgIHZhbHVlLmVuZEN1cnJlbnREYXRlVGltZSA9PT0gZmFsc2UgJiYKICAgICAgICB2YWx1ZS5jdXJyZW50RGF0ZVRpbWUgPT09IHRydWUKICAgICAgKSB7CiAgICAgICAgY29uc29sZS5sb2coIjQiKTsKICAgICAgICBldmVudERhdGEuU3RhcnRUaW1lID0gbmV3IERhdGUoY3VycmVudERhdGUpOwogICAgICAgIGV2ZW50RGF0YS5lbmRUaW1lID0gbmV3IERhdGUoZW5kQXNzaWdubWVudERhdGUpOwogICAgICB9CiAgICAgIGNvbnNvbGUubG9nKCJkYXRhIiwgZXZlbnREYXRhKTsKICAgICAgc2NoZWR1bGVPYmouYWRkRXZlbnQoZXZlbnREYXRhKTsKCiAgICAgIHRoaXMudXBkYXRlQ3VycmVudEFzc2lnbm1lbnQodmFsdWUpOwogICAgfSwKICAgIHVwZGF0ZUN1cnJlbnRBc3NpZ25tZW50KHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZS51c2VyLmxlbmd0aCA+IDEpIHsKICAgICAgICB0aGlzLnNob3dUb2FzdCgiU2VsZWN0IG9ubHkgb25lIHVzZXIiLCAiZXJyb3IiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgSW5zcGVjdGlvblNlcnZpY2UuZ2V0SW5zcGVjdGlvblRlbXBhbHRlc0J5QXNzZXQodmFsdWUuYXNzZXRVdWlkKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PSAyMDApIHsKICAgICAgICAgICAgbGV0IFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QgPSB7CiAgICAgICAgICAgICAgYXNzaWdubWVudElkOiB2YWx1ZS5hc3NpZ25tZW50SWQsCiAgICAgICAgICAgICAgYXNzZXRJZDogdmFsdWUuYXNzZXRVdWlkLAogICAgICAgICAgICAgIHVzZXJJZDogdmFsdWUudXNlclswXS51dWlkLAogICAgICAgICAgICB9OwogICAgICAgICAgICAvL2xldCBkYXRlID0gRGF0ZSgpOwogICAgICAgICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgICAgICAgaWYgKHZhbHVlLmN1cnJlbnREYXRlVGltZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5zdGFydERhdGUgPSBjdXJyZW50RGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0LnN0YXJ0RGF0ZSA9IHZhbHVlLnN0YXJ0RGF0ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmVkaXRBc3NpZ25tZW50UmVjb3JkKAogICAgICAgICAgICAgIFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QKICAgICAgICAgICAgKQogICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZTEpID0+IHsKICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZTEuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkFzc2V0IFVwZGF0ZSBzdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgICAgICAgICAvLyAgdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgICAgICAgICAgICB0aGlzLlNob3dQb3BVcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IxKSA9PiB7CiAgICAgICAgICAgICAgICAvLyB0aGlzLnNldFN0YXRlKHtsb2FkaW5nOmZhbHNlfSk7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IxLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgYXNzaWduVXNlcih2YWx1ZSkgewogICAgICBpZiAodGhpcy52YWx1ZSAhPT0gbnVsbCkgewogICAgICAgIHZhciBzZWxlY3RlZERhdGUgPSBtb21lbnQodmFsdWUuYXNzaWdubWVudERhdGUpLmZvcm1hdCgKICAgICAgICAgICJZWVlZLU1NLUREVEhIOk1NOlNTWiIKICAgICAgICApOwogICAgICAgIHZhciBkYXRlU3BsaXQgPSBzZWxlY3RlZERhdGUuc3BsaXQoIlQiKTsKICAgICAgICB2YXIgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgICB2YXIgdGltZVNwbGl0ID0gdmFsdWUuYXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgICB2YXIgaG91ciA9IHRpbWVTcGxpdFswXTsKICAgICAgICB2YXIgbWluID0gdGltZVNwbGl0WzFdOwogICAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9CiAgICAgICAgICBvYmpEYXRlICsgIlQiICsgaG91ciArICI6IiArIG1pbiArICI6IiArICIwMCswNTowMCI7CiAgICAgICAgdmFyIGN1cnJlbnREYXRlID0gbW9tZW50KCkuZm9ybWF0KCk7CiAgICAgICAgaWYgKHZhbHVlLmN1cnJlbnREYXRlVGltZSA9PSB0cnVlKSB7CiAgICAgICAgICB2YWx1ZS5zdGFydERhdGUgPSBhc3NpZ25tZW50RGF0ZTsKICAgICAgICAgIHRoaXMuYXNzaWdubWVudFVzZXJDdXJyZW50RGF0ZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgIGFzc2lnbm1lbnREYXRlID4gY3VycmVudERhdGUgJiYKICAgICAgICAgIHZhbHVlLmN1cnJlbnREYXRlVGltZSA9PSBmYWxzZQogICAgICAgICkgewogICAgICAgICAgdmFsdWUuc3RhcnREYXRlID0gYXNzaWdubWVudERhdGU7CiAgICAgICAgICB0aGlzLmFzc2lnbm1lbnRVc2VyTGF0ZXIodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoYXNzaWdubWVudERhdGUgPCBjdXJyZW50RGF0ZSkgewogICAgICAgICAgdmFsdWUuc3RhcnREYXRlID0gYXNzaWdubWVudERhdGU7CiAgICAgICAgICB0aGlzLnBhc3RBc3NpZ25tZW50VXNlckN1cnJlbnREYXRlKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBhc3NpZ25tZW50VXNlckN1cnJlbnREYXRlKHZhbHVlKSB7CiAgICAgIHZhciB1bkFzc2lnbm1lbnREYXRlID0gbW9tZW50KHZhbHVlLnVuQXNzaWdubWVudERhdGUpLmZvcm1hdCgKICAgICAgICAiWVlZWS1NTS1ERCIKICAgICAgKTsKICAgICAgdmFyIHRpbWVTcGxpdCA9IHZhbHVlLnVuQXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgdmFyIGhvdXIgPSB0aW1lU3BsaXRbMF07CiAgICAgIHZhciBtaW4gPSB0aW1lU3BsaXRbMV07CiAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9CiAgICAgICAgdW5Bc3NpZ25tZW50RGF0ZSArICJUIiArIGhvdXIgKyAiOiIgKyBtaW4gKyAiOiIgKyAiMDArMDU6MDAiOwogICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgSW5zcGVjdGlvblNlcnZpY2UuZ2V0SW5zcGVjdGlvblRlbXBhbHRlc0J5QXNzZXQodGhpcy5hc3NldFV1aWQpCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAvLwl2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICBsZXQgYXNzaWdubWVudFJlY29yZCA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdmFsdWUudXNlci5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICBjb25zdCB1c2VySWQgPSB2YWx1ZS51c2VyW2luZGV4XS51dWlkOwogICAgICAgICAgICAgIGxldCBvYmogPSB7CiAgICAgICAgICAgICAgICBhc3NldElkOiB0aGlzLmFzc2V0VXVpZCwKICAgICAgICAgICAgICAgIGFzc2V0TWFuYWdlcklkOiB1c2VySWQsCiAgICAgICAgICAgICAgICB0eXBlOiAiIiwKICAgICAgICAgICAgICAgIHN0YXJ0ZWRBdDogY3VycmVudERhdGUsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBhc3NpZ25tZW50UmVjb3JkLnB1c2gob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdCA9IHt9OwogICAgICAgICAgICBhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0Lmluc3BlY3Rpb25UZW1wbGF0ZXMgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgICAgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5hc3NpZ25tZW50UmVjb3JkID0gYXNzaWdubWVudFJlY29yZDsKICAgICAgICAgICAgY29uc29sZS5sb2coImFzc2lnbm1lbnRSZWNvcmQiLCBhc3NpZ25tZW50UmVjb3JkKTsKICAgICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmFkZEFzc2lnbm1lbnRSZWNvcmQoYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdCkKICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UxKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UxLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZE5vdGlmaWNhdGlvblRvQXNzaWduZWRVc2VyT2ZBc3NldHMoCiAgICAgICAgICAgICAgICAgICAgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdAogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBsZXQgdXNlcmRldGFpbCA9IFtdOwogICAgICAgICAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuZ2V0VXNlckRldGFpbEJ5QXNzZXRJZEFuZFVzZXJJZCgKICAgICAgICAgICAgICAgICAgICB0aGlzLmFzc2V0VXVpZCwKICAgICAgICAgICAgICAgICAgICB2YWx1ZS52YWx1ZQogICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlMikgPT4gewogICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlMi5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLnV1aWQgPSB2YWx1ZS52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC5uYW1lID0gdmFsdWUuZGlzcGxheTsKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC5zdGFydERhdGUgPSByZXNwb25zZTIuZGF0YS51c2VyLnN0YXJ0RGF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC5jb3VudCA9IHJlc3BvbnNlMi5kYXRhLnVzZXIuY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXNzaWduZWRVc2Vycy5wdXNoKHVzZXJkZXRhaWwpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2NoZWR1bGVPYmogPQogICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJTY2hlZHVsZSIpLmVqMl9pbnN0YW5jZXNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBldmVudERhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgSWQ6IHRoaXMuZ2VuZXJhdGVVVUlEKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgU3ViamVjdDogIkFzc2V0IEFzc2lnbm1lbnQiLAogICAgICAgICAgICAgICAgICAgICAgICAgIFN0YXJ0VGltZTogY3VycmVudERhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgRW5kVGltZTogbmV3IERhdGUoYXNzaWdubWVudERhdGUpLAogICAgICAgICAgICAgICAgICAgICAgICAgIElzQWxsRGF5OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coImRhdGEiLCBldmVudERhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZU9iai5hZGRFdmVudChldmVudERhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiYXNzaWdubWVudFJlY29yZCIsIGFzc2lnbm1lbnRSZWNvcmQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICAgICAgICAgICAgICAgICAiQXNzZXQgQXNzaWduZWQgdG8gdXNlciBTdWNjZXNzZnVsbHkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLlNob3dQb3BVcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcjIpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjIucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coImVycm9yIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yMSkgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IxLnJlc3BvbnNlKTsKICAgICAgICAgICAgICAgIGlmIChlcnJvcjEucmVzcG9uc2UgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgKICAgICAgICAgICAgICAgICAgICAiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwKICAgICAgICAgICAgICAgICAgICAiZXJyb3IiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yMS5yZXNwb25zZS5kYXRhLnJlc3BvbnNlQ29kZSA9PT0gIkY1MDAiKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KGVycm9yMS5yZXNwb25zZS5kYXRhLmRlc2NyaXB0aW9uLCAiZXJyb3IiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgYXNzaWdubWVudFVzZXJMYXRlcih2YWx1ZSkgewogICAgICAvL2NvbWJpbmUgc3RhcnQgRGF0ZSBhbmQgdGltZS4uLi4KICAgICAgdmFyIGFzc2lnbm1lbnREYXRlID0gbW9tZW50KHZhbHVlLmFzc2lnbm1lbnREYXRlKS5mb3JtYXQoIllZWVktTU0tREQiKTsKICAgICAgdmFyIHN0YXJ0VGltZVNwbGl0ID0gdmFsdWUuYXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgdmFyIHN0YXJ0SG91ciA9IHN0YXJ0VGltZVNwbGl0WzBdOwogICAgICB2YXIgc3RhcnRNaW4gPSBzdGFydFRpbWVTcGxpdFsxXTsKICAgICAgbGV0IHN0YXJ0RGF0ZSA9CiAgICAgICAgYXNzaWdubWVudERhdGUgKyAiVCIgKyBzdGFydEhvdXIgKyAiOiIgKyBzdGFydE1pbiArICI6IiArICIwMCswNTowMCI7CgogICAgICAvL2NvbWJpbmUgZW5kIERhdGUgYW5kIHRpbWUuLi4uCiAgICAgIHZhciB1bkFzc2lnbm1lbnREYXRlID0gbW9tZW50KHZhbHVlLnVuQXNzaWdubWVudERhdGUpLmZvcm1hdCgKICAgICAgICAiWVlZWS1NTS1ERCIKICAgICAgKTsKICAgICAgdmFyIGVuZFRpbWVTcGxpdCA9IHZhbHVlLnVuQXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgdmFyIGVuZEhvdXIgPSBlbmRUaW1lU3BsaXRbMF07CiAgICAgIHZhciBlbmRNaW4gPSBlbmRUaW1lU3BsaXRbMV07CiAgICAgIGxldCBlbmREYXRlID0KICAgICAgICB1bkFzc2lnbm1lbnREYXRlICsgIlQiICsgZW5kSG91ciArICI6IiArIGVuZE1pbiArICI6IiArICIwMCswNTowMCI7CiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLmdldEluc3BlY3Rpb25UZW1wYWx0ZXNCeUFzc2V0KHRoaXMuYXNzZXRVdWlkKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIGxldCBwb3N0QXNzaWdubWVudCA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdmFsdWUudXNlci5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICBjb25zdCB1c2VySWQgPSB2YWx1ZS51c2VyW2luZGV4XS51dWlkOwogICAgICAgICAgICAgIGxldCBvYmogPSB7CiAgICAgICAgICAgICAgICBhc3NpZ25tZW50VVVJRDogIiIsCiAgICAgICAgICAgICAgICBhc3NldElkOiB0aGlzLmFzc2V0VXVpZCwKICAgICAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLAogICAgICAgICAgICAgICAgYXNzaWduOiB0cnVlLAogICAgICAgICAgICAgICAgc3RhcnREYXRlOiB2YWx1ZS5zdGFydERhdGUsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBwb3N0QXNzaWdubWVudC5wdXNoKG9iaik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QgPSB7fTsKICAgICAgICAgICAgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5pbnNwZWN0aW9uVGVtcGxhdGVzID0KICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmluc3BlY3Rpb25UZW1wbGF0ZXM7CiAgICAgICAgICAgIFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QucG9zdEFzc2lnbm1lbnQgPSBwb3N0QXNzaWdubWVudDsKICAgICAgICAgICAgLy8JcmV0dXJuOwogICAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuYWRkUG9zdEFzc2lnbm1lbnRPclVuQXNzaWdubWVudCgKICAgICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0CiAgICAgICAgICAgICkKICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgc2NoZWR1bGVPYmogPQogICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiU2NoZWR1bGUiKS5lajJfaW5zdGFuY2VzWzBdOwogICAgICAgICAgICAgICAgbGV0IGV2ZW50RGF0YSA9IHsKICAgICAgICAgICAgICAgICAgSWQ6IHRoaXMuZ2VuZXJhdGVVVUlEKCksCiAgICAgICAgICAgICAgICAgIFN1YmplY3Q6ICJBc3NldCBBc3NpZ25tZW50IiwKICAgICAgICAgICAgICAgICAgU3RhcnRUaW1lOiBuZXcgRGF0ZShzdGFydERhdGUpLAogICAgICAgICAgICAgICAgICBFbmRUaW1lOiBuZXcgRGF0ZShlbmREYXRlKSwKICAgICAgICAgICAgICAgICAgSXNBbGxEYXk6IGZhbHNlLAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJkYXRhIiwgZXZlbnREYXRhKTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlT2JqLmFkZEV2ZW50KGV2ZW50RGF0YSk7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdChyZXMuZGF0YS5kZXNjcmlwdGlvbiwgInN1Y2Nlc3MiKTsKICAgICAgICAgICAgICAgIHRoaXMuU2hvd1BvcFVwID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgIC8vCXRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJlcnJvciIsIGUpOwogICAgICAgIH0pOwogICAgfSwKICAgIHBhc3RBc3NpZ25tZW50VXNlckN1cnJlbnREYXRlKHZhbHVlKSB7CiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLmdldEluc3BlY3Rpb25UZW1wYWx0ZXNCeUFzc2V0KHRoaXMuYXNzZXRVdWlkKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIC8vCWRlYnVnZ2VyCiAgICAgICAgICAgIGxldCBhc3NpZ25tZW50UmVjb3JkID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2YWx1ZS51c2VyLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgIGNvbnN0IHVzZXJJZCA9IHZhbHVlLnVzZXJbaW5kZXhdLnV1aWQ7CiAgICAgICAgICAgICAgbGV0IG9iaiA9IHsKICAgICAgICAgICAgICAgIGFzc2V0SWQ6IHRoaXMuYXNzZXRVdWlkLAogICAgICAgICAgICAgICAgYXNzZXRNYW5hZ2VySWQ6IHVzZXJJZCwKICAgICAgICAgICAgICAgIHR5cGU6ICIiLAogICAgICAgICAgICAgICAgc3RhcnRlZEF0OiB2YWx1ZS5zdGFydERhdGUsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBhc3NpZ25tZW50UmVjb3JkLnB1c2gob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdCA9IHt9OwogICAgICAgICAgICBhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0Lmluc3BlY3Rpb25UZW1wbGF0ZXMgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgICAgYWRkQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5hc3NpZ25tZW50UmVjb3JkID0gYXNzaWdubWVudFJlY29yZDsKICAgICAgICAgICAgLy8JcmV0dXJuOwogICAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuYWRkQXNzaWdubWVudFJlY29yZChhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0KQogICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZTEpID0+IHsKICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZTEuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kTm90aWZpY2F0aW9uVG9Bc3NpZ25lZFVzZXJPZkFzc2V0cygKICAgICAgICAgICAgICAgICAgICBhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0CiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGxldCB1c2VyZGV0YWlsID0gW107CiAgICAgICAgICAgICAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5nZXRVc2VyRGV0YWlsQnlBc3NldElkQW5kVXNlcklkKAogICAgICAgICAgICAgICAgICAgIHRoaXMuYXNzZXRVdWlkLAogICAgICAgICAgICAgICAgICAgIHZhbHVlLnZhbHVlCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UyKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UyLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwudXVpZCA9IHZhbHVlLnZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLm5hbWUgPSB2YWx1ZS5kaXNwbGF5OwogICAgICAgICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLnN0YXJ0RGF0ZSA9IHJlc3BvbnNlMi5kYXRhLnVzZXIuc3RhcnREYXRlOwogICAgICAgICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLmNvdW50ID0gcmVzcG9uc2UyLmRhdGEudXNlci5jb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hc3NpZ25lZFVzZXJzLnB1c2godXNlcmRldGFpbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJBc3NldCBBc3NpZ25lZCB0byB1c2VyIFN1Y2Nlc3NmdWxseSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5TaG93UG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJlcnJvciIKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IyKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAvLyAgIHRoaXMuc2V0U3RhdGUoe2xvYWRpbmc6ZmFsc2V9KTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjIucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcjEpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlcnJvcjEucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsCiAgICAgICAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoCiAgICAgICAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsCiAgICAgICAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICBzZW5kTm90aWZpY2F0aW9uVG9Bc3NpZ25lZFVzZXJPZkFzc2V0cyhhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0KSB7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5zZW5kTm90aWZpY2F0aW9uVG9Bc3NpZ25lZFVzZXJzKAogICAgICAgIGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QKICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTsKICAgICAgICB9KTsKICAgIH0sCiAgICAvLyByZW1vdmUgYWZ0ZXIgQ29tcGxldGluZwogICAgZ2V0UGFnaW5hdGVkSW5zcGVjdGlvblRlbXBsYXRlcygpIHsKICAgICAgbGV0IHJlcXVlc3RPYmogPSB7CiAgICAgICAgLy8gc2VhcmNoUXVlcnk6IHNlYXJjaFF1ZXJ5LAogICAgICAgIC8vIHNlYXJjaENvbHVtbnM6IHNlYXJjaENvbHVtbnMsCiAgICAgICAgZmlsdGVyczogW10sCiAgICAgICAgc29ydEZpZWxkOiAiY3JlYXRlZEF0IiwKICAgICAgICBzb3J0RGlyZWN0aW9uOiAiZGVzYyIsCiAgICAgICAgb2Zmc2V0OiAwLAogICAgICAgIGxpbWl0OiAxMDAsCiAgICAgICAgdGVuYW50VVVJRDogdGhpcy5jdXJyZW50VXNlckRldGFpbHMucHJvZmlsZS5vcmdhbml6YXRpb25JZCwKICAgICAgICBhc3NpZ25lZDogdHJ1ZSwKICAgICAgfTsKCiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLmdldFBhZ2luYXRlZFBlbmRpbmdJbnNwZWN0aW9uUmVwb3J0c0ZvclNEVChyZXF1ZXN0T2JqKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PSAyMDApIHsKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5zZHREYXRhLmNvbnRlbnQubWFwKChpdGVtKSA9PiB7CiAgICAgICAgICAgICAgaXRlbS5jcmVhdGVkQXQgPSBtb21lbnQudXRjKGl0ZW0uY3JlYXRlZEF0KS5sb2NhbCgpLmZvcm1hdCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGV0IGluc3BlY3Rpb25UZW1wbGF0ZXMgPSByZXNwb25zZS5kYXRhLnNkdERhdGEuY29udGVudDsKICAgICAgICAgICAgbGV0IGFycmF5ID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zcGVjdGlvblRlbXBsYXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIChpbnNwZWN0aW9uVGVtcGxhdGVzW2ldLmRlYWRMaW5lRGF0ZSAhPT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICBpbnNwZWN0aW9uVGVtcGxhdGVzW2ldLmRlYWRMaW5lVGltZSAhPT0gbnVsbCkgfHwKICAgICAgICAgICAgICAgIChpbnNwZWN0aW9uVGVtcGxhdGVzW2ldLmRlYWRMaW5lRGF0ZSAhPT0gIiIgJiYKICAgICAgICAgICAgICAgICAgaW5zcGVjdGlvblRlbXBsYXRlc1tpXS5kZWFkTGluZVRpbWUgIT09ICIiKQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgLy8gZW5kIERhdGUgSGFuZGxlcgogICAgICAgICAgICAgICAgdmFyIGRlYWRMaW5lRGF0ZSA9IG1vbWVudCgKICAgICAgICAgICAgICAgICAgaW5zcGVjdGlvblRlbXBsYXRlc1tpXS5kZWFkTGluZURhdGUKICAgICAgICAgICAgICAgICkuZm9ybWF0KCJZWVlZLU1NLUREIik7CiAgICAgICAgICAgICAgICB2YXIgZGVhZExpbmVUaW1lID0KICAgICAgICAgICAgICAgICAgaW5zcGVjdGlvblRlbXBsYXRlc1tpXS5kZWFkTGluZVRpbWUuc3BsaXQoIjoiKTsKICAgICAgICAgICAgICAgIHZhciBlbmRIb3VyID0gZGVhZExpbmVUaW1lWzBdOwogICAgICAgICAgICAgICAgdmFyIGVuZE1pbiA9IGRlYWRMaW5lVGltZVsxXTsKICAgICAgICAgICAgICAgIGxldCBlbmRBc3NpZ25tZW50RGF0ZSA9CiAgICAgICAgICAgICAgICAgIGRlYWRMaW5lRGF0ZSArCiAgICAgICAgICAgICAgICAgICJUIiArCiAgICAgICAgICAgICAgICAgIGVuZEhvdXIgKwogICAgICAgICAgICAgICAgICAiOiIgKwogICAgICAgICAgICAgICAgICBlbmRNaW4gKwogICAgICAgICAgICAgICAgICAiOiIgKwogICAgICAgICAgICAgICAgICAiMDArMDU6MDAiOwogICAgICAgICAgICAgICAgbGV0IFNjaGVkdWxlT2JqID0gewogICAgICAgICAgICAgICAgICBpZDogMSwKICAgICAgICAgICAgICAgICAgLy8gR0lkOiBpbnNwZWN0aW9uVGVtcGxhdGVzW2ldLnV1aWQsCiAgICAgICAgICAgICAgICAgIFN1YmplY3Q6IGluc3BlY3Rpb25UZW1wbGF0ZXNbaV0ubmFtZSwKICAgICAgICAgICAgICAgICAgU3RhcnRUaW1lOiBuZXcgRGF0ZShpbnNwZWN0aW9uVGVtcGxhdGVzW2ldLmNyZWF0ZWRBdCksCiAgICAgICAgICAgICAgICAgIEVuZFRpbWU6IG5ldyBEYXRlKGVuZEFzc2lnbm1lbnREYXRlKSwKICAgICAgICAgICAgICAgICAgSXNBbGxEYXk6IGZhbHNlLAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlRGF0YS5wdXNoKFNjaGVkdWxlT2JqKTsKICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coc2NoZWR1bGVEYXRhKQogICAgICAgICAgICAgICAgdGhpcy5zY2hlZHVsZUtleSsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy4kZW1pdCgKICAgICAgICAgICAgICAic2hvd1RvYXN0IiwKICAgICAgICAgICAgICAiT3BwcyBpdHMgbG9vayBsaWtlIG91ciBzZXJ2ZXIgaXMgb2ZmbGluZSIsCiAgICAgICAgICAgICAgImVycm9yIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlICE9PSB1bmRlZmluZWQgJiYgZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgICAgLy8gYWxlcnQoZXJyb3IucmVzcG9uc2UuZGF0YS5kZXNjcmlwdGlvbik7CiAgICAgICAgICAgIHRoaXMuJGVtaXQoInNob3dUb2FzdCIsIGVycm9yLnJlc3BvbnNlLmRhdGEuZGVzY3JpcHRpb24sICJlcnJvciIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIC8vIHJlbW92ZSBhZnRlciBDb21wbGV0aW5nCiAgICBhc3luYyBHZXRTY2hlZHVsZXJUaWNrZXRzKCkgewogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICB2YXIgc3RhcnREYXRlID0gbW9tZW50KCkuc3RhcnRPZigid2VlayIpOwogICAgICB2YXIgZW5kRGF0ZSA9IG1vbWVudCgpLmVuZE9mKCJ3ZWVrIik7CiAgICAgIGxldCByZXF1ZXN0T2JqID0gewogICAgICAgIHRlbmFudFVVSUQ6IHRoaXMuY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQsCiAgICAgICAgZGF0YUJ5OiAid2VlayIsCiAgICAgICAgc3RhcnREYXRlOgogICAgICAgICAgdGhpcy5zY2hlZHVsZVN0YXJ0VGltZSA9PSAiIiAmJiB0aGlzLnNjaGVkdWxlckVuZFRpbWUgPT0gIiIKICAgICAgICAgID8gdGhpcy5zY2hlZHVsZVN0YXJ0VGltZSA6IHN0YXJ0RGF0ZSwKICAgICAgICBlbmREYXRlOgogICAgICAgICAgdGhpcy5zY2hlZHVsZVN0YXJ0VGltZSA9PSAiIiAmJiB0aGlzLnNjaGVkdWxlckVuZFRpbWUgPT0gIiIKICAgICAgICAgID8gdGhpcy5zY2hlZHVsZUVuZFRpbWUgOiAgZW5kRGF0ZSAsCiAgICAgICAgc2VhcmNoUXVlcnk6ICIiLAogICAgICAgIGluc3BlY3Rpb25GaWx0ZXJzOiB7fSwKICAgICAgICBhc3NpZ25tZW50RmlsdGVyczoge30sCiAgICAgICAgc2VydmljZVJlcXVlc3RGaWx0ZXJzOiB7fSwKICAgICAgICBpc3N1ZUZpbHRlcnM6IHt9LAogICAgICAgIHdvcmtPcmRlckZpbHRlcnM6IHt9LAogICAgICB9OwogICAgICAvLyBjb25zb2xlLmxvZygicmVxdWVzdE9iaiIsIHJlcXVlc3RPYmopOwogIAoKICAgICAgdGhpcy5jdXJyZW50VXNlckRldGFpbHMucHJvZmlsZS5vcmdhbml6YXRpb25JZDsKICAgICAgdHJ5IHsKICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgc2NoZWR1bGVyU2VydmljZS5nZXRTY2hlZHVsYXJUaWNrZXRzKHJlcXVlc3RPYmopCiAgICAgIAogICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PSAyMDApIHsKICAgICAgICAgICAgbGV0IHNjaGVkdWxlclRlbXBsYXRlcyA9IHJlc3BvbnNlLmRhdGEuc2NoZWR1bGVyczsKICAgICAgICAgICAgbGV0IGFycmF5ID0gW107CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVkdWxlclRlbXBsYXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBKU09OLnBhcnNlKHNjaGVkdWxlclRlbXBsYXRlc1tpXS50ZW1wbGF0ZURhdGEpOwogICAgICAgICAgICAgIHZhciByZU9jdXJyZW5jZVJ1bGUgPSAiIjsKICAgICAgICAgICAgICBpZiAoc2NoZWR1bGVyVGVtcGxhdGVzW2ldLmZyZXF1ZW5jeVR5cGUgPT0gImFkLWhvYyIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVPYmpTdGFydERhdGUgPSBtb21lbnQKICAgICAgICAgICAgICAgICAgLnV0Yyh0ZW1wbGF0ZURhdGEuZGVhZExpbmVEYXRlKQogICAgICAgICAgICAgICAgICAuZm9ybWF0KCk7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVkdWxlT2JqRW5kRGF0ZSA9IG1vbWVudAogICAgICAgICAgICAgICAgICAudXRjKHRoaXMuc2NoZWR1bGVPYmpTdGFydERhdGUpCiAgICAgICAgICAgICAgICAgIC5hZGQoMzAsICJtaW51dGVzIikKICAgICAgICAgICAgICAgICAgLmZvcm1hdCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2NoZWR1bGVyVGVtcGxhdGVzW2ldLmZyZXF1ZW5jeVR5cGUgPT0gImRhaWx5IikgewoKCiAgICAgICAgICAgICAgdGhpcy5zY2hlZHVsZU9ialN0YXJ0RGF0ZSA9IG1vbWVudC51dGModGVtcGxhdGVEYXRhLmRlYWRMaW5lRGF0ZSkuZm9ybWF0KCk7CiAgICAgICAgICAgICAgdGhpcy5zY2hlZHVsZU9iakVuZERhdGUgPSBtb21lbnQudXRjKHRoaXMuc2NoZWR1bGVPYmpTdGFydERhdGUpLmFkZCgzMCwgIm1pbnV0ZXMiKS5mb3JtYXQoKTsKCgogICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlRGF0YS5lbmRUeXBlID09ICJuZXZlciIpIHsKICAgICAgICAgICAgICAgICAgcmVPY3VycmVuY2VSdWxlID0KICAgICAgICAgICAgICAgICAgICAiRlJFUT0iICsKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJUZW1wbGF0ZXNbaV0uZnJlcXVlbmN5VHlwZS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgICAgICAgICAiO0lOVEVSVkFMPSIgKwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5yZXBlYXRFdmVyeSArCiAgICAgICAgICAgICAgICAgICAgIjsiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZW1wbGF0ZURhdGEuZW5kVHlwZSA9PSAib24iKSB7CiAgICAgICAgICAgICAgICAgIGxldCBkYXRlID0gbW9tZW50KHRlbXBsYXRlRGF0YS5lbmREYXRlKS5mb3JtYXQoIllZWVktTU0tREQiKTsKICAgICAgICAgICAgICAgICAgbGV0IHRpbWUgPSBtb21lbnQodGVtcGxhdGVEYXRhLmRlYWRMaW5lRGF0ZSkuZm9ybWF0KAogICAgICAgICAgICAgICAgICAgICJISDptbTpzcyIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgc3RhcnREYXRlID0gZGF0ZSArICJUIiArIHRpbWU7CiAgICAgICAgICAgICAgICAgIGxldCBEYXRlRm9ybWF0U3RyaW5nID0KICAgICAgICAgICAgICAgICAgICBtb21lbnQoc3RhcnREYXRlKS5mb3JtYXQoIllZWVlNTUREVEhIbW1zcyIpOwogICAgICAgICAgICAgICAgICByZU9jdXJyZW5jZVJ1bGUgPQogICAgICAgICAgICAgICAgICAgICJGUkVRPSIgKwogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgICI7SU5URVJWQUw9IiArCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnJlcGVhdEV2ZXJ5ICsKICAgICAgICAgICAgICAgICAgICAiO1VOVElMPSIgKwogICAgICAgICAgICAgICAgICAgIERhdGVGb3JtYXRTdHJpbmcgKwogICAgICAgICAgICAgICAgICAgICI7IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGVEYXRhLmVuZFR5cGUgPT09ICJhZnRlciIpIHsKICAgICAgICAgICAgICAgICAgcmVPY3VycmVuY2VSdWxlID0KICAgICAgICAgICAgICAgICAgICAiRlJFUT0iICsKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJUZW1wbGF0ZXNbaV0uZnJlcXVlbmN5VHlwZS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgICAgICAgICAiO0lOVEVSVkFMPSIgKwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5yZXBlYXRFdmVyeSArCiAgICAgICAgICAgICAgICAgICAgIjtDT1VOVD0iICsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEub2NjdXJyZW5jZSArCiAgICAgICAgICAgICAgICAgICAgIjsiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVPY3VycmVuY2VSdWxlID0gIiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlZHVsZXJUZW1wbGF0ZXNbaV0uZnJlcXVlbmN5VHlwZSA9PSAid2Vla2x5IikgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlZHVsZU9ialN0YXJ0RGF0ZSA9IG1vbWVudAogICAgICAgICAgICAgICAgICAudXRjKHRlbXBsYXRlRGF0YS5zdGFydERhdGUpCiAgICAgICAgICAgICAgICAgIC5mb3JtYXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVPYmpFbmREYXRlID0gbW9tZW50CiAgICAgICAgICAgICAgICAgIC51dGModGhpcy5zY2hlZHVsZU9ialN0YXJ0RGF0ZSkKICAgICAgICAgICAgICAgICAgLmFkZCgzMCwgIm1pbnV0ZXMiKQogICAgICAgICAgICAgICAgICAuZm9ybWF0KCk7CiAgICAgICAgICAgICAgICBsZXQgZnJlRGF5ID0gSlNPTi5wYXJzZSh0ZW1wbGF0ZURhdGEuZnJlcXVlbmN5RGF5cyk7CiAgICAgICAgICAgICAgICBsZXQgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBmcmVEYXkubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZnJlRGF5W2luZGV4XS52YWx1ZS5zbGljZSgwLCAyKTsKICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCBmcmVEYXlzID0gYXJyYXkuam9pbigpOwoKICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLmVuZFR5cGUgPT09ICJuZXZlciIgJiYKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyVGVtcGxhdGVzW2ldLmZyZXF1ZW5jeVR5cGUgPT0gIndlZWtseSIKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICByZU9jdXJyZW5jZVJ1bGUgPQogICAgICAgICAgICAgICAgICAgICJGUkVRPSIgKwogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgICI7SU5URVJWQUw9IiArCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnJlcGVhdEV2ZXJ5ICsKICAgICAgICAgICAgICAgICAgICAiO0JZREFZPSIgKwogICAgICAgICAgICAgICAgICAgIGZyZURheXMgKwogICAgICAgICAgICAgICAgICAgICI7IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5lbmRUeXBlID09PSAib24iICYmCiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlID09ICJ3ZWVrbHkiCiAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgbGV0IGRhdGUgPSBtb21lbnQodGVtcGxhdGVEYXRhLmVuZERhdGUpLmZvcm1hdCgiWVlZWS1NTS1ERCIpOwogICAgICAgICAgICAgICAgICBsZXQgdGltZSA9ICIwMDowMDowMC4wMDArMDA6MDAiOwogICAgICAgICAgICAgICAgICBzdGFydERhdGUgPSBkYXRlICsgIlQiICsgdGltZTsKCiAgICAgICAgICAgICAgICAgIGxldCBEYXRlRm9ybWF0U3RyaW5nID0KICAgICAgICAgICAgICAgICAgICBtb21lbnQoc3RhcnREYXRlKS5mb3JtYXQoIllZWVlNTUREVEhIbW1zcyIpOwogICAgICAgICAgICAgICAgICByZU9jdXJyZW5jZVJ1bGUgPQogICAgICAgICAgICAgICAgICAgICJGUkVRPSIgKwogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgICI7SU5URVJWQUw9IiArCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnJlcGVhdEV2ZXJ5ICsKICAgICAgICAgICAgICAgICAgICAiO1VOVElMPSIgKwogICAgICAgICAgICAgICAgICAgIERhdGVGb3JtYXRTdHJpbmcgKwogICAgICAgICAgICAgICAgICAgICI7QllEQVk9IiArCiAgICAgICAgICAgICAgICAgICAgZnJlRGF5cyArCiAgICAgICAgICAgICAgICAgICAgIjsiOwoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5lbmRUeXBlID09PSAiYWZ0ZXIiICYmCiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlID09ICJ3ZWVrbHkiCiAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgcmVPY3VycmVuY2VSdWxlID0KICAgICAgICAgICAgICAgICAgICAiRlJFUT0iICsKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJUZW1wbGF0ZXNbaV0uZnJlcXVlbmN5VHlwZS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgICAgICAgICAiO0lOVEVSVkFMPSIgKwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5yZXBlYXRFdmVyeSArCiAgICAgICAgICAgICAgICAgICAgIjtDT1VOVD0iICsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEub2NjdXJyZW5jZSArCiAgICAgICAgICAgICAgICAgICAgIjtCWURBWT0iICsKICAgICAgICAgICAgICAgICAgICBmcmVEYXlzICsKICAgICAgICAgICAgICAgICAgICAiOyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlZHVsZXJUZW1wbGF0ZXNbaV0uZnJlcXVlbmN5VHlwZSA9PSAibW9udGhseSIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVPYmpTdGFydERhdGUgPSBtb21lbnQKICAgICAgICAgICAgICAgICAgLnV0Yyh0ZW1wbGF0ZURhdGEuc3RhcnREYXRlKQogICAgICAgICAgICAgICAgICAuZm9ybWF0KCk7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVkdWxlT2JqRW5kRGF0ZSA9IG1vbWVudAogICAgICAgICAgICAgICAgICAudXRjKHRoaXMuc2NoZWR1bGVPYmpTdGFydERhdGUpCiAgICAgICAgICAgICAgICAgIC5hZGQoMzAsICJtaW51dGVzIikKICAgICAgICAgICAgICAgICAgLmZvcm1hdCgpOwoKICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZURhdGEuZW5kVHlwZSA9PT0gIm5ldmVyIikgewogICAgICAgICAgICAgICAgICByZU9jdXJyZW5jZVJ1bGUgPQogICAgICAgICAgICAgICAgICAgICJGUkVRPSIgKwogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgICI7SU5URVJWQUw9IiArCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnJlcGVhdEV2ZXJ5ICsKICAgICAgICAgICAgICAgICAgICAiO0JZTU9OVEhEQVk9IiArCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnJlcGVhdE1vbnRoRGF5ICsKICAgICAgICAgICAgICAgICAgICAiOyI7CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5lbmRUeXBlID09PSAib24iICYmCiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlID09PSAibW9udGhseSIKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICBsZXQgZGF0ZSA9IHRlbXBsYXRlRGF0YS5lbmREYXRlOwogICAgICAgICAgICAgICAgICB2YXIgb2JqRGF0ZSA9IG1vbWVudChkYXRlKS5mb3JtYXQoIllZWVlNTUREIik7CiAgICAgICAgICAgICAgICAgIGxldCBEYXRlRm9ybWF0U3RyaW5nID0gb2JqRGF0ZSArICJUIiArICIwMDAwIiArICIwMFoiOwogICAgICAgICAgICAgICAgICByZU9jdXJyZW5jZVJ1bGUgPQogICAgICAgICAgICAgICAgICAgICJGUkVRPSIgKwogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgICI7SU5URVJWQUw9IiArCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnJlcGVhdEV2ZXJ5ICsKICAgICAgICAgICAgICAgICAgICAiO1VOVElMPSIgKwogICAgICAgICAgICAgICAgICAgIERhdGVGb3JtYXRTdHJpbmcgKwogICAgICAgICAgICAgICAgICAgICI7QllNT05USERBWT0iICsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEucmVwZWF0TW9udGhEYXkgKwogICAgICAgICAgICAgICAgICAgICI7IjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZW1wbGF0ZURhdGEuZW5kVHlwZSA9PT0gImFmdGVyIikgewogICAgICAgICAgICAgICAgICByZU9jdXJyZW5jZVJ1bGUgPSAiRlJFUT0iICtzY2hlZHVsZXJUZW1wbGF0ZXNbaV0uZnJlcXVlbmN5VHlwZS50b1VwcGVyQ2FzZSgpICsiO0lOVEVSVkFMPSIgK3RlbXBsYXRlRGF0YS5yZXBlYXRFdmVyeSsiO0NPVU5UPSIgK3RlbXBsYXRlRGF0YS5vY2N1cnJlbmNlICsiO0JZTU9OVEhEQVk9Iit0ZW1wbGF0ZURhdGEucmVwZWF0TW9udGhEYXkgKyI7IjsKICAgICAgICAgIAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlID09ICJ5ZWFybHkiKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVkdWxlT2JqU3RhcnREYXRlID0gbW9tZW50CiAgICAgICAgICAgICAgICAgIC51dGModGVtcGxhdGVEYXRhLnN0YXJ0RGF0ZSkKICAgICAgICAgICAgICAgICAgLmZvcm1hdCgpOwogICAgICAgICAgICAgICAgdGhpcy5zY2hlZHVsZU9iakVuZERhdGUgPSBtb21lbnQKICAgICAgICAgICAgICAgICAgLnV0Yyh0aGlzLnNjaGVkdWxlT2JqU3RhcnREYXRlKQogICAgICAgICAgICAgICAgICAuYWRkKDMwLCAibWludXRlcyIpCiAgICAgICAgICAgICAgICAgIC5mb3JtYXQoKTsKICAgICAgICAgICAgICAgIGxldCBtb250aE5vID0gSlNPTi5wYXJzZSh0ZW1wbGF0ZURhdGEuZnJlcXVlbmN5RGF5cyk7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbW9udGhOby5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG1vbnRoVmFsdWUgPSBtb250aE5vW2luZGV4XS52YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZURhdGEuZW5kVHlwZSA9PT0gIm5ldmVyIikgewogICAgICAgICAgICAgICAgICAgcmVPY3VycmVuY2VSdWxlID0gIkZSRVE9IiArc2NoZWR1bGVyVGVtcGxhdGVzW2ldLmZyZXF1ZW5jeVR5cGUudG9VcHBlckNhc2UoKSArIjtJTlRFUlZBTD0iICt0ZW1wbGF0ZURhdGEucmVwZWF0RXZlcnkgKyI7QllNT05USERBWT0iICt0ZW1wbGF0ZURhdGEucmVwZWF0TW9udGhEYXkrIjtCWU1PTlRIPSIgK21vbnRoVmFsdWUgKyI7IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5lbmRUeXBlID09PSAib24iICYmCiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclRlbXBsYXRlc1tpXS5mcmVxdWVuY3lUeXBlID09PSAieWVhcmx5IgogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIGxldCBkYXRlID0gdGVtcGxhdGVEYXRhLmVuZERhdGU7CiAgICAgICAgICAgICAgICAgIGxldCBvYmpEYXRlID0gbW9tZW50KGRhdGUpLmZvcm1hdCgiWVlZWU1NREQiKTsKICAgICAgICAgICAgICAgICAgbGV0IERhdGVGb3JtYXRTdHJpbmcgPSBvYmpEYXRlICsgIlQiICsgIjAwMDAiICsgIjAwWiI7CiAgICAgICAgICAgICAgICAgIHJlT2N1cnJlbmNlUnVsZSA9CiAgICAgICAgICAgICAgICAgICAgIkZSRVE9IiArCiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyVGVtcGxhdGVzW2ldLmZyZXF1ZW5jeVR5cGUudG9VcHBlckNhc2UoKSArCiAgICAgICAgICAgICAgICAgICAgIjtJTlRFUlZBTD0iICsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEucmVwZWF0RXZlcnkgKwogICAgICAgICAgICAgICAgICAgICI7VU5USUw9IiArCiAgICAgICAgICAgICAgICAgICAgRGF0ZUZvcm1hdFN0cmluZyArCiAgICAgICAgICAgICAgICAgICAgIjtCWU1PTlRIREFZPSIgKwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5yZXBlYXRNb250aERheSArCiAgICAgICAgICAgICAgICAgICAgIjtCWU1PTlRIPSIgKwogICAgICAgICAgICAgICAgICAgIG1vbnRoVmFsdWUgKwogICAgICAgICAgICAgICAgICAgICI7IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGVEYXRhLmVuZFR5cGUgPT09ICJhZnRlciIpIHsKICAgICAgICAgICAgICAgICAgcmVPY3VycmVuY2VSdWxlID0KICAgICAgICAgICAgICAgICAgICAiRlJFUT0iICsKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJUZW1wbGF0ZXNbaV0uZnJlcXVlbmN5VHlwZS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgICAgICAgICAiO0lOVEVSVkFMPSIgKwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5yZXBlYXRFdmVyeSArCiAgICAgICAgICAgICAgICAgICAgIjtDT1VOVD0iICsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEub2NjdXJyZW5jZSArCiAgICAgICAgICAgICAgICAgICAgIjtCWU1PTlRIREFZPSIgKwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGF0YS5yZXBlYXRNb250aERheSArCiAgICAgICAgICAgICAgICAgICAgIjtCWU1PTlRIPSIgKwogICAgICAgICAgICAgICAgICAgIG1vbnRoVmFsdWUgKwogICAgICAgICAgICAgICAgICAgICI7IjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygic2NoZWR1bGVyVGVtcGxhdGVzW2ldIiwgc2NoZWR1bGVyVGVtcGxhdGVzW2ldKTsKICAgICAgICAgICAgICBsZXQgU2NoZWR1bGVPYmogPSB7CiAgICAgICAgICAgICAgICBpZDogc2NoZWR1bGVyVGVtcGxhdGVzW2ldLmRhdGFVdWlkLAogICAgICAgICAgICAgICAgdGVuYW50VVVJRDogdGhpcy5jdXJyZW50VXNlckRldGFpbHMucHJvZmlsZS5vcmdhbml6YXRpb25JZCwKICAgICAgICAgICAgICAgIFN1YmplY3Q6IHNjaGVkdWxlclRlbXBsYXRlc1tpXS5ldmVudE5hbWUsCiAgICAgICAgICAgICAgICBTdGFydFRpbWU6IG5ldyBEYXRlKHRoaXMuc2NoZWR1bGVPYmpTdGFydERhdGUpLAogICAgICAgICAgICAgICAgRW5kVGltZTogbmV3IERhdGUodGhpcy5zY2hlZHVsZU9iakVuZERhdGUpLAogICAgICAgICAgICAgICAgSXNBbGxEYXk6IGZhbHNlLAogICAgICAgICAgICAgICAgUmVjdXJyZW5jZVJ1bGU6IHJlT2N1cnJlbmNlUnVsZSwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHNjaGVkdWxlRGF0YS5wdXNoKFNjaGVkdWxlT2JqKTsKICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiU2NoZWR1bGVPYmoiLCBTY2hlZHVsZU9iaik7CiAgICAgICAgICAgICAgbGV0IHNjaGVkdWxlT2JqID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlNjaGVkdWxlIikuZWoyX2luc3RhbmNlc1swXTsgCiAgICAgICAgICAgICAgc2NoZWR1bGVPYmouZXZlbnRTZXR0aW5ncy5kYXRhU291cmNlID0gc2NoZWR1bGVEYXRhCgogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVLZXkrKzsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLiRlbWl0KAogICAgICAgICAgICAgICJzaG93VG9hc3QiLAogICAgICAgICAgICAgICJPcHBzIGl0cyBsb29rIGxpa2Ugb3VyIHNlcnZlciBpcyBvZmZsaW5lIiwKICAgICAgICAgICAgICAiZXJyb3IiCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoKGVycm9yKSB7CiAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2UgIT09IHVuZGVmaW5lZCAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwNikgewogICAgICAgICAgICAvLyBhbGVydChlcnJvci5yZXNwb25zZS5kYXRhLmRlc2NyaXB0aW9uKTsKICAgICAgICAgICAgdGhpcy4kZW1pdCgic2hvd1RvYXN0IiwgZXJyb3IucmVzcG9uc2UuZGF0YS5kZXNjcmlwdGlvbiwgImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKICB9LAoKICBjcmVhdGVkKCkgewogICAgdGhpcy5jdXJyZW50VXNlckRldGFpbHMgPSBKU09OLnBhcnNlKAogICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiY3VycmVudFVzZXJEZXRhaWxzIikKICAgICk7CiAgICB0aGlzLnNlbGVjdFVzZXIoKTsKICAgIC8vIHRoaXMuZ2V0UGFnaW5hdGVkSW5zcGVjdGlvblRlbXBsYXRlcygpOwogICAgdGhpcy5HZXRTY2hlZHVsZXJUaWNrZXRzKCk7CiAgICAvL3RoaXMub25BY3Rpb25CZWdpbigpOwogICAgLy90aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAvL3RoaXMuZ2V0QXNzaWdubWVudEhpc3RvcnlCeUFzc2V0KCk7CiAgfSwKfTsK"},null]}