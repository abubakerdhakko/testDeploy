{"remainingRequest":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/babel-loader/lib/index.js!/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/cache-loader/dist/cjs.js??ref--1-0!/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/src/views/assets/CreateAsset.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/src/views/assets/CreateAsset.vue","mtime":1661968702424},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/babel.config.js","mtime":1661968702388},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/alsharqi/Desktop/Deploy Fe-ui/fe-erohal-ui/node_modules/vue-loader/lib/index.js","mtime":1655715099000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1leGNlcHRpb24uc3RhY2suanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5hdC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnNldC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzbmV4dC50eXBlZC1hcnJheS5maW5kLWxhc3QuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lc25leHQudHlwZWQtYXJyYXkuZmluZC1sYXN0LWluZGV4LmpzIjsKaW1wb3J0IHsgQXNzZXRNYW5hZ2VtZW50U2VydmljZSB9IGZyb20gIi4uLy4uL3NlcnZpY2VzL0Fzc2V0TWFuYWdlbWVudFNlcnZpY2UiOwppbXBvcnQgeyBXb3JrT3JkZXJTZXJ2aWNlIH0gZnJvbSAiLi4vLi4vc2VydmljZXMvV29ya09yZGVyU2VydmljZSI7CmltcG9ydCB7IEFzc2V0UGVyc29ubmVsU2VydmljZSB9IGZyb20gIi4uLy4uL3NlcnZpY2VzL0Fzc2V0UGVyc29ubmVsU2VydmljZSI7CmltcG9ydCB7IEluc3BlY3Rpb25TZXJ2aWNlIH0gZnJvbSAiLi4vLi4vc2VydmljZXMvSW5zcGVjdGlvblNlcnZpY2UiOwppbXBvcnQgQXNzaWduVXNlclBvcFVwIGZyb20gIi4vY29tcG9uZW50cy9Bc3NpZ25Vc2VyUG9wVXAiOwppbXBvcnQgQXNzaWdubWVudCBmcm9tICIuL2NvbXBvbmVudHMvQXNzaWdubWVudCI7CmltcG9ydCBTaWRlYmFyIGZyb20gIi4uL2Fzc2V0cy9jb21wb25lbnRzL1NpZGViYXIiOwppbXBvcnQgeyBtYXhMZW5ndGgsIHJlcXVpcmVkIH0gZnJvbSAidnVlbGlkYXRlL2xpYi92YWxpZGF0b3JzIjsKaW1wb3J0IENyZWF0ZUNhdGVnb3J5IGZyb20gIi4uL2Fzc2V0cy9jb21wb25lbnRzL0NyZWF0ZUNhdGVnb3J5IjsKaW1wb3J0IG1vbWVudCBmcm9tICJtb21lbnQiOwppbXBvcnQgeyBGdW5jdGlvbnMgfSBmcm9tICJAL3NoYXJlZC9GdW5jdGlvbnMiOwppbXBvcnQgVW5Bc3NpZ25Vc2VyUG9wVXAgZnJvbSAiLi9jb21wb25lbnRzL1VuQXNzaWduVXNlclBvcFVwIjsKaW1wb3J0IEltcG9ydEV4cG9ydERpYWxvZyBmcm9tICIuLi8uLi9jb21wb25lbnRzL0ltcG9ydEV4cG9ydERpYWxvZy52dWUiOwppbXBvcnQgbG9hZGVyIGZyb20gIkAvY29tcG9uZW50cy9Mb2FkZXIudnVlIjsKZXhwb3J0IGRlZmF1bHQgewogIG5hbWU6ICJjcmVhdGVBc3NldCIsCiAgY29tcG9uZW50czogewogICAgU2lkZWJhciwKICAgIENyZWF0ZUNhdGVnb3J5LAogICAgQXNzaWdubWVudCwKICAgIEFzc2lnblVzZXJQb3BVcCwKICAgIFVuQXNzaWduVXNlclBvcFVwLAogICAgSW1wb3J0RXhwb3J0RGlhbG9nLAogICAgbG9hZGVyCiAgfSwKICBwcm9wczoge30sCgogIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBsb2FkZXJGbGFnOiBmYWxzZSwKICAgICAgdG9hc3RGbGFnOiAwLAogICAgICB0b2FzdE1lc3NhZ2U6ICIiLAogICAgICB0b2FzdFR5cGU6ICIiLAogICAgICBjdXJyZW5jeTogIiIsCiAgICAgIGltcG9ydEV4cG9ydERpYWxvZzogZmFsc2UsCiAgICAgIGFzc2V0T2JqOiB7CiAgICAgICAgaWQ6ICIiLAogICAgICAgIG5hbWU6ICIiLAogICAgICAgIHF1YW50aXR5OiAiIiwKICAgICAgICBtb2RlbE51bWJlcjogIiIsCiAgICAgICAgYXNzZXROdW1iZXI6ICIiLAogICAgICAgIGNhdGVnb3J5VVVJRDogIiIsCiAgICAgICAgaW52ZW50b3J5OiAiIiwKICAgICAgICBtYW51ZmFjdHVyZTogIiIsCiAgICAgICAgd2FycmFudHk6ICIiLAogICAgICAgIHdhcnJhbnR5VW5pdDogIiIsCiAgICAgICAgY29uc3VtcHRpb25Vbml0OiAiIiwKICAgICAgICBwcmltYXJ5VXNhZ2VVbml0OiAiIiwKICAgICAgICBzZWNvbmRhcnlVc2FnZVVuaXQ6ICIiLAogICAgICAgIHB1cmNoYXNlRGF0ZTogbnVsbCwKICAgICAgICBzdGF0dXM6ICIiLAogICAgICAgIGFzc2V0RmllbGRzOiBbXQogICAgICB9LAogICAgICBzZWxlY3RJbnB1dDogMCwKICAgICAgU2hvd1VuUG9wVXA6IGZhbHNlLAogICAgICBpbmRleDogMCwKICAgICAgcG9wdXBJbWFnZTogIiIsCiAgICAgIGltYWdlRGlhbG9nOiBmYWxzZSwKICAgICAgaW1hZ2VWb2ljZXM6IFtdLAogICAgICBjYXRlSW5kZXg6IDAsCiAgICAgIHBhZ2U6IDAsCiAgICAgIHJvd3NQZXJQYWdlOiA1LAogICAgICBhc3NpZ25lZFVzZXJzOiBbXSwKICAgICAgc2VsZWN0ZWRDYXRlZ29yeUlkOiAiIiwKICAgICAgZGlzYWJsZUFkZEJ1dHRvbjogZmFsc2UsCiAgICAgIGRpc2FibGVFZGl0QnV0dG9uOiB0cnVlLAogICAgICBkYXRlOiAiIiwKICAgICAgY2FyZ29EYXRlOiAiIiwKICAgICAgZGVzY3JpcHRpb246ICIiLAogICAgICBjYXRlZ29yeTogIiIsCiAgICAgIEFzc2V0Q2F0ZWdvcnk6IFtdLAogICAgICB2YWx1ZTogIiIsCiAgICAgIGN1cnJlbnRVc2VyRGV0YWlsczogIiIsCiAgICAgIGNhdGVnb3J5UG9wVXA6IGZhbHNlLAogICAgICBjdXN0b21DYXRlZ29yeUZpZWxkczogW10sCiAgICAgIHNlbGVjdEFzc2V0Q2F0ZWdvcnk6ICIiLAogICAgICBhc3NldENhdGVnb3J5VVVJRDogIiIsCiAgICAgIGltYWdlUGF0aDogW10sCiAgICAgIG11bHRpcGFydEF0dGFjaG1lbnRzOiBbXSwKICAgICAgZG9jUGF0aDogW10sCiAgICAgIFNob3dQb3BVcDogZmFsc2UsCiAgICAgIHdhcnJhbnR5VW5pdE9wdGlvbjogW3sKICAgICAgICBsYWJlbDogIlllYXJzIiwKICAgICAgICB2YWx1ZTogIlllYXJzIgogICAgICB9LCB7CiAgICAgICAgbGFiZWw6ICJNb250aHMiLAogICAgICAgIHZhbHVlOiAiTW9udGhzIgogICAgICB9LCB7CiAgICAgICAgbGFiZWw6ICJEYXlzIiwKICAgICAgICB2YWx1ZTogIkRheXMiCiAgICAgIH1dLAogICAgICBvcHRpb25zQm9vbGVhbjogW3sKICAgICAgICBsYWJlbDogIlllcyIsCiAgICAgICAgdmFsdWU6ICJObyIKICAgICAgfSwgewogICAgICAgIGxhYmVsOiAiTk8iLAogICAgICAgIHZhbHVlOiAiTm8iCiAgICAgIH1dLAogICAgICBpbmRleFJlbWluZGVyOiAwLAogICAgICBhc3NldFN0YXR1czogW3sKICAgICAgICBuYW1lOiAiQWN0aXZlIiwKICAgICAgICB2YWx1ZTogIkFjdGl2ZSIKICAgICAgfSwgewogICAgICAgIG5hbWU6ICJJbmFjdGl2ZSIsCiAgICAgICAgdmFsdWU6ICJJbmFjdGl2ZSIKICAgICAgfSwgewogICAgICAgIG5hbWU6ICJPdXQgb2YgU2VydmljZSIsCiAgICAgICAgdmFsdWU6ICJPdXRvZlNlcnZpY2UiCiAgICAgIH0sIHsKICAgICAgICBuYW1lOiAiU3BhcmUiLAogICAgICAgIHZhbHVlOiAiU3BhcmUiCiAgICAgIH0sIHsKICAgICAgICBuYW1lOiAiRXhwaXJlZCAvIGRpc3Bvc2VkIiwKICAgICAgICB2YWx1ZTogIkV4cGlyZWQvZGlzcG9zZWQiCiAgICAgIH0sIHsKICAgICAgICBuYW1lOiAic29sZCIsCiAgICAgICAgdmFsdWU6ICJzb2xkIgogICAgICB9XSwKICAgICAgdmFsdWVFZGl0QXNzaWduOiB7fSwKICAgICAgYXNzZXRJRDogIiIsCiAgICAgIGFzc2lnbm1lbnRIaXN0b3J5VXNlcnM6IFtdLAogICAgICBVc2VyczogW10sCiAgICAgIGFsbFVzZXJzOiBbXSwKICAgICAgY29zdDogIiIsCiAgICAgIGFzc2lnblRhYmxlVmFsdWU6ICIiLAogICAgICBpbWFnZVZvaWNlc0NoZWNrOiBbXSwKICAgICAgaW1wb3J0U3VjY2VzczogZmFsc2UsCiAgICAgIGFzc2V0RGF0YTogW10sCiAgICAgIHVzZXJBc3NpZ25lZDogdHJ1ZSwKICAgICAgc3R5bGVCdXR0b24xOiAibWFyZ2luLWxlZnQ6NXB4OyIsCiAgICAgIHN0eWxlQnV0dG9uMjogIm1hcmdpbi1sZWZ0OjVweDsgcG9pbnRlci1ldmVudHM6IG5vbmUiLAogICAgICBBZGRCeUNhdGVGbGFnOiBmYWxzZSwKICAgICAgYXNzZXRDYXRlSUQ6ICIiCiAgICB9OwogIH0sCgogIG1ldGhvZHM6IHsKICAgIHZhbGlkYXRlRGF0ZShkYXRlLCBmaWVsZCkgewogICAgICBsZXQgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKS5zcGxpdCgiVCIpOwogICAgICBjdXJyZW50RGF0ZSA9IGN1cnJlbnREYXRlWzBdOwoKICAgICAgaWYgKG1vbWVudChkYXRlKS5pc0JlZm9yZShjdXJyZW50RGF0ZSkpIHsKICAgICAgICB0aGlzW2ZpZWxkXSA9ICIiOwogICAgICAgIHJldHVybiB0aGlzLiRzaG93VG9hc3QoInNob3dUb2FzdCIsICJQbGVhc2UgU2VsZWN0IEN1cnJlbnQgRGF0ZSBvciBGdXR1cmUgRGF0ZS4iLCAiZXJyb3IiKTsKICAgICAgfQogICAgfSwKCiAgICBwdXJjaGFzZURhdGVIYW5kbGVyKHZhbHVlKSB7CiAgICAgIGxldCBjdXJyZW50RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgpLnNwbGl0KCJUIik7CiAgICAgIGN1cnJlbnREYXRlID0gY3VycmVudERhdGVbMF07CgogICAgICBpZiAobW9tZW50KGN1cnJlbnREYXRlKS5pc0JlZm9yZSh2YWx1ZSkpIHsKICAgICAgICB0aGlzLmRhdGUgPSAiIjsKICAgICAgICB0aGlzLnNob3dUb2FzdCgiWW91IGNhbiBub3Qgc2VsZWN0IGZ1dHVyZSBkYXRlIGFzIFB1cmNoYXNlIERhdGUiLCAiZXJyb3IiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgcHVyY2hhc2VfZGF0ZSA9IG1vbWVudCh2YWx1ZSk7CiAgICAgICAgcHVyY2hhc2VfZGF0ZSA9IHB1cmNoYXNlX2RhdGUuZm9ybWF0KCJZWVlZLU1NLUREVEhIOk1NOlNTWiIpOwogICAgICAgIHRoaXMuYXNzZXRPYmoucHVyY2hhc2VEYXRlID0gbW9tZW50KHZhbHVlKS5mb3JtYXQoIkRELU1NLVlZWVkiKTsKICAgICAgICB0aGlzLmNhcmdvRGF0ZSA9IHB1cmNoYXNlX2RhdGU7CiAgICAgIH0KICAgIH0sCgogICAgdXBsb2FkQ1NWKCkgewogICAgICB0aGlzLmltcG9ydEV4cG9ydERpYWxvZyA9IHRydWU7CiAgICB9LAoKICAgIGV4cG9ydEV4Y2VsKCkgewogICAgICAvLyBsb2dpYyB0byBleHBvcnQgQXNzZXQgZmlsZQogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICBsZXQgcmVxdWVzdCA9IHsKICAgICAgICBhc3NldEV4Y2VsRGF0YTogdGhpcy5idWlsZEV4cG9ydERhdGFSZXF1ZXN0KCkKICAgICAgfTsKICAgICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS5leHBvcnRFeGNlbEZpbGUocmVxdWVzdCkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHZhciBzYW1wbGVBcnJheSA9IHRoaXMuYmFzZTY0VG9BcnJheUJ1ZmZlcihyZXNwb25zZS5kYXRhLmZpbGUpOwogICAgICAgICAgbGV0IGZpbGVVcmwgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbc2FtcGxlQXJyYXldLCB7CiAgICAgICAgICAgIHR5cGU6ICJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldCIKICAgICAgICAgIH0pKTsKICAgICAgICAgIHZhciBmaWxlTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgICAgIGZpbGVMaW5rLmhyZWYgPSBmaWxlVXJsOwogICAgICAgICAgZmlsZUxpbmsuc2V0QXR0cmlidXRlKCJkb3dubG9hZCIsIHJlc3BvbnNlLmRhdGEuZmlsZU5hbWUpOwogICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmaWxlTGluayk7CiAgICAgICAgICBmaWxlTGluay5jbGljaygpOwogICAgICAgIH0KICAgICAgfSkuY2F0Y2goZXJyb3IgPT4gewogICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTsKICAgICAgfSk7CiAgICB9LAoKICAgIGJhc2U2NFRvQXJyYXlCdWZmZXIoYmFzZTY0KSB7CiAgICAgIHZhciBiaW5hcnlTdHJpbmcgPSB3aW5kb3cuYXRvYihiYXNlNjQpOwogICAgICB2YXIgYmluYXJ5TGVuID0gYmluYXJ5U3RyaW5nLmxlbmd0aDsKICAgICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoYmluYXJ5TGVuKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmluYXJ5TGVuOyBpKyspIHsKICAgICAgICB2YXIgYXNjaWkgPSBiaW5hcnlTdHJpbmcuY2hhckNvZGVBdChpKTsKICAgICAgICBieXRlc1tpXSA9IGFzY2lpOwogICAgICB9CgogICAgICByZXR1cm4gYnl0ZXM7CiAgICB9LAoKICAgIGJ1aWxkRXhwb3J0RGF0YVJlcXVlc3QoKSB7CiAgICAgIGxldCByZXF1ZXN0ID0gewogICAgICAgIG5hbWU6IHRoaXMuYXNzZXRPYmoubmFtZSwKICAgICAgICBjYXRlZ29yeTogdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQuZGlzcGxheSAhPT0gdW5kZWZpbmVkID8gdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQuZGlzcGxheSA6IHRoaXMuc2VsZWN0ZWRDYXRlZ29yeUlkLm5hbWUsCiAgICAgICAgbW9kZWxOdW1iZXI6IHRoaXMuYXNzZXRPYmoubW9kZWxOdW1iZXIsCiAgICAgICAgbWFudWZhY3R1cmVyOiB0aGlzLmFzc2V0T2JqLm1hbnVmYWN0dXJlLAogICAgICAgIHB1cmNoYXNlRGF0ZTogdGhpcy5kYXRlICE9PSBudWxsICYmIHRoaXMuZGF0ZSAhPT0gIiIgPyBtb21lbnQodGhpcy5kYXRlLCAiREQvTU0veXl5eSBoaDptbSBhIikudG9JU09TdHJpbmcoKSA6IG51bGwsCiAgICAgICAgc3RhdHVzOiB0aGlzLmFzc2V0T2JqLnN0YXR1cywKICAgICAgICB3YXJyYW50eVVuaXQ6IHRoaXMuYXNzZXRPYmoud2FycmFudHlVbml0LAogICAgICAgIHdhcnJhbnR5OiB0aGlzLmFzc2V0T2JqLndhcnJhbnR5LAogICAgICAgIHByaW1hcnlVc2FnZVVuaXQ6IHRoaXMuYXNzZXRPYmoucHJpbWFyeVVzYWdlVW5pdCwKICAgICAgICBzZWNvbmRhcnlVc2FnZVVuaXQ6IHRoaXMuYXNzZXRPYmouc2Vjb25kYXJ5VXNhZ2VVbml0LAogICAgICAgIGNvbnN1bXB0aW9uVW5pdDogdGhpcy5hc3NldE9iai5jb25zdW1wdGlvblVuaXQsCiAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuZGVzY3JpcHRpb24sCiAgICAgICAgYWRkaXRpb25hbEZpZWxkczogW10KICAgICAgfTsKICAgICAgdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcy5tYXAoZmllbGQgPT4gewogICAgICAgIHJlcXVlc3QuYWRkaXRpb25hbEZpZWxkcy5wdXNoKHsKICAgICAgICAgIGZpZWxkTGFiZWw6IGZpZWxkLmVsZW1lbnRDb25maWcubGFiZWwsCiAgICAgICAgICBmaWVsZFZhbHVlOiBmaWVsZC52YWx1ZQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICB9LAoKICAgIGltcG9ydEV4Y2VsKHZhbHVlKSB7CiAgICAgIC8vbG9naWMgdG8gaW1wb3J0IEFzc2V0IGZpbGUKICAgICAgaWYgKHZhbHVlLmxhYmVsID09PSAiSW1wb3J0IikgewogICAgICAgIGlmICh2YWx1ZS5maWxlICE9PSBudWxsICYmIHZhbHVlLmZpbGUgIT09ICIiKSB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICAgICAgbGV0IGNhdGVnb3J5ID0gdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQuZGlzcGxheSAhPT0gdW5kZWZpbmVkID8gdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQuZGlzcGxheSA6IHRoaXMuc2VsZWN0ZWRDYXRlZ29yeUlkLm5hbWU7CiAgICAgICAgICBBc3NldE1hbmFnZW1lbnRTZXJ2aWNlLmltcG9ydEV4Y2VsRmlsZSh2YWx1ZS5maWxlLCBjYXRlZ29yeSkudGhlbihyZXNwb3NuZSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb3NuZS5zdGF0dXMgPT09IDIwMCAmJiByZXNwb3NuZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgdGhpcy5hc3NldERhdGEgPSByZXNwb3NuZS5kYXRhLmFzc2V0RXhjZWxEYXRhOwogICAgICAgICAgICAgIHRoaXMuaW1wb3J0U3VjY2VzcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFzc2V0T2JqLm5hbWUgPSB0aGlzLmFzc2V0RGF0YS5uYW1lOwogICAgICAgIHRoaXMuYXNzZXRPYmoubW9kZWxOdW1iZXIgPSB0aGlzLmFzc2V0RGF0YS5tb2RlbE51bWJlcjsKICAgICAgICB0aGlzLmFzc2V0T2JqLm1hbnVmYWN0dXJlID0gdGhpcy5hc3NldERhdGEubWFudWZhY3R1cmVyOwogICAgICAgIHRoaXMuYXNzZXRPYmouc3RhdHVzID0gdGhpcy5hc3NldERhdGEuc3RhdHVzOwogICAgICAgIHRoaXMuYXNzZXRPYmoud2FycmFudHkgPSB0aGlzLmFzc2V0RGF0YS53YXJyYW50eTsKICAgICAgICB0aGlzLmFzc2V0T2JqLndhcnJhbnR5VW5pdCA9IHRoaXMuYXNzZXREYXRhLndhcnJhbnR5VW5pdDsKICAgICAgICB0aGlzLmFzc2V0T2JqLnByaW1hcnlVc2FnZVVuaXQgPSB0aGlzLmFzc2V0RGF0YS5wcmltYXJ5VXNhZ2VVbml0OwogICAgICAgIHRoaXMuYXNzZXRPYmouc2Vjb25kYXJ5VXNhZ2VVbml0ID0gdGhpcy5hc3NldERhdGEuc2Vjb25kYXJ5VXNhZ2VVbml0OwogICAgICAgIHRoaXMuYXNzZXRPYmouY29uc3VtcHRpb25Vbml0ID0gdGhpcy5hc3NldERhdGEuY29uc3VtcHRpb25Vbml0OwogICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSB0aGlzLmFzc2V0RGF0YS5kZXNjcmlwdGlvbjsKICAgICAgICB0aGlzLmRhdGUgPSBtb21lbnQodGhpcy5hc3NldERhdGEucHVyY2hhc2VEYXRlKS5mb3JtYXQoIkRELU1NTS1ZWVlZIik7CiAgICAgICAgdGhpcy5jYXJnb0RhdGUgPSB0aGlzLmFzc2V0RGF0YS5wdXJjaGFzZURhdGU7CiAgICAgICAgbGV0IGZpbmRDYXRlZ29yeSA9IHRoaXMuQXNzZXRDYXRlZ29yeS5maW5kKGNhdGVnb3J5ID0+IGNhdGVnb3J5Lm5hbWUgPT09IHRoaXMuYXNzZXREYXRhLmNhdGVnb3J5KTsKCiAgICAgICAgaWYgKGZpbmRDYXRlZ29yeSAhPT0gdW5kZWZpbmVkICYmIGZpbmRDYXRlZ29yeSAhPT0gbnVsbCAmJiBmaW5kQ2F0ZWdvcnkgIT09ICIiKSB7CiAgICAgICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkgPSBmaW5kQ2F0ZWdvcnk7CiAgICAgICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZCA9IGZpbmRDYXRlZ29yeTsKICAgICAgICAgIHRoaXMuY2F0ZWdvcnkgPSBmaW5kQ2F0ZWdvcnkubmFtZTsKICAgICAgICAgIHRoaXMuY2F0ZUluZGV4Kys7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzLm1hcChmaWVsZCA9PiB7CiAgICAgICAgICBsZXQgZm91bmRGaWVsZCA9IHRoaXMuYXNzZXREYXRhLmFkZGl0aW9uYWxGaWVsZHMuZmluZChmID0+IGYuZmllbGRMYWJlbCA9PT0gZmllbGQuZWxlbWVudENvbmZpZy5sYWJlbCk7CgogICAgICAgICAgaWYgKGZvdW5kRmllbGQgIT09IHVuZGVmaW5lZCAmJiBmb3VuZEZpZWxkICE9PSBudWxsICYmIGZvdW5kRmllbGQgIT09ICIiKSB7CiAgICAgICAgICAgIGlmIChmaWVsZC5lbGVtZW50VHlwZSA9PT0gImlucHV0IikgewogICAgICAgICAgICAgIGZpZWxkLnZhbHVlID0gZm91bmRGaWVsZC5maWVsZFZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpZWxkLmVsZW1lbnRUeXBlID09PSAic2VsZWN0IikgewogICAgICAgICAgICAgIGxldCBvcHRpb25zID0gZmllbGQuZWxlbWVudENvbmZpZy5vcHRpb25zOwogICAgICAgICAgICAgIGxldCB2YWx1ZSA9IG9wdGlvbnMuZmluZCh2ID0+IHYubGFiZWwudHJpbSgpID09PSBmb3VuZEZpZWxkLmZpZWxkVmFsdWUudG9Mb3dlckNhc2UoKS50cmltKCkpOwoKICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gIiIpIHsKICAgICAgICAgICAgICAgIGZpZWxkLnZhbHVlID0gZm91bmRGaWVsZC5maWVsZFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMuc2VsZWN0SW5wdXQrKzsKICAgICAgICB0aGlzLmltcG9ydEV4cG9ydERpYWxvZyA9IGZhbHNlOwogICAgICAgIHRoaXMuaW1wb3J0U3VjY2VzcyA9IGZhbHNlOwogICAgICB9CiAgICB9LAoKICAgIGdldEFzc2V0RGV0YWlscygpIHsKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS5nZXRBc3NldCh0aGlzLmFzc2V0SUQpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIHRoaXMuaW1hZ2VWb2ljZXNDaGVjayA9IHJlc3BvbnNlLmRhdGEuYXNzZXQuYXNzZXRJbWFnZXM7CiAgICAgICAgdGhpcy5hc3NldE9iai5pZCA9IHJlc3BvbnNlLmRhdGEuYXNzZXQuaWQ7CiAgICAgICAgdGhpcy5hc3NldE9iai5uYW1lID0gcmVzcG9uc2UuZGF0YS5hc3NldC5uYW1lOwogICAgICAgIHRoaXMuYXNzZXRPYmouYXNzZXROdW1iZXIgPSByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0TnVtYmVyOwogICAgICAgIGRvY3VtZW50LnRpdGxlID0gdGhpcy5hc3NldE9iai5hc3NldE51bWJlciArICIgfCAiICsgIkVyb2hhbCI7CiAgICAgICAgdGhpcy5hc3NldE9iai5tb2RlbE51bWJlciA9IHJlc3BvbnNlLmRhdGEuYXNzZXQubW9kZWxOdW1iZXI7CiAgICAgICAgdGhpcy5hc3NldE9iai5pbnZlbnRvcnkgPSByZXNwb25zZS5kYXRhLmFzc2V0LmludmVudG9yeTsKICAgICAgICB0aGlzLmFzc2V0T2JqLm1hbnVmYWN0dXJlID0gcmVzcG9uc2UuZGF0YS5hc3NldC5tYW51ZmFjdHVyZTsKICAgICAgICB0aGlzLmFzc2V0T2JqLnN0YXR1cyA9IHJlc3BvbnNlLmRhdGEuYXNzZXQuc3RhdHVzOwogICAgICAgIHRoaXMuYXNzZXRDYXRlZ29yeVVVSUQgPSByZXNwb25zZS5kYXRhLmFzc2V0LmNhdGVnb3J5VVVJRDsKICAgICAgICB0aGlzLmFzc2V0T2JqLndhcnJhbnR5ID0gcmVzcG9uc2UuZGF0YS5hc3NldC53YXJyYW50eS5zcGxpdCgiICIpWzBdOwogICAgICAgIHRoaXMuYXNzZXRPYmoud2FycmFudHlVbml0ID0gcmVzcG9uc2UuZGF0YS5hc3NldC53YXJyYW50eS5zcGxpdCgiICIpWzFdOwogICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSByZXNwb25zZS5kYXRhLmFzc2V0LmRlc2NyaXB0aW9uOwogICAgICAgIHRoaXMuYXNzZXRPYmouY29uc3VtcHRpb25Vbml0ID0gcmVzcG9uc2UuZGF0YS5hc3NldC5jb25zdW1wdGlvblVuaXQ7CiAgICAgICAgdGhpcy5hc3NldE9iai5wcmltYXJ5VXNhZ2VVbml0ID0gcmVzcG9uc2UuZGF0YS5hc3NldC5wcmltYXJ5VXNhZ2VVbml0OwogICAgICAgIHRoaXMuYXNzZXRPYmouc2Vjb25kYXJ5VXNhZ2VVbml0ID0gcmVzcG9uc2UuZGF0YS5hc3NldC5zZWNvbmRhcnlVc2FnZVVuaXQ7CiAgICAgICAgdGhpcy5kYXRlID0gbW9tZW50KHJlc3BvbnNlLmRhdGEuYXNzZXQucHVyY2hhc2VEYXRlKS5mb3JtYXQoIkRELU1NTS1ZWVlZIik7CiAgICAgICAgdGhpcy5hc3NldE9iai5wdXJjaGFzZURhdGUgPSBtb21lbnQocmVzcG9uc2UuZGF0YS5hc3NldC5wdXJjaGFzZURhdGUpLmZvcm1hdCgiREQtTU0tWVlZWSIpOwogICAgICAgIHRoaXMuYXNzZXRPYmouY29zdCA9IHRoaXMuY29zdDsKICAgICAgICB0aGlzLmFzc2V0T2JqLmFzc2V0RmllbGRzID0gcmVzcG9uc2UuZGF0YS5hc3NldC5hc3NldEZpZWxkczsKCiAgICAgICAgaWYgKHRoaXMuYXNzc2V0Q2F0ZWdvcnlVVUlEICE9PSAiIikgewogICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuQXNzZXRDYXRlZ29yeS5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgaWYgKHRoaXMuYXNzZXRDYXRlZ29yeVVVSUQgPT09IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF0udXVpZCkgewogICAgICAgICAgICAgIHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeSA9IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF07CiAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQgPSB0aGlzLkFzc2V0Q2F0ZWdvcnlbaW5kZXhdOwogICAgICAgICAgICAgIHRoaXMuY2F0ZWdvcnkgPSB0aGlzLkFzc2V0Q2F0ZWdvcnlbaW5kZXhdLm5hbWU7CiAgICAgICAgICAgICAgdGhpcy5jYXRlSW5kZXgrKzsKICAgICAgICAgICAgICB0aGlzLmRpc2FibGVBZGRCdXR0b24gPSB0cnVlOwogICAgICAgICAgICAgIHRoaXMuZGlzYWJsZUVkaXRCdXR0b24gPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgIHRoaXMuZ2V0QXNzaWdubWVudEhpc3RvcnlCeUFzc2V0KCk7CiAgICAgICAgbGV0IGNhdGVnb3J5QXNzZXRGaWVsZHMgPSBbXTsKCiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkcyAhPSBudWxsKSB7CiAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCByZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XS50eXBlID09PSAidGV4dCIpIHsKICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdOwogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogImlucHV0IiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgdmFsdWU6IHJlc3BvbnNlLmRhdGEuYXNzZXQuYXNzZXRGaWVsZHNbZmllbGQudXVpZF0gPyB0aGlzLm1hcEZpZWxkVmFsdWVzKHJlc3BvbnNlLmRhdGEuYXNzZXQuYXNzZXRGaWVsZHNbZmllbGQudXVpZF0uZmllbGRWYWx1ZSkgOiAiTm8gdmFsdWUgZm91bmQiLAogICAgICAgICAgICAgICAgICB2YWxpZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgdG91Y2hlZDogZmFsc2UKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKGZpZWxkLm1hbmRhdG9yeSkgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlGaWVsZC52YWxpZGF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2F0ZWdvcnlBc3NldEZpZWxkcy5wdXNoKGNhdGVnb3J5RmllbGQpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGZpZWxkLm9wdGlvbnMuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb25zID0gW107CgogICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9wdGlvbi5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uW2luZGV4XQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsZXQgY2F0ZWdvcnlGaWVsZCA9IHsKICAgICAgICAgICAgICAgICAgaWQ6IGZpZWxkLnV1aWQsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRUeXBlOiAic2VsZWN0IiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJzZWxlY3QiLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdID8gdGhpcy5tYXBGaWVsZFZhbHVlcyhyZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUpIDogIk5vIHZhbHVlIGZvdW5kIiwKICAgICAgICAgICAgICAgICAgdmFsaWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgIHRvdWNoZWQ6IGZhbHNlCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmIChmaWVsZC5tYW5kYXRvcnkpIHsKICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlGaWVsZC52YWxpZGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdLnR5cGUgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb3B0aW9uLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25baW5kZXhdCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogcmVzcG9uc2UuZGF0YS5hc3NldC5hc3NldEZpZWxkc1tmaWVsZC51dWlkXSA/IHRoaXMubWFwRmllbGRWYWx1ZXMocmVzcG9uc2UuZGF0YS5hc3NldC5hc3NldEZpZWxkc1tmaWVsZC51dWlkXS5maWVsZFZhbHVlKSA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XS50eXBlID09PSAiY2FsZW5kZXIiKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSByZXNwb25zZS5kYXRhLmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb24gPSBmaWVsZC5vcHRpb25zLnNwbGl0KCIsIik7CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9ucyA9IFtdOwoKICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvcHRpb24ubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbltpbmRleF0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogImNhbGVuZGVyIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJjYWxlbmRlciIsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgdmFsdWU6IHJlc3BvbnNlLmRhdGEuYXNzZXQuYXNzZXRGaWVsZHNbZmllbGQudXVpZF0gPyB0aGlzLm1hcEZpZWxkVmFsdWVzKHJlc3BvbnNlLmRhdGEuYXNzZXQuYXNzZXRGaWVsZHNbZmllbGQudXVpZF0uZmllbGRWYWx1ZSkgOiAiTm8gdmFsdWUgZm91bmQiLAogICAgICAgICAgICAgICAgICB2YWxpZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgdG91Y2hlZDogZmFsc2UKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKGZpZWxkLm1hbmRhdG9yeSkgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlGaWVsZC52YWxpZGF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2F0ZWdvcnlBc3NldEZpZWxkcy5wdXNoKGNhdGVnb3J5RmllbGQpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gImNhbGVuZGVyIikgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb3B0aW9uLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25baW5kZXhdCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJjYWxlbmRlciIsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRDb25maWc6IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY2FsZW5kZXIiLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdID8gdGhpcy5tYXBGaWVsZFZhbHVlcyhyZXNwb25zZS5kYXRhLmFzc2V0LmFzc2V0RmllbGRzW2ZpZWxkLnV1aWRdLmZpZWxkVmFsdWUpIDogIk5vIHZhbHVlIGZvdW5kIiwKICAgICAgICAgICAgICAgICAgdmFsaWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgIHRvdWNoZWQ6IGZhbHNlCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmIChmaWVsZC5tYW5kYXRvcnkpIHsKICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlGaWVsZC52YWxpZGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhdGVnb3J5QXNzZXRGaWVsZHMucHVzaChjYXRlZ29yeUZpZWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdLnR5cGUgPT09ICJudW1lcmljIikgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gcmVzcG9uc2UuZGF0YS5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb3B0aW9uLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25baW5kZXhdCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJudW1lcmljIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJudW1lcmljIiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogcmVzcG9uc2UuZGF0YS5hc3NldC5hc3NldEZpZWxkc1tmaWVsZC51dWlkXSA/IHRoaXMubWFwRmllbGRWYWx1ZXMocmVzcG9uc2UuZGF0YS5hc3NldC5hc3NldEZpZWxkc1tmaWVsZC51dWlkXS5maWVsZFZhbHVlKSA6ICJObyB2YWx1ZSBmb3VuZCIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2F0ZWdvcnlBc3NldEZpZWxkcy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY2F0ZWdvcnlBc3NldEZpZWxkcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIGlmIChjYXRlZ29yeUFzc2V0RmllbGRzW2luZGV4XS5lbGVtZW50Q29uZmlnLmxhYmVsLmluY2x1ZGVzKCJEaW1lbnNpb24iKSkgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzW2luZGV4XS52YWx1ZSA9IHRoaXMuZGltZW5zaW9uczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuY2F0ZWdvcnlGaWVsZHNSZXNlcnZlID0gY2F0ZWdvcnlBc3NldEZpZWxkczsKICAgICAgICB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzID0gY2F0ZWdvcnlBc3NldEZpZWxkcy5maWx0ZXIoZmllbGRzID0+IGZpZWxkcy5lbGVtZW50Q29uZmlnLmxhYmVsICE9PSAiIyBvZiBXYXNoZXMiKTsKICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgfSk7CiAgICB9LAoKICAgIG1hcEZpZWxkVmFsdWVzKGZpZWxkVmFsdWUpIHsKICAgICAgbGV0IHZhbHVlID0gIk5vIHZhbHVlIGZvdW5kIjsKCiAgICAgIGlmIChmaWVsZFZhbHVlICE9PSB1bmRlZmluZWQgJiYgZmllbGRWYWx1ZSAhPT0gbnVsbCAmJiBmaWVsZFZhbHVlICE9PSAiIikgewogICAgICAgIHZhbHVlID0gSlNPTi5wYXJzZShmaWVsZFZhbHVlKS52YWx1ZXNbMF07CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgZ2V0Q3VycmVuY3koKSB7CiAgICAgIGxldCBjdXJyZW50VXNlckRldGFpbHMgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjdXJyZW50VXNlckRldGFpbHMiKSk7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5nZXRDb21wYW55Q3VycmVuY3koY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIHRoaXMuY3VycmVuY3kgPSByZXNwb25zZS5kYXRhLmN1cnJlbmN5OwogICAgICB9KTsKICAgIH0sCgogICAgZGVsZXRlQXNzZXRJbWFnZShpZCkgewogICAgICBBc3NldE1hbmFnZW1lbnRTZXJ2aWNlLmRlbGV0ZUFzc2V0SW1hZ2UoaWQpLnRoZW4ocmVzID0+IHsKICAgICAgICBpZiAocmVzKSB7CiAgICAgICAgICB0aGlzLmdldEFzc2V0SW1hZ2VzKCk7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiSW1hZ2VzIGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5IiwgInN1Y2Nlc3MiKTsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGUgPT4gewogICAgICAgIHRoaXMuc2hvd1RvYXN0KGUuZGF0YS5kZXNjcmlwdGlvbiwgImVycm9yIik7CiAgICAgIH0pOwogICAgfSwKCiAgICBlZGl0QXNzaWduZWQoaW5kZXgsIHZhbCkgewogICAgICB0aGlzLlNob3dQb3BVcCA9IHRydWU7CiAgICAgIHRoaXMudmFsdWVFZGl0QXNzaWduID0gdmFsOwogICAgICB0aGlzLmluZGV4Kys7CiAgICB9LAoKICAgIHVuQXNzaWduQXNzZXQoaW5kZXgsIHZhbHVlKSB7CiAgICAgIHRoaXMuYXNzaWduVGFibGVWYWx1ZSA9IHZhbHVlOwogICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKCiAgICAgIGlmIChtb21lbnQodmFsdWUuc3RhcnREYXRlKS5mb3JtYXQoKSA+IGN1cnJlbnREYXRlKSB7CiAgICAgICAgdGhpcy5mdXR1cmVkVW5Bc3NpZ25tZW50KHZhbHVlLmFzc2lnbm1lbnRJZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy52YWx1ZUVkaXRBc3NpZ24gPSB2YWx1ZTsKICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgICAgdGhpcy5TaG93VW5Qb3BVcCA9IHRydWU7CiAgICAgICAgdGhpcy51c2VySW5kZXggPSBpbmRleDsKICAgICAgfQogICAgfSwKCiAgICB1cGRhdGVBc3NpZ25Vc2VyKHZhbHVlKSB7CiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CiAgICAgIHZhciBzZWxlY3RlZERhdGUgPSBtb21lbnQodmFsdWUuYXNzaWdubWVudERhdGUpLmZvcm1hdCgiWVlZWS1NTS1ERFRISDpNTTpTU1oiKTsKICAgICAgdmFyIGRhdGVTcGxpdCA9IHNlbGVjdGVkRGF0ZS5zcGxpdCgiVCIpOwogICAgICB2YXIgb2JqRGF0ZSA9IGRhdGVTcGxpdFswXTsKICAgICAgdmFyIHRpbWVTcGxpdCA9IHZhbHVlLmFzc2lnbm1lbnRUaW1lLnNwbGl0KCI6Iik7CiAgICAgIHZhciBob3VyID0gdGltZVNwbGl0WzBdOwogICAgICB2YXIgbWludHMgPSB0aW1lU3BsaXRbMV07CiAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9IG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWludHMgKyAiOiIgKyAiMDArMDU6MDAiOwogICAgICB2YWx1ZS5zdGFydERhdGUgPSBhc3NpZ25tZW50RGF0ZTsKICAgICAgdGhpcy51cGRhdGVDdXJyZW50QXNzaWdubWVudCh2YWx1ZSk7CiAgICB9LAoKICAgIHVwZGF0ZUN1cnJlbnRBc3NpZ25tZW50KHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZS51c2VyLmxlbmd0aCA+IDEpIHsKICAgICAgICB0aGlzLnNob3dUb2FzdCgiU2VsZWN0IG9ubHkgb25lIHVzZXIiLCAiZXJyb3IiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIEluc3BlY3Rpb25TZXJ2aWNlLmdldEluc3BlY3Rpb25UZW1wYWx0ZXNCeUFzc2V0KHRoaXMuYXNzZXRJRCkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PSAyMDApIHsKICAgICAgICAgIGxldCBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0ID0gewogICAgICAgICAgICBhc3NpZ25tZW50SWQ6IHZhbHVlLmFzc2lnbm1lbnRJZCwKICAgICAgICAgICAgYXNzZXRJZDogdGhpcy5hc3NldElELAogICAgICAgICAgICB1c2VySWQ6IHZhbHVlLnVzZXJbMF0udXVpZAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjdXJyZW50RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgpOwoKICAgICAgICAgIGlmICh2YWx1ZS5jdXJyZW50RGF0ZVRpbWUgPT0gdHJ1ZSkgewogICAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0LnN0YXJ0RGF0ZSA9IGN1cnJlbnREYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgVXBkYXRlQXNzZXRBc3NpZ25tZW50UmVxdWVzdC5zdGFydERhdGUgPSB2YWx1ZS5zdGFydERhdGU7CiAgICAgICAgICB9CgogICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmVkaXRBc3NpZ25tZW50UmVjb3JkKFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QpLnRoZW4ocmVzcG9uc2UxID0+IHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlMS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJVc2VyIFVwZGF0ZSBzdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgICAgIHRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgICAgICB0aGlzLlNob3dQb3BVcCA9IGZhbHNlOwogICAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KS5jYXRjaChlcnJvcjEgPT4gewogICAgICAgICAgICBpZiAoZXJyb3IxLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBjcmVhdGVBc3NldCgpIHsKICAgICAgdGhpcy4kdi4kdG91Y2goKTsKCiAgICAgIGlmICh0aGlzLiR2LiRpbnZhbGlkKSB7CiAgICAgICAgdGhpcy5zaG93VG9hc3QoIlBsZWFzZSBmaWxsIGFsbCByZXF1aXJlZCBmaWVsZHMiLCAid2FybmluZyIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5sb2FkZXJGbGFnID0gdHJ1ZTsKICAgICAgbGV0IGFzc2V0T2JqID0gewogICAgICAgIGNhdGVnb3J5SWQ6IHRoaXMuc2VsZWN0ZWRDYXRlZ29yeUlkLnZhbHVlICE9PSB1bmRlZmluZWQgPyB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZC52YWx1ZSA6IHRoaXMuc2VsZWN0ZWRDYXRlZ29yeUlkLnV1aWQsCiAgICAgICAgaW1hZ2VzOiBbXSwKICAgICAgICBkb2N1bWVudHM6IFtdLAogICAgICAgIGFzc2V0OiB7CiAgICAgICAgICAvLwlpZDp0aGlzLmFzc2V0T2JqLmlkLAogICAgICAgICAgdGVuYW50VVVJRDogIiIsCiAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5kZXNjcmlwdGlvbiwKICAgICAgICAgIG5hbWU6IHRoaXMuYXNzZXRPYmoubmFtZSwKICAgICAgICAgIHN0YXR1czogdGhpcy5hc3NldE9iai5zdGF0dXMsCiAgICAgICAgICAvLwlxdWFudGl0eTogdGhpcy5hc3NldE9iai5xdWFudGl0eSwKICAgICAgICAgIG1vZGVsTnVtYmVyOiB0aGlzLmFzc2V0T2JqLm1vZGVsTnVtYmVyLAogICAgICAgICAgLy8JaW52ZW50b3J5OiB0aGlzLmFzc2V0T2JqLmludmVudG9yeSwKICAgICAgICAgIG1hbnVmYWN0dXJlOiB0aGlzLmFzc2V0T2JqLm1hbnVmYWN0dXJlLAogICAgICAgICAgcHVyY2hhc2VEYXRlOiB0aGlzLmNhcmdvRGF0ZSwKICAgICAgICAgIHdhcnJhbnR5OiB0aGlzLmFzc2V0T2JqLndhcnJhbnR5ICsgIiAiICsgdGhpcy5hc3NldE9iai53YXJyYW50eVVuaXQsCiAgICAgICAgICBjb25zdW1wdGlvblVuaXQ6IHRoaXMuYXNzZXRPYmouY29uc3VtcHRpb25Vbml0LAogICAgICAgICAgcHJpbWFyeVVzYWdlVW5pdDogdGhpcy5hc3NldE9iai5wcmltYXJ5VXNhZ2VVbml0LAogICAgICAgICAgc2Vjb25kYXJ5VXNhZ2VVbml0OiB0aGlzLmFzc2V0T2JqLnNlY29uZGFyeVVzYWdlVW5pdCwKICAgICAgICAgIGFzc2V0RmllbGRzOiBbXSwKICAgICAgICAgIGFzc2V0SW1hZ2VzOiBbXSwKICAgICAgICAgIGF0dGFjaG1lbnRzOiBbXQogICAgICAgIH0KICAgICAgfTsKICAgICAgbGV0IGFzc2V0RmllbGRzID0gW107CgogICAgICBpZiAodGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcy5sZW5ndGggIT09IDApIHsKICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGxldCBhc3NldEZpZWxkID0ge307CiAgICAgICAgICBhc3NldEZpZWxkLmZpZWxkVGVtcGxhdGVJZCA9IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5maWVsZFRlbXBsYXRlLnV1aWQ7CiAgICAgICAgICBhc3NldEZpZWxkLmZpZWxkSWQgPSB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzW2luZGV4XS5pZDsKICAgICAgICAgIGFzc2V0RmllbGQuZmllbGRWYWx1ZSA9ICd7InZhbHVlcyI6WyInICsgdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkc1tpbmRleF0udmFsdWUgKyAnIl19JzsKICAgICAgICAgIGFzc2V0RmllbGRzLnB1c2goYXNzZXRGaWVsZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBhc3NldE9iai5hc3NldC50ZW5hbnRVVUlEID0gdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LnRlbmFudFVVSUQgPT0gdW5kZWZpbmVkID8gdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LnRlbmFudHV1aWQgOiB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkudGVuYW50VVVJRCwgYXNzZXRPYmouYXNzZXQuYXNzZXRGaWVsZHMgPSBhc3NldEZpZWxkczsKICAgICAgYXNzZXRPYmouYXNzZXQuYXNzZXRJbWFnZXMgPSB0aGlzLmltYWdlUGF0aDsKICAgICAgYXNzZXRPYmouYXNzZXQuYXR0YWNobWVudHMgPSB0aGlzLmRvY1BhdGg7IC8vCXJldHVybjsKCiAgICAgIGNvbnNvbGUubG9nKCJhc3NldE9iaiIsIGFzc2V0T2JqKTsKICAgICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS5hZGRBc3NldChhc3NldE9iaikudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CgogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJhc3NldHMiLAogICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICB0b2FzdEZsYWc6IHRydWUsCiAgICAgICAgICAgICAgdG9hc3RUeXBlOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgdG9hc3N0TWVzc2FnZTogcmVzcG9uc2UuZGF0YS5kZXNjcmlwdGlvbgogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIlRoZXJlIHdhcyBhIHByb2JsZW0gaW4gYWRkaW5nIGFzc2V0LiBLaW5kbHkgdHJ5IGFnYWluIiwgImVycm9yIik7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJUaGVyZSB3YXMgYSBwcm9ibGVtIGluIGFkZGluZyBhc3NldC4gS2luZGx5IHRyeSBhZ2FpbiIsICJlcnJvciIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIHVwZGF0ZUFzc2V0KCkgewogICAgICB0aGlzLiR2LiR0b3VjaCgpOwoKICAgICAgaWYgKHRoaXMuJHYuJGludmFsaWQpIHsKICAgICAgICB0aGlzLnNob3dUb2FzdCgiUGxlYXNlIGZpbGwgYWxsIHJlcXVpcmVkIGZpZWxkcyIsICJ3YXJuaW5nIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICBsZXQgYXNzZXRPYmogPSB7CiAgICAgICAgY2F0ZWdvcnlJZDogdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQudXVpZCwKICAgICAgICBpbWFnZXM6IG51bGwsCiAgICAgICAgZG9jdW1lbnRzOiBudWxsLAogICAgICAgIGFzc2V0OiB7CiAgICAgICAgICBpZDogdGhpcy5hc3NldE9iai5pZCwKICAgICAgICAgIHRlbmFudFVVSUQ6ICIiLAogICAgICAgICAgZGVzY3JpcHRpb246IHRoaXMuZGVzY3JpcHRpb24sCiAgICAgICAgICBuYW1lOiB0aGlzLmFzc2V0T2JqLm5hbWUsCiAgICAgICAgICB1dWlkOiB0aGlzLmFzc2V0SUQsCiAgICAgICAgICBhc3NldE51bWJlcjogdGhpcy5hc3NldE9iai5hc3NldE51bWJlciwKICAgICAgICAgIGNhdGVnb3J5VVVJRDogdGhpcy5hc3NldE9iai5jYXRlZ29yeVVVSUQsCiAgICAgICAgICBzdGF0dXM6IHRoaXMuYXNzZXRPYmouc3RhdHVzLAogICAgICAgICAgLy8JcXVhbnRpdHk6IHRoaXMuYXNzZXRPYmoucXVhbnRpdHksCiAgICAgICAgICBtb2RlbE51bWJlcjogdGhpcy5hc3NldE9iai5tb2RlbE51bWJlciwKICAgICAgICAgIC8vCWludmVudG9yeTogdGhpcy5hc3NldE9iai5pbnZlbnRvcnksCiAgICAgICAgICBtYW51ZmFjdHVyZTogdGhpcy5hc3NldE9iai5tYW51ZmFjdHVyZSwKICAgICAgICAgIHB1cmNoYXNlRGF0ZTogdGhpcy5jYXJnb0RhdGUsCiAgICAgICAgICB3YXJyYW50eTogdGhpcy5hc3NldE9iai53YXJyYW50eSArICIgIiArIHRoaXMuYXNzZXRPYmoud2FycmFudHlVbml0LAogICAgICAgICAgY29uc3VtcHRpb25Vbml0OiB0aGlzLmFzc2V0T2JqLmNvbnN1bXB0aW9uVW5pdCwKICAgICAgICAgIHByaW1hcnlVc2FnZVVuaXQ6IHRoaXMuYXNzZXRPYmoucHJpbWFyeVVzYWdlVW5pdCwKICAgICAgICAgIHNlY29uZGFyeVVzYWdlVW5pdDogdGhpcy5hc3NldE9iai5zZWNvbmRhcnlVc2FnZVVuaXQsCiAgICAgICAgICBhc3NldEZpZWxkczogW10sCiAgICAgICAgICBhc3NldEltYWdlczogW10sCiAgICAgICAgICBhdHRhY2htZW50czogW10KICAgICAgICB9CiAgICAgIH07CiAgICAgIGxldCBhc3NldEZpZWxkcyA9IFtdOwoKICAgICAgaWYgKHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICBsZXQgYXNzZXRGaWVsZCA9IHt9OwogICAgICAgICAgYXNzZXRGaWVsZC5pZCA9IHRoaXMuYXNzZXRPYmouYXNzZXRGaWVsZHNbdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkc1tpbmRleF0uaWRdLmlkOwogICAgICAgICAgYXNzZXRGaWVsZC51dWlkID0gdGhpcy5hc3NldE9iai5hc3NldEZpZWxkc1t0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzW2luZGV4XS5pZF0udXVpZDsKICAgICAgICAgIGFzc2V0RmllbGQuYXNzZXRVVUlEID0gdGhpcy5hc3NldE9iai5hc3NldEZpZWxkc1t0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzW2luZGV4XS5pZF0uYXNzZXRVVUlEOwogICAgICAgICAgYXNzZXRGaWVsZC5maWVsZFRlbXBsYXRlSWQgPSB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS51dWlkOwogICAgICAgICAgYXNzZXRGaWVsZC5maWVsZElkID0gdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkc1tpbmRleF0uaWQ7CiAgICAgICAgICBhc3NldEZpZWxkLmZpZWxkVmFsdWUgPSAneyJ2YWx1ZXMiOlsiJyArIHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHNbaW5kZXhdLnZhbHVlICsgJyJdfSc7CiAgICAgICAgICBhc3NldEZpZWxkcy5wdXNoKGFzc2V0RmllbGQpOwogICAgICAgIH0KICAgICAgfSAvLyBsZXQgYXNzZXRGaWVsZHMgPSBbXTsKICAgICAgLy8gZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIC8vIAlsZXQgYXNzZXRGaWVsZCA9IHt9OwogICAgICAvLyAJYXNzZXRGaWVsZC5maWVsZFRlbXBsYXRlSWQgPSB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS51dWlkOwogICAgICAvLyAJYXNzZXRGaWVsZC5maWVsZElkID0gdGhpcy5jdXN0b21DYXRlZ29yeUZpZWxkc1tpbmRleF0uaWQ7CiAgICAgIC8vIAlhc3NldEZpZWxkLmZpZWxkVmFsdWUgPSAneyJ2YWx1ZXMiOlsiJyArIHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHNbaW5kZXhdLnZhbHVlICsgJyJdfSc7CiAgICAgIC8vIAlhc3NldEZpZWxkcy5wdXNoKGFzc2V0RmllbGQpOwogICAgICAvLyB9CgoKICAgICAgYXNzZXRPYmouYXNzZXQudGVuYW50VVVJRCA9IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS50ZW5hbnRVVUlELCBhc3NldE9iai5hc3NldC5hc3NldEZpZWxkcyA9IGFzc2V0RmllbGRzOwogICAgICBhc3NldE9iai5hc3NldC5hc3NldEltYWdlcyA9IHRoaXMuaW1hZ2VQYXRoOwogICAgICBhc3NldE9iai5hc3NldC5hdHRhY2htZW50cyA9IHRoaXMuZG9jUGF0aDsgLy8gcmV0dXJuCgogICAgICBBc3NldE1hbmFnZW1lbnRTZXJ2aWNlLmVkaXRBc3NldChhc3NldE9iaikudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CgogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJhc3NldHMiLAogICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICB0b2FzdEZsYWc6IHRydWUsCiAgICAgICAgICAgICAgdG9hc3RUeXBlOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgdG9hc3N0TWVzc2FnZTogIkFzc2V0IHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIlRoZXJlIHdhcyBhIHByb2JsZW0gaW4gYWRkaW5nIGFzc2V0LiBLaW5kbHkgdHJ5IGFnYWluIiwgImVycm9yIik7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJUaGVyZSB3YXMgYSBwcm9ibGVtIGluIGFkZGluZyBhc3NldC4gS2luZGx5IHRyeSBhZ2FpbiIsICJlcnJvciIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIHVuYXNzaWduQXNzZXQoaW5kZXgsIGlkKSB7CiAgICAgIHRoaXMudXNlckluZGV4ID0gaW5kZXg7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS51bmFzc2lnbkFzc2V0KHRoaXMuYXNzZXRJRCwgaWQpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgLy8gZGVidWdnZXI7CiAgICAgICAgICBsZXQgdXNlcnMgPSB0aGlzLmFzc2lnbmVkVXNlcnM7CiAgICAgICAgICBsZXQgaGlzdG9yeVVzZXJzID0gdGhpcy5hc3NpZ25tZW50SGlzdG9yeVVzZXJzOwogICAgICAgICAgbGV0IGhpc3RvcnlBZGRlZCA9IGZhbHNlOyAvLwl0aGlzLmRlbGV0ZU1vZGVsID0gZmFsc2U7CgogICAgICAgICAgaGlzdG9yeVVzZXJzLm1hcChoaXN0b3J5SXRlbSA9PiB7CiAgICAgICAgICAgIGlmIChoaXN0b3J5SXRlbS51dWlkID09PSBpZCkgewogICAgICAgICAgICAgIGhpc3RvcnlJdGVtLnVzZXJFbmRpbmdEYXRlcy5wdXNoKG1vbWVudCgpLmZvcm1hdCgiREQgTU1NIFlZWVkgaGg6bW0gYSIpKTsKICAgICAgICAgICAgICBoaXN0b3J5QWRkZWQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaGlzdG9yeUl0ZW07CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZiAoIWhpc3RvcnlBZGRlZCkgewogICAgICAgICAgICBsZXQgbmV3VXNlciA9IHsKICAgICAgICAgICAgICB1dWlkOiBpZCwKICAgICAgICAgICAgICBuYW1lOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0ubmFtZSwKICAgICAgICAgICAgICB1c2VyRW5kaW5nRGF0ZXM6IFttb21lbnQoKS5mb3JtYXQoIkREIE1NTSBZWVlZIGhoOm1tIGEiKV0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaGlzdG9yeVVzZXJzLnB1c2gobmV3VXNlcik7CiAgICAgICAgICB9CgogICAgICAgICAgdXNlcnMuc3BsaWNlKHRoaXMudXNlckluZGV4LCAxKTsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJVc2VyIFVuLUFzc2lnbmVkIFN1Y2Nlc3NmdWxseSIsICJzdWNjZXNzIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBVbi1Bc3NpZ25pbmcgdGhlIHVzZXIuIFBsZWFzZSB0cnkgYWdhaW4iLCAiZXJyb3IiKTsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHsKICAgICAgICAvLyAgdGhpcy5zZXRTdGF0ZSh7IGxvYWRpbmc6IGZhbHNlfSk7CiAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgVW4tQXNzaWduaW5nIHRoZSB1c2VyLiBQbGVhc2UgdHJ5IGFnYWluIiwgImVycm9yIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBVbi1Bc3NpZ25pbmcgdGhlIHVzZXIuIFBsZWFzZSB0cnkgYWdhaW4iLCAiZXJyb3IiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBhc3NpZ25Vc2VyKHZhbHVlKSB7CiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CgogICAgICBpZiAodGhpcy52YWx1ZSAhPT0gbnVsbCkgewogICAgICAgIHZhciBzZWxlY3RlZERhdGUgPSBtb21lbnQodmFsdWUuYXNzaWdubWVudERhdGUpLmZvcm1hdCgiWVlZWS1NTS1ERFRISDpNTTpTU1oiKTsKICAgICAgICB2YXIgZGF0ZVNwbGl0ID0gc2VsZWN0ZWREYXRlLnNwbGl0KCJUIik7CiAgICAgICAgdmFyIG9iakRhdGUgPSBkYXRlU3BsaXRbMF07CiAgICAgICAgdmFyIHRpbWVTcGxpdCA9IHZhbHVlLmFzc2lnbm1lbnRUaW1lLnNwbGl0KCI6Iik7CiAgICAgICAgdmFyIGhvdXIgPSB0aW1lU3BsaXRbMF07CiAgICAgICAgdmFyIG1pbnRzID0gdGltZVNwbGl0WzFdOwogICAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9IG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWludHMgKyAiOiIgKyAiMDArMDU6MDAiOwogICAgICAgIHZhciBjdXJyZW50RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgpOwoKICAgICAgICBpZiAodmFsdWUuY3VycmVudERhdGVUaW1lID09IHRydWUpIHsKICAgICAgICAgIHZhbHVlLnN0YXJ0RGF0ZSA9IGFzc2lnbm1lbnREYXRlOwogICAgICAgICAgdGhpcy5hc3NpZ25tZW50VXNlckN1cnJlbnREYXRlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKGFzc2lnbm1lbnREYXRlID4gY3VycmVudERhdGUgJiYgdmFsdWUuY3VycmVudERhdGVUaW1lID09IGZhbHNlKSB7CiAgICAgICAgICB2YWx1ZS5zdGFydERhdGUgPSBhc3NpZ25tZW50RGF0ZTsKICAgICAgICAgIHRoaXMuYXNzaWdubWVudFVzZXJMYXRlcih2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmIChhc3NpZ25tZW50RGF0ZSA8IGN1cnJlbnREYXRlKSB7CiAgICAgICAgICB2YWx1ZS5zdGFydERhdGUgPSBhc3NpZ25tZW50RGF0ZTsKICAgICAgICAgIHRoaXMucGFzdEFzc2lnbm1lbnRVc2VyQ3VycmVudERhdGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBwYXN0QXNzaWdubWVudFVzZXJDdXJyZW50RGF0ZSh2YWx1ZSkgewogICAgICBJbnNwZWN0aW9uU2VydmljZS5nZXRJbnNwZWN0aW9uVGVtcGFsdGVzQnlBc3NldCh0aGlzLmFzc2V0SUQpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgLy8JZGVidWdnZXIKICAgICAgICAgIGxldCBhc3NpZ25tZW50UmVjb3JkID0gW107CgogICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZhbHVlLnVzZXIubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIGNvbnN0IHVzZXJJZCA9IHZhbHVlLnVzZXJbaW5kZXhdLnV1aWQ7CiAgICAgICAgICAgIGxldCBvYmogPSB7CiAgICAgICAgICAgICAgYXNzZXRJZDogdGhpcy5hc3NldElELAogICAgICAgICAgICAgIGFzc2V0TWFuYWdlcklkOiB1c2VySWQsCiAgICAgICAgICAgICAgdHlwZTogIiIsCiAgICAgICAgICAgICAgc3RhcnRlZEF0OiB2YWx1ZS5zdGFydERhdGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYXNzaWdubWVudFJlY29yZC5wdXNoKG9iaik7CiAgICAgICAgICB9CgogICAgICAgICAgbGV0IGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QgPSB7fTsKICAgICAgICAgIGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QuaW5zcGVjdGlvblRlbXBsYXRlcyA9IHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgIGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QuYXNzaWdubWVudFJlY29yZCA9IGFzc2lnbm1lbnRSZWNvcmQ7CiAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuYWRkQXNzaWdubWVudFJlY29yZChhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0KS50aGVuKHJlc3BvbnNlMSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZTEuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICB0aGlzLnNlbmROb3RpZmljYXRpb25Ub0Fzc2lnbmVkVXNlck9mQXNzZXRzKGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QpOwogICAgICAgICAgICAgIGxldCB1c2VyZGV0YWlsID0gW107CiAgICAgICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmdldFVzZXJEZXRhaWxCeUFzc2V0SWRBbmRVc2VySWQodGhpcy5hc3NldElELCB2YWx1ZS52YWx1ZSkudGhlbihyZXNwb25zZTIgPT4gewogICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlMi5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLnV1aWQgPSB2YWx1ZS52YWx1ZTsKICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC5uYW1lID0gdmFsdWUuZGlzcGxheTsKICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC5zdGFydERhdGUgPSByZXNwb25zZTIuZGF0YS51c2VyLnN0YXJ0RGF0ZTsKICAgICAgICAgICAgICAgICAgdXNlcmRldGFpbC5jb3VudCA9IHJlc3BvbnNlMi5kYXRhLnVzZXIuY291bnQ7CiAgICAgICAgICAgICAgICAgIHRoaXMuYXNzaWduZWRVc2Vycy5wdXNoKHVzZXJkZXRhaWwpOwogICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiQXNzZXQgQXNzaWduZWQgdG8gdXNlciBTdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgICAgICAgICAgICAgIHRoaXMuU2hvd1BvcFVwID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pLmNhdGNoKGVycm9yMiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IyLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkuY2F0Y2goZXJyb3IxID0+IHsKICAgICAgICAgICAgaWYgKGVycm9yMS5yZXNwb25zZS5zdGF0dXMgPT09IDQwNikgewogICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSkuY2F0Y2goZXJyb3IgPT4gewogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgdW5Bc3NpZ25Vc2VyKHZhbHVlKSB7CiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CiAgICAgIHZhciBjdXJyZW50RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgpOwogICAgICB2YXIgc2VsZWN0ZWREYXRlID0gbW9tZW50KHZhbHVlLmFzc2lnbm1lbnREYXRlKS5mb3JtYXQoIllZWVktTU0tRERUSEg6TU06U1NaIik7CiAgICAgIHZhciBkYXRlU3BsaXQgPSBzZWxlY3RlZERhdGUuc3BsaXQoIlQiKTsKICAgICAgdmFyIG9iakRhdGUgPSBkYXRlU3BsaXRbMF07CiAgICAgIHZhciB0aW1lU3BsaXQgPSB2YWx1ZS5hc3NpZ25tZW50VGltZS5zcGxpdCgiOiIpOwogICAgICB2YXIgaG91ciA9IHRpbWVTcGxpdFswXTsKICAgICAgdmFyIG1pbnRzID0gdGltZVNwbGl0WzFdOwogICAgICB2YXIgYXNzaWdubWVudERhdGUgPSBvYmpEYXRlICsgIlQiICsgaG91ciArICI6IiArIG1pbnRzICsgIjoiICsgIjAwKzA1OjAwIjsKCiAgICAgIGlmIChEYXRlLnBhcnNlKHRoaXMuYXNzaWduVGFibGVWYWx1ZS5zdGFydERhdGUpID4gRGF0ZS5wYXJzZShhc3NpZ25tZW50RGF0ZSkpIHsKICAgICAgICB0aGlzLnNob3dUb2FzdCgiU2VsZWN0IERhdGUgYW5kIHRpbWUgbGF0ZXIgdG8gY3VycmVudCBhc3NpZ25tZW50IGRhdGUgYW5kIHRpbWUuIiwgImVycm9yIik7CiAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodmFsdWUuY3VycmVudERhdGVUaW1lID09IHRydWUpIHsKICAgICAgICBsZXQgRGVsZXRlQXNzaWdubWVudFJlY29yZFJlcXVlc3QgPSB7CiAgICAgICAgICBhc3NldFVVSUQ6IHRoaXMuYXNzZXRJRCwKICAgICAgICAgIHVzZXJVVUlEOiB2YWx1ZS51dWlkLAogICAgICAgICAgZW5kaW5nRGF0ZTogY3VycmVudERhdGUKICAgICAgICB9OwogICAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS51bmFzc2lnbkFzc2V0KERlbGV0ZUFzc2lnbm1lbnRSZWNvcmRSZXF1ZXN0KS50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkge30KCiAgICAgICAgICBsZXQgdXNlcnMgPSB0aGlzLmFzc2lnbmVkVXNlcnM7CiAgICAgICAgICBsZXQgaGlzdG9yeVVzZXJzID0gdGhpcy5hc3NpZ25tZW50SGlzdG9yeVVzZXJzOwogICAgICAgICAgbGV0IGhpc3RvcnlBZGRlZCA9IGZhbHNlOwogICAgICAgICAgaGlzdG9yeVVzZXJzLm1hcChoaXN0b3J5SXRlbSA9PiB7CiAgICAgICAgICAgIGlmIChoaXN0b3J5SXRlbS51dWlkID09PSB2YWx1ZS51dWlkKSB7CiAgICAgICAgICAgICAgaGlzdG9yeUl0ZW0udXNlckVuZGluZ0RhdGVzOwogICAgICAgICAgICAgIGhpc3RvcnlJdGVtLnVzZXJTdGFydERhdGVzOwogICAgICAgICAgICAgIGhpc3RvcnlBZGRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBoaXN0b3J5SXRlbTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmICghaGlzdG9yeUFkZGVkKSB7CiAgICAgICAgICAgIGxldCBuZXdVc2VyID0gewogICAgICAgICAgICAgIHV1aWQ6IHZhbHVlLnV1aWQsCiAgICAgICAgICAgICAgbmFtZTogdXNlcnNbdGhpcy51c2VySW5kZXhdLm5hbWUsCiAgICAgICAgICAgICAgZHVyYXRpb25zOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0uZHVyYXRpb25zLAogICAgICAgICAgICAgIHVzZXJTdGFydERhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlclN0YXJ0RGF0ZXMsCiAgICAgICAgICAgICAgdXNlckVuZGluZ0RhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlckVuZGluZ0RhdGVzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhpc3RvcnlVc2Vycy5wdXNoKG5ld1VzZXIpOwogICAgICAgICAgfQoKICAgICAgICAgIHVzZXJzLnNwbGljZSh0aGlzLnVzZXJJbmRleCwgMSk7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiVXNlciBVbi1Bc3NpZ25lZCBTdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgICAgdGhpcy5nZXRBc3NpZ25tZW50SGlzdG9yeUJ5QXNzZXQoKTsKICAgICAgICAgIHRoaXMuU2hvd1VuUG9wVXAgPSBmYWxzZTsKICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy51c2VyYXM7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUuY3VycmVudERhdGVUaW1lID09IGZhbHNlICYmIGN1cnJlbnREYXRlID4gbW9tZW50KGFzc2lnbm1lbnREYXRlKS5mb3JtYXQoKSkgewogICAgICAgIHNlbGVjdGVkRGF0ZSA9IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KCJZWVlZLU1NLUREVEhIOk1NOlNTWiIpOwogICAgICAgIGRhdGVTcGxpdCA9IHNlbGVjdGVkRGF0ZS5zcGxpdCgiVCIpOwogICAgICAgIG9iakRhdGUgPSBkYXRlU3BsaXRbMF07CiAgICAgICAgdGltZVNwbGl0ID0gdmFsdWUuYXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgICBob3VyID0gdGltZVNwbGl0WzBdOwogICAgICAgIG1pbnRzID0gdGltZVNwbGl0WzFdOwogICAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9IG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWludHMgKyAiOiIgKyAiMDArMDU6MDAiOwogICAgICAgIGxldCBEZWxldGVBc3NpZ25tZW50UmVjb3JkUmVxdWVzdCA9IHsKICAgICAgICAgIGFzc2V0VVVJRDogdGhpcy5hc3NldElELAogICAgICAgICAgdXNlclVVSUQ6IHZhbHVlLnV1aWQsCiAgICAgICAgICBlbmRpbmdEYXRlOiBtb21lbnQoYXNzaWdubWVudERhdGUpLmZvcm1hdCgpCiAgICAgICAgfTsgLy8JcmV0dXJuOwoKICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UudW5hc3NpZ25Bc3NldChEZWxldGVBc3NpZ25tZW50UmVjb3JkUmVxdWVzdCkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHt9CgogICAgICAgICAgbGV0IHVzZXJzID0gdGhpcy5hc3NpZ25lZFVzZXJzOwogICAgICAgICAgbGV0IGhpc3RvcnlVc2VycyA9IHRoaXMuYXNzaWdubWVudEhpc3RvcnlVc2VyczsKICAgICAgICAgIGxldCBoaXN0b3J5QWRkZWQgPSBmYWxzZTsgLy9yZXR1cm47CgogICAgICAgICAgaGlzdG9yeVVzZXJzLm1hcChoaXN0b3J5SXRlbSA9PiB7CiAgICAgICAgICAgIGlmIChoaXN0b3J5SXRlbS51dWlkID09PSB2YWx1ZS51dWlkKSB7CiAgICAgICAgICAgICAgaGlzdG9yeUl0ZW0udXNlckVuZGluZ0RhdGVzOwogICAgICAgICAgICAgIGhpc3RvcnlJdGVtLnVzZXJTdGFydERhdGVzOwogICAgICAgICAgICAgIGhpc3RvcnlBZGRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBoaXN0b3J5SXRlbTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmICghaGlzdG9yeUFkZGVkKSB7CiAgICAgICAgICAgIGxldCBuZXdVc2VyID0gewogICAgICAgICAgICAgIHV1aWQ6IHZhbHVlLnV1aWQsCiAgICAgICAgICAgICAgbmFtZTogdXNlcnNbdGhpcy51c2VySW5kZXhdLm5hbWUsCiAgICAgICAgICAgICAgZHVyYXRpb25zOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0uZHVyYXRpb25zLAogICAgICAgICAgICAgIHVzZXJTdGFydERhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlclN0YXJ0RGF0ZXMsCiAgICAgICAgICAgICAgdXNlckVuZGluZ0RhdGVzOiB1c2Vyc1t0aGlzLnVzZXJJbmRleF0udXNlckVuZGluZ0RhdGVzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhpc3RvcnlVc2Vycy5wdXNoKG5ld1VzZXIpOwogICAgICAgICAgfQoKICAgICAgICAgIHVzZXJzLnNwbGljZSh0aGlzLnVzZXJJbmRleCwgMSk7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiVXNlciBVbi1Bc3NpZ25lZCBTdWNjZXNzZnVsbHkiLCAic3VjY2VzcyIpOwogICAgICAgICAgdGhpcy5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCgpOwogICAgICAgICAgdGhpcy5nZXRBc3NpZ25tZW50SGlzdG9yeUJ5QXNzZXQoKTsKICAgICAgICAgIHRoaXMuU2hvd1VuUG9wVXAgPSBmYWxzZTsKICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy51c2VyYXM7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoY3VycmVudERhdGUgPCBtb21lbnQoYXNzaWdubWVudERhdGUpLmZvcm1hdCgpICYmIHZhbHVlLmN1cnJlbnREYXRlVGltZSA9PSBmYWxzZSkgewogICAgICAgIHNlbGVjdGVkRGF0ZSA9IG1vbWVudCh2YWx1ZS5hc3NpZ25tZW50RGF0ZSkuZm9ybWF0KCJZWVlZLU1NLUREVEhIOk1NOlNTWiIpOwogICAgICAgIGRhdGVTcGxpdCA9IHNlbGVjdGVkRGF0ZS5zcGxpdCgiVCIpOwogICAgICAgIG9iakRhdGUgPSBkYXRlU3BsaXRbMF07CiAgICAgICAgdGltZVNwbGl0ID0gdmFsdWUuYXNzaWdubWVudFRpbWUuc3BsaXQoIjoiKTsKICAgICAgICBob3VyID0gdGltZVNwbGl0WzBdOwogICAgICAgIG1pbnRzID0gdGltZVNwbGl0WzFdOwogICAgICAgIGxldCBhc3NpZ25tZW50RGF0ZSA9IG9iakRhdGUgKyAiVCIgKyBob3VyICsgIjoiICsgbWludHMgKyAiOiIgKyAiMDArMDU6MDAiOwogICAgICAgIHZhbHVlLnN0YXJ0RGF0ZSA9IGFzc2lnbm1lbnREYXRlOwogICAgICAgIHRoaXMudW5Bc3NpZ25tZW50VXNlckxhdGVyKHZhbHVlKTsKICAgICAgfQogICAgfSwKCiAgICB1bkFzc2lnbm1lbnRVc2VyTGF0ZXIodmFsdWUpIHsKICAgICAgSW5zcGVjdGlvblNlcnZpY2UuZ2V0SW5zcGVjdGlvblRlbXBhbHRlc0J5QXNzZXQodGhpcy5hc3NldElEKS50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgIGxldCBwb3N0QXNzaWdubWVudCA9IFtdOwogICAgICAgICAgbGV0IG9iaiA9IHsKICAgICAgICAgICAgYXNzaWdubWVudFVVSUQ6IHZhbHVlLmFzc2lnbm1lbnRVVUlELAogICAgICAgICAgICBhc3NldElkOiB0aGlzLmFzc2V0SUQsCiAgICAgICAgICAgIHVzZXJJZDogdmFsdWUudXVpZCwKICAgICAgICAgICAgYXNzaWduOiBmYWxzZSwKICAgICAgICAgICAgZW5kRGF0ZTogdmFsdWUuc3RhcnREYXRlCiAgICAgICAgICB9OwogICAgICAgICAgcG9zdEFzc2lnbm1lbnQucHVzaChvYmopOwogICAgICAgICAgbGV0IFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QgPSB7fTsKICAgICAgICAgIFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QuaW5zcGVjdGlvblRlbXBsYXRlcyA9IHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgIFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QucG9zdEFzc2lnbm1lbnQgPSBwb3N0QXNzaWdubWVudDsKICAgICAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5hZGRQb3N0QXNzaWdubWVudE9yVW5Bc3NpZ25tZW50KFVwZGF0ZUFzc2V0QXNzaWdubWVudFJlcXVlc3QpLnRoZW4ocmVzID0+IHsKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QocmVzLmRhdGEuZGVzY3JpcHRpb24sICJzdWNjZXNzIik7CiAgICAgICAgICAgIHRoaXMuU2hvd1VuUG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgICAgdGhpcy5nZXRBc3NpZ25tZW50SGlzdG9yeUJ5QXNzZXQoKTsKICAgICAgICAgIH0pLmNhdGNoKGUgPT4gewogICAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGUgPT4gewogICAgICAgIGNvbnNvbGUubG9nKCJlcnJvciIsIGUpOwogICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICB9KTsKICAgIH0sCgogICAgYXNzaWdubWVudFVzZXJMYXRlcih2YWx1ZSkgewogICAgICBJbnNwZWN0aW9uU2VydmljZS5nZXRJbnNwZWN0aW9uVGVtcGFsdGVzQnlBc3NldCh0aGlzLmFzc2V0SUQpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgbGV0IHBvc3RBc3NpZ25tZW50ID0gW107CgogICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZhbHVlLnVzZXIubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIGNvbnN0IHVzZXJJZCA9IHZhbHVlLnVzZXJbaW5kZXhdLnV1aWQ7CiAgICAgICAgICAgIGxldCBvYmogPSB7CiAgICAgICAgICAgICAgYXNzaWdubWVudFVVSUQ6ICIiLAogICAgICAgICAgICAgIGFzc2V0SWQ6IHRoaXMuYXNzZXRJRCwKICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCwKICAgICAgICAgICAgICBhc3NpZ246IHRydWUsCiAgICAgICAgICAgICAgc3RhcnREYXRlOiB2YWx1ZS5zdGFydERhdGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcG9zdEFzc2lnbm1lbnQucHVzaChvYmopOwogICAgICAgICAgfQoKICAgICAgICAgIGxldCBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0ID0ge307CiAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0Lmluc3BlY3Rpb25UZW1wbGF0ZXMgPSByZXNwb25zZS5kYXRhLmluc3BlY3Rpb25UZW1wbGF0ZXM7CiAgICAgICAgICBVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0LnBvc3RBc3NpZ25tZW50ID0gcG9zdEFzc2lnbm1lbnQ7CiAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuYWRkUG9zdEFzc2lnbm1lbnRPclVuQXNzaWdubWVudChVcGRhdGVBc3NldEFzc2lnbm1lbnRSZXF1ZXN0KS50aGVuKHJlcyA9PiB7CiAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KHJlcy5kYXRhLmRlc2NyaXB0aW9uLCAic3VjY2VzcyIpOwogICAgICAgICAgICB0aGlzLlNob3dQb3BVcCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgY29uc29sZS5sb2coImVycm9yIiwgZSk7CiAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgIH0pOwogICAgfSwKCiAgICBzZW5kTm90aWZpY2F0aW9uVG9Bc3NpZ25lZFVzZXJPZkFzc2V0cyhhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0KSB7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5zZW5kTm90aWZpY2F0aW9uVG9Bc3NpZ25lZFVzZXJzKGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkge30KICAgICAgfSkuY2F0Y2goZXJyb3IgPT4gewogICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTsKICAgICAgfSk7CiAgICB9LAoKICAgIGFzc2lnbm1lbnRVc2VyQ3VycmVudERhdGUodmFsdWUpIHsKICAgICAgSW5zcGVjdGlvblNlcnZpY2UuZ2V0SW5zcGVjdGlvblRlbXBhbHRlc0J5QXNzZXQodGhpcy5hc3NldElEKS50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICB2YXIgY3VycmVudERhdGUgPSBtb21lbnQoKS5mb3JtYXQoKTsKCiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICBsZXQgYXNzaWdubWVudFJlY29yZCA9IFtdOwoKICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2YWx1ZS51c2VyLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBjb25zdCB1c2VySWQgPSB2YWx1ZS51c2VyW2luZGV4XS51dWlkOwogICAgICAgICAgICBsZXQgb2JqID0gewogICAgICAgICAgICAgIGFzc2V0SWQ6IHRoaXMuYXNzZXRJRCwKICAgICAgICAgICAgICBhc3NldE1hbmFnZXJJZDogdXNlcklkLAogICAgICAgICAgICAgIHR5cGU6ICIiLAogICAgICAgICAgICAgIHN0YXJ0ZWRBdDogY3VycmVudERhdGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYXNzaWdubWVudFJlY29yZC5wdXNoKG9iaik7CiAgICAgICAgICB9CgogICAgICAgICAgbGV0IGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QgPSB7fTsKICAgICAgICAgIGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QuaW5zcGVjdGlvblRlbXBsYXRlcyA9IHJlc3BvbnNlLmRhdGEuaW5zcGVjdGlvblRlbXBsYXRlczsKICAgICAgICAgIGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QuYXNzaWdubWVudFJlY29yZCA9IGFzc2lnbm1lbnRSZWNvcmQ7CiAgICAgICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuYWRkQXNzaWdubWVudFJlY29yZChhZGRBc3NldEFzc2lnbm1lbnRSZXF1ZXN0KS50aGVuKHJlc3BvbnNlMSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZTEuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICB0aGlzLnNlbmROb3RpZmljYXRpb25Ub0Fzc2lnbmVkVXNlck9mQXNzZXRzKGFkZEFzc2V0QXNzaWdubWVudFJlcXVlc3QpOwogICAgICAgICAgICAgIGxldCB1c2VyZGV0YWlsID0gW107CiAgICAgICAgICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmdldFVzZXJEZXRhaWxCeUFzc2V0SWRBbmRVc2VySWQodGhpcy5hc3NldFV1aWQsIHZhbHVlLnZhbHVlKS50aGVuKHJlc3BvbnNlMiA9PiB7CiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UyLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgIHVzZXJkZXRhaWwudXVpZCA9IHZhbHVlLnZhbHVlOwogICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLm5hbWUgPSB2YWx1ZS5kaXNwbGF5OwogICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLnN0YXJ0RGF0ZSA9IHJlc3BvbnNlMi5kYXRhLnVzZXIuc3RhcnREYXRlOwogICAgICAgICAgICAgICAgICB1c2VyZGV0YWlsLmNvdW50ID0gcmVzcG9uc2UyLmRhdGEudXNlci5jb3VudDsKICAgICAgICAgICAgICAgICAgdGhpcy5hc3NpZ25lZFVzZXJzLnB1c2godXNlcmRldGFpbCk7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJBc3NldCBBc3NpZ25lZCB0byB1c2VyIFN1Y2Nlc3NmdWxseSIsICJzdWNjZXNzIik7CiAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgICAgICAgICAgICAgdGhpcy5TaG93UG9wVXAgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyb3IyID0+IHsKICAgICAgICAgICAgICAgIGlmIChlcnJvcjIucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KS5jYXRjaChlcnJvcjEgPT4gewogICAgICAgICAgICBpZiAoZXJyb3IxLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkVycm9yIHdoaWxlIGFzc2lnbmluZyB1c2VyIHRvIHRoZSBhc3NldCIsICJlcnJvciIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aGlzLnNob3dUb2FzdCgiRXJyb3Igd2hpbGUgYXNzaWduaW5nIHVzZXIgdG8gdGhlIGFzc2V0IiwgImVycm9yIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJFcnJvciB3aGlsZSBhc3NpZ25pbmcgdXNlciB0byB0aGUgYXNzZXQiLCAiZXJyb3IiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBnZXRBc3NpZ25tZW50SGlzdG9yeUJ5QXNzZXQoKSB7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5nZXRBc3NpZ25tZW50SGlzdG9yeUJ5QXNzZXQodGhpcy5hc3NldElELCB0aGlzLnBhZ2UsIHRoaXMucm93c1BlclBhZ2UpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgbGV0IHVzZXJzID0gW107CgogICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJlc3BvbnNlLmRhdGEuZGV0YWlscy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgbGV0IG9iaiA9IHt9OwogICAgICAgICAgICBvYmoubmFtZSA9IHJlc3BvbnNlLmRhdGEuZGV0YWlsc1tpbmRleF0ubmFtZTsKICAgICAgICAgICAgb2JqLmNvdW50ID0gcmVzcG9uc2UuZGF0YS5kZXRhaWxzW2luZGV4XS5jb3VudDsKICAgICAgICAgICAgb2JqLnVzZXJTdGFydERhdGVzID0gbW9tZW50KHJlc3BvbnNlLmRhdGEuZGV0YWlsc1tpbmRleF0uc3RhcnREYXRlKS5mb3JtYXQoIkREIE1NTSBZWVlZIGhoOm1tIGEiKTsKICAgICAgICAgICAgb2JqLnVzZXJFbmRpbmdEYXRlcyA9IG1vbWVudChyZXNwb25zZS5kYXRhLmRldGFpbHNbaW5kZXhdLmVuZERhdGUpLmZvcm1hdCgiREQgTU1NIFlZWVkgaGg6bW0gYSIpOwogICAgICAgICAgICBvYmoudXVpZCA9IHJlc3BvbnNlLmRhdGEuZGV0YWlsc1tpbmRleF0udXVpZDsKICAgICAgICAgICAgb2JqLmR1cmF0aW9ucyA9IHJlc3BvbnNlLmRhdGEuZGV0YWlsc1tpbmRleF0uZHVyYXRpb247CiAgICAgICAgICAgIG9iai5zdGF0dXMgPSByZXNwb25zZS5kYXRhLmRldGFpbHNbaW5kZXhdLnN0YXR1czsKICAgICAgICAgICAgdXNlcnMucHVzaChvYmopOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuYXNzaWdubWVudEhpc3RvcnlVc2VycyA9IHVzZXJzOwogICAgICAgICAgdGhpcy5hc3NpZ25tZW50SGlzdG9yeVVzZXJzLnRvdGFsUGFnZXMgPSByZXNwb25zZS5kYXRhLnRvdGFsUGFnZXM7CiAgICAgICAgICB0aGlzLmFzc2lnbm1lbnRIaXN0b3J5VXNlcnMudG90YWxFbGVtZW50cyA9IHJlc3BvbnNlLmRhdGEudG90YWxFbGVtZW50czsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHsKICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJPcHBzIGl0cyBsb29rIGxpa2Ugb3VyIHNlcnZlciBpcyBvZmZsaW5lIiwgImVycm9yIik7CiAgICAgICAgfSAvLyAgIHRoaXMuc2V0U3RhdGUoeyBsb2FkaW5nOiBmYWxzZX0pOwogICAgICAgIGVsc2UgewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIk9wcHMgaXRzIGxvb2sgbGlrZSBvdXIgc2VydmVyIGlzIG9mZmxpbmUiLCAiZXJyb3IiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBmdXR1cmVkVW5Bc3NpZ25tZW50KHV1aWQpIHsKICAgICAgQXNzZXRQZXJzb25uZWxTZXJ2aWNlLmRlbGV0ZVBvc3RBc3NpZ25tZW50QnlVVUlEKHV1aWQpLnRoZW4ocmVzID0+IHsKICAgICAgICB0aGlzLnNob3dUb2FzdChyZXMuZGF0YS5kZXNjcmlwdGlvbiwgInN1Y2Nlc3MiKTsKICAgICAgICB0aGlzLmdldEFzc2lnbmVkVXNlcnNPZkFzc2V0KCk7CiAgICAgIH0pLmNhdGNoKGUgPT4gewogICAgICAgIHRoaXMuc2hvd1RvYXN0KGUuZGF0YS5kZXNjcmlwdGlvbiwgImVycm9yIik7CiAgICAgIH0pOwogICAgfSwKCiAgICBzZWxlY3RVc2VyKCkgewogICAgICBsZXQgY3VycmVudFVzZXJEZXRhaWxzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiY3VycmVudFVzZXJEZXRhaWxzIikpOwogICAgICBBc3NldFBlcnNvbm5lbFNlcnZpY2UuZ2V0QWxsVXNlcnMoY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGxldCB1c2VycyA9IFtdOwoKICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVzcG9uc2UuZGF0YS51c2Vycy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGxldCB1c2VyID0ge307CiAgICAgICAgICB1c2VyLmxhYmVsID0gcmVzcG9uc2UuZGF0YS51c2Vyc1tpbmRleF0ubmFtZTsKICAgICAgICAgIHVzZXIudmFsdWUgPSByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5uYW1lOwogICAgICAgICAgdXNlci51dWlkID0gcmVzcG9uc2UuZGF0YS51c2Vyc1tpbmRleF0udXVpZDsKICAgICAgICAgIHVzZXIubmFtZSA9IHJlc3BvbnNlLmRhdGEudXNlcnNbaW5kZXhdLm5hbWU7CiAgICAgICAgICB1c2Vycy5wdXNoKHVzZXIpOwogICAgICAgICAgdGhpcy5hbGxVc2Vycy5wdXNoKHsKICAgICAgICAgICAgZmlyc3ROYW1lOiByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5maXJzdE5hbWUsCiAgICAgICAgICAgIGxhc3ROYW1lOiByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5sYXN0TmFtZSwKICAgICAgICAgICAgcHJvZmlsZUltYWdlOiByZXNwb25zZS5kYXRhLnVzZXJzW2luZGV4XS5pbWFnZVVybCwKICAgICAgICAgICAgdXVpZDogcmVzcG9uc2UuZGF0YS51c2Vyc1tpbmRleF0udXVpZAogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLlVzZXJzID0gdXNlcnM7CiAgICAgIH0pLmNhdGNoKGUgPT4gewogICAgICAgIHRoaXMuc2hvd1RvYXN0KCJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBmZXRjaGluZyB0aGUgdXNlcnMiLCAiZXJyb3IiKTsKICAgICAgfSk7CiAgICB9LAoKICAgIHNob3dBc3NpZ25Qb3BVcCgpIHsKICAgICAgdGhpcy5TaG93UG9wVXAgPSB0cnVlOwogICAgfSwKCiAgICBvcGVuUG9wVXAoKSB7CiAgICAgIHRoaXMuY2F0ZWdvcnlQb3BVcCA9IHRydWU7CiAgICB9LAoKICAgIGNsb3NlKCkgewogICAgICB0aGlzLmNhdGVnb3J5UG9wVXAgPSBmYWxzZTsKICAgICAgdGhpcy5TaG93UG9wVXAgPSBmYWxzZTsKICAgICAgdGhpcy5pbWFnZURpYWxvZyA9IGZhbHNlOwogICAgICB0aGlzLlNob3dVblBvcFVwID0gZmFsc2U7CiAgICAgIHRoaXMuaW1wb3J0RXhwb3J0RGlhbG9nID0gZmFsc2U7CiAgICAgIHRoaXMuaW1wb3J0U3VjY2VzcyA9IGZhbHNlOwogICAgfSwKCiAgICBmdWxsc2NyZWVuSW1hZ2UodmFsdWUpIHsKICAgICAgdGhpcy5wb3B1cEltYWdlID0gdmFsdWU7CiAgICAgIHRoaXMuaW1hZ2VEaWFsb2cgPSB0cnVlOwogICAgfSwKCiAgICBvblNlbGVjdGVkKHZhbHVlKSB7Ly8gY29uc29sZS5sb2coInNlbGV0ZWQgdmFsdWUiLCB2YWx1ZSk7CiAgICB9LAoKICAgIGNsZWFyU2VsZWN0ZWRTdGF0dXMoKSB7CiAgICAgIHRoaXMuYXNzZXRPYmouc3RhdHVzID0gIiI7CiAgICAgIHRoaXMuY2F0ZUluZGV4Kys7CiAgICB9LAoKICAgIGNsZWFyU2VsZWN0ZWRXYXJyYW50eVVuaXQoKSB7CiAgICAgIHRoaXMuYXNzZXRPYmoud2FycmFudHlVbml0ID0gIiI7CiAgICAgIHRoaXMuY2F0ZUluZGV4Kys7CiAgICB9LAoKICAgIHNhdmVBZGRDYXRlZ29yeSh2YWx1ZSkgewogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwogICAgICBsZXQgYWRkQ2F0ZWdvcnkgPSB7CiAgICAgICAgY2F0ZWdvcnk6IHsKICAgICAgICAgIG5hbWU6IHZhbHVlLmNhdGVnb3J5TmFtZSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiB2YWx1ZS5tZXNzYWdlQm94LAogICAgICAgICAgdGVuYW50VVVJRDogdGhpcy5jdXJyZW50VXNlckRldGFpbHMucHJvZmlsZS5vcmdhbml6YXRpb25JZCwKICAgICAgICAgIGZpZWxkVGVtcGxhdGU6IHsKICAgICAgICAgICAgdHlwZTogdmFsdWUuY2F0ZWdvcnlOYW1lICsgIiBmaWVsZCB0ZW1wbGF0ZSIsCiAgICAgICAgICAgIHRlbmFudFVVSUQ6IHRoaXMuY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQsCiAgICAgICAgICAgIGZpZWxkczogW10KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIGxldCBmaWVsZHMgPSBbXTsKCiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2YWx1ZS5jYXRlZ29yeUZpZWxkcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICBsZXQgYWRkQ2F0ZWdvcnlGaWVsZCA9IHZhbHVlLmNhdGVnb3J5RmllbGRzW2luZGV4XTsKICAgICAgICBsZXQgZmllbGQgPSB7fTsKICAgICAgICBmaWVsZC5sYWJlbCA9IGFkZENhdGVnb3J5RmllbGQubGFiZWw7CiAgICAgICAgZmllbGQudHlwZSA9IGFkZENhdGVnb3J5RmllbGQudHlwZTsKICAgICAgICBmaWVsZC5maWVsZFBvc2l0aW9uID0gYWRkQ2F0ZWdvcnlGaWVsZC5wb3NpdGlvbjsKICAgICAgICBmaWVsZC5tYW5kYXRvcnkgPSBhZGRDYXRlZ29yeUZpZWxkLm1hbmRhdG9yeTsKICAgICAgICBmaWVsZC5vcHRpb25zID0gYWRkQ2F0ZWdvcnlGaWVsZC5vcHRpb25zOwogICAgICAgIGZpZWxkcy5wdXNoKGZpZWxkKTsKICAgICAgfQoKICAgICAgYWRkQ2F0ZWdvcnkuY2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS5maWVsZHMgPSBmaWVsZHM7CiAgICAgIEFzc2V0TWFuYWdlbWVudFNlcnZpY2UuYWRkQ2F0ZWdvcnkoYWRkQ2F0ZWdvcnkpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuY2F0ZWdvcnlQb3BVcCA9IGZhbHNlOwogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkNhdGVnb3J5IGFkZGVkIHN1Y2Nlc3NmdWxseSIsICJzdWNjZXNzIik7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KGVycm9yLmRhdGEuZGVzY3JpcHRpb24sICJlcnJvciIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIHVwZGF0ZUFkZENhdGVnb3J5KHZhbHVlKSB7CiAgICAgIHRoaXMubG9hZGVyRmxhZyA9IHRydWU7CiAgICAgIGxldCBhZGRDYXRlZ29yeSA9IHsKICAgICAgICBjYXRlZ29yeTogewogICAgICAgICAgaWQ6IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5pZCwKICAgICAgICAgIHV1aWQ6IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS51dWlkLAogICAgICAgICAgbmFtZTogdmFsdWUuY2F0ZWdvcnlOYW1lLAogICAgICAgICAgZGVzY3JpcHRpb246IHZhbHVlLm1lc3NhZ2VCb3gsCiAgICAgICAgICBpY29uVXJsOiB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkuaWNvblVybCwKICAgICAgICAgIHRlbmFudFVVSUQ6IHRoaXMuY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQsCiAgICAgICAgICBpbnNwZWN0aW9uVGVtcGxhdGU6IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5pbnNwZWN0aW9uVGVtcGxhdGUsCiAgICAgICAgICBhc3NldHM6IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5hc3NldHMsCiAgICAgICAgICBmaWVsZFRlbXBsYXRlOiB7CiAgICAgICAgICAgIGlkOiB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS5pZCwKICAgICAgICAgICAgdXVpZDogdGhpcy5zZWxlY3RBc3NldENhdGVnb3J5LmZpZWxkVGVtcGxhdGUudXVpZCwKICAgICAgICAgICAgdHlwZTogdmFsdWUuY2F0ZWdvcnlOYW1lICsgIiBmaWVsZCB0ZW1wbGF0ZSIsCiAgICAgICAgICAgIHRlbmFudFVVSUQ6IHRoaXMuY3VycmVudFVzZXJEZXRhaWxzLnByb2ZpbGUub3JnYW5pemF0aW9uSWQsCiAgICAgICAgICAgIGZpZWxkczogW10sCiAgICAgICAgICAgIHByaXZhdGU6IHRoaXMuc2VsZWN0QXNzZXRDYXRlZ29yeS5maWVsZFRlbXBsYXRlLnByaXZhdGUKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIGxldCBmaWVsZHMgPSBbXTsKCiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2YWx1ZS5jYXRlZ29yeUZpZWxkcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICBsZXQgYWRkQ2F0ZWdvcnlGaWVsZCA9IHZhbHVlLmNhdGVnb3J5RmllbGRzW2luZGV4XTsKICAgICAgICBsZXQgZmllbGQgPSB7fTsKICAgICAgICBmaWVsZC5sYWJlbCA9IGFkZENhdGVnb3J5RmllbGQubGFiZWw7CiAgICAgICAgZmllbGQuZmllbGRNZXRhZGF0YSA9ICIiOwogICAgICAgIGZpZWxkLnR5cGUgPSBhZGRDYXRlZ29yeUZpZWxkLnR5cGU7CiAgICAgICAgZmllbGQuZmllbGRQb3NpdGlvbiA9IGFkZENhdGVnb3J5RmllbGQucG9zaXRpb247CiAgICAgICAgZmllbGQuZmllbGRUZW1wbGF0ZVVVSUQgPSB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS51dWlkOwogICAgICAgIGZpZWxkLm1hbmRhdG9yeSA9IGFkZENhdGVnb3J5RmllbGQubWFuZGF0b3J5OwogICAgICAgIGZpZWxkLm9wdGlvbnMgPSBhZGRDYXRlZ29yeUZpZWxkLm9wdGlvbnM7CiAgICAgICAgZmllbGQuaWNvblVybCA9ICIiOwogICAgICAgIGZpZWxkcy5wdXNoKGZpZWxkKTsKICAgICAgfQoKICAgICAgYWRkQ2F0ZWdvcnkuY2F0ZWdvcnkuZmllbGRUZW1wbGF0ZS5maWVsZHMgPSBmaWVsZHM7IC8vIGNvbnNvbGUubG9nKCdhZGRDYXRlZ29yeS1vbGQnLGFkZENhdGVnb3J5KQogICAgICAvLyBkZWJ1Z2dlcgoKICAgICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS5lZGl0Q2F0ZWdvcnkoYWRkQ2F0ZWdvcnkpLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuY2F0ZWdvcnlQb3BVcCA9IGZhbHNlOwogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkNhdGVnb3J5IHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5IiwgInN1Y2Nlc3MiKTsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHRoaXMubG9hZGVyRmxhZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy5zaG93VG9hc3QoZXJyb3IuZGF0YS5kZXNjcmlwdGlvbiwgImVycm9yIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgRWRpdENhdGVnb3J5KCkgewogICAgICBpZiAodGhpcy5zZWxlY3RBc3NldENhdGVnb3J5ID09ICIiKSB7CiAgICAgICAgdGhpcy5zaG93VG9hc3QoIlBsZWFzZSBTZWxlY3QgQ2F0ZWdvcnkuIiwgImVycm9yIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmNhdGVnb3J5UG9wVXAgPSB0cnVlOwogICAgfSwKCiAgICBzZWxlY3RBc3NldENhdGUodmFsdWUpIHsKICAgICAgdGhpcy5kaXNhYmxlQWRkQnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5kaXNhYmxlRWRpdEJ1dHRvbiA9IGZhbHNlOwogICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnlJZCA9IHZhbHVlOwogICAgICB0aGlzLiRyZWZzLmNhdGVnb3J5RmllbGRBY2NvcmRpb24ub3BlbkZsYWcgPSB0cnVlOwoKICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7fSBlbHNlIHsKICAgICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkgPSB2YWx1ZS5zZWxlY3RlZE9iamVjdDsKCiAgICAgICAgaWYgKHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUgIT0gbnVsbCkgewogICAgICAgICAgaWYgKHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzICE9IG51bGwpIHsKICAgICAgICAgICAgdmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHMuc29ydCgoYSwgYikgPT4gewogICAgICAgICAgICAgIHJldHVybiBhLmZpZWxkUG9zaXRpb24gLSBiLmZpZWxkUG9zaXRpb247CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGV0IGNhdGVnb3J5QXNzZXRGaWVsZHMgPSBbXTsKCiAgICAgICAgaWYgKHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUgIT0gbnVsbCkgewogICAgICAgICAgaWYgKHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzICE9IG51bGwpIHsKICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgIGlmICh2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gInRleHQiKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSB2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgY2F0ZWdvcnlGaWVsZCA9IHsKICAgICAgICAgICAgICAgICAgaWQ6IGZpZWxkLnV1aWQsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRUeXBlOiAiaW5wdXQiLAogICAgICAgICAgICAgICAgICBlbGVtZW50Q29uZmlnOiB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogInRleHQiLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBmaWVsZC5sYWJlbAogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogIiIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHZhbHVlLnNlbGVjdGVkT2JqZWN0LmZpZWxkVGVtcGxhdGUuZmllbGRzW2luZGV4XTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb24gPSBmaWVsZC5vcHRpb25zLnNwbGl0KCIsIik7CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9ucyA9IFtdOwoKICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvcHRpb24ubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbltpbmRleF0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5RmllbGQgPSB7CiAgICAgICAgICAgICAgICAgIGlkOiBmaWVsZC51dWlkLAogICAgICAgICAgICAgICAgICBlbGVtZW50VHlwZTogInNlbGVjdCIsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRDb25maWc6IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAic2VsZWN0IiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogIiIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gIm51bWVyaWMiKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSB2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb3B0aW9uLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25baW5kZXhdCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJudW1lcmljIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJudW1lcmljIiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogIiIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSB2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF07CiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uID0gZmllbGQub3B0aW9ucy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25bMF0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgb3B0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvblsxXQogICAgICAgICAgICAgICAgfSk7IC8vIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvcHRpb24ubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAvLyAgIG9wdGlvbnMucHVzaCh7IGxhYmVsOiBvcHRpb25baW5kZXhdIH0pOwogICAgICAgICAgICAgICAgLy8gfQoKICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeUZpZWxkID0gewogICAgICAgICAgICAgICAgICBpZDogZmllbGQudXVpZCwKICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGU6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgZWxlbWVudENvbmZpZzogewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogIiIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5zZWxlY3RlZE9iamVjdC5maWVsZFRlbXBsYXRlLmZpZWxkc1tpbmRleF0udHlwZSA9PT0gImNhbGVuZGVyIikgewogICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gdmFsdWUuc2VsZWN0ZWRPYmplY3QuZmllbGRUZW1wbGF0ZS5maWVsZHNbaW5kZXhdOwogICAgICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGZpZWxkLm9wdGlvbnMuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGxldCBvcHRpb25zID0gW107CgogICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9wdGlvbi5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uW2luZGV4XQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsZXQgY2F0ZWdvcnlGaWVsZCA9IHsKICAgICAgICAgICAgICAgICAgaWQ6IGZpZWxkLnV1aWQsCiAgICAgICAgICAgICAgICAgIGVsZW1lbnRUeXBlOiAiY2FsZW5kZXIiLAogICAgICAgICAgICAgICAgICBlbGVtZW50Q29uZmlnOiB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogImNhbGVuZGVyIiwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWVsZC5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB2YWx1ZTogIiIsCiAgICAgICAgICAgICAgICAgIHZhbGlkOiB0cnVlLAogICAgICAgICAgICAgICAgICB0b3VjaGVkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQubWFuZGF0b3J5KSB7CiAgICAgICAgICAgICAgICAgIGNhdGVnb3J5RmllbGQudmFsaWRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUZpZWxkLnZhbGlkYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzLnB1c2goY2F0ZWdvcnlGaWVsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2F0ZWdvcnlBc3NldEZpZWxkcy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY2F0ZWdvcnlBc3NldEZpZWxkcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIGlmIChjYXRlZ29yeUFzc2V0RmllbGRzW2luZGV4XS5lbGVtZW50Q29uZmlnLmxhYmVsLmluY2x1ZGVzKCJEaW1lbnNpb24iKSkgewogICAgICAgICAgICAgICAgICBjYXRlZ29yeUFzc2V0RmllbGRzW2luZGV4XS52YWx1ZSA9IHRoaXMuZGltZW5zaW9uczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuY2F0ZWdvcnlGaWVsZHNSZXNlcnZlID0gY2F0ZWdvcnlBc3NldEZpZWxkczsKICAgICAgICB0aGlzLmN1c3RvbUNhdGVnb3J5RmllbGRzID0gY2F0ZWdvcnlBc3NldEZpZWxkcy5maWx0ZXIoZmllbGRzID0+IGZpZWxkcy5lbGVtZW50Q29uZmlnLmxhYmVsICE9PSAiIyBvZiBXYXNoZXMiKTsKICAgICAgfQogICAgfSwKCiAgICBjbGVhclNlbGVjdGVkQXNzZXRDYXRlKCkgewogICAgICB0aGlzLmNhdGVnb3J5ID0gIiI7CiAgICAgIHRoaXMuY3VzdG9tQ2F0ZWdvcnlGaWVsZHMgPSBbXTsKICAgICAgdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQgPSBudWxsOwogICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkgPSAiIjsKICAgICAgdGhpcy5jYXRlSW5kZXgrKzsKICAgICAgdGhpcy5kaXNhYmxlQWRkQnV0dG9uID0gZmFsc2U7CiAgICAgIHRoaXMuZGlzYWJsZUVkaXRCdXR0b24gPSB0cnVlOwogICAgfSwKCiAgICBhc3NldEluZm9ybWF0aW9uQWNjb3JkaW9uRnVuY3Rpb24odmFsKSB7CiAgICAgIGlmICh0aGlzLiRyZWZzLmFzc2V0SW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPT09IHRydWUpIHsKICAgICAgICB0aGlzLiRyZWZzLmNhdGVnb3J5RmllbGRBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0V2FycmFudHlBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLnVzYWdlRGVzY3JpcHRpb25JbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXR0YWNoSW1hZ2VBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0QXNzaWdubWVudEFjY29yZGlvbi5vcGVuRmxhZyA9PT0gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgYXNzZXRBc3NpZ25tZW50QWNjb3JkaW9uRnVuY3Rpb24odmFsKSB7CiAgICAgIGlmICh0aGlzLiRyZWZzLmFzc2V0QXNzaWdubWVudEFjY29yZGlvbi5vcGVuRmxhZyA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuJHJlZnMuY2F0ZWdvcnlGaWVsZEFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRXYXJyYW50eUFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMudXNhZ2VEZXNjcmlwdGlvbkluZm9ybWF0aW9uQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hdHRhY2hJbWFnZUFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRJbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9PT0gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgY2F0ZWdvcnlGaWVsZEFjY29yZGlvbkZ1bmN0aW9uKHZhbCkgewogICAgICBpZiAodGhpcy4kcmVmcy5jYXRlZ29yeUZpZWxkQWNjb3JkaW9uLm9wZW5GbGFnID09PSB0cnVlKSB7CiAgICAgICAgdGhpcy4kcmVmcy5hc3NldEluZm9ybWF0aW9uQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hc3NldFdhcnJhbnR5QWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy51c2FnZURlc2NyaXB0aW9uSW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmF0dGFjaEltYWdlQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hc3NldEFzc2lnbm1lbnRBY2NvcmRpb24ub3BlbkZsYWcgPT09IGZhbHNlOwogICAgICB9CiAgICB9LAoKICAgIGFzc2V0V2FycmFudHlBY2NvcmRpb25GdW5jdGlvbih2YWwpIHsKICAgICAgaWYgKHRoaXMuJHJlZnMuYXNzZXRXYXJyYW50eUFjY29yZGlvbi5vcGVuRmxhZyA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuJHJlZnMuY2F0ZWdvcnlGaWVsZEFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMuYXNzZXRJbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuJHJlZnMudXNhZ2VEZXNjcmlwdGlvbkluZm9ybWF0aW9uQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcmVmcy5hdHRhY2hJbWFnZUFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwogICAgICB9CiAgICB9LAoKICAgIHVzYWdlRGVzY3JpcHRpb25JbmZvcm1hdGlvbkFjY29yZGlvbkZ1bmN0aW9uKHZhbCkgewogICAgICBpZiAodGhpcy4kcmVmcy51c2FnZURlc2NyaXB0aW9uSW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPT09IHRydWUpIHsKICAgICAgICB0aGlzLiRyZWZzLmNhdGVnb3J5RmllbGRBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0V2FycmFudHlBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0SW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmF0dGFjaEltYWdlQWNjb3JkaW9uLm9wZW5GbGFnID0gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgYXR0YWNoSW1hZ2VBY2NvcmRpb25GdW5jdGlvbih2YWwpIHsKICAgICAgaWYgKHRoaXMuJHJlZnMuYXR0YWNoSW1hZ2VBY2NvcmRpb24ub3BlbkZsYWcgPT09IHRydWUpIHsKICAgICAgICB0aGlzLiRyZWZzLmNhdGVnb3J5RmllbGRBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0V2FycmFudHlBY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLmFzc2V0SW5mb3JtYXRpb25BY2NvcmRpb24ub3BlbkZsYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLiRyZWZzLnVzYWdlRGVzY3JpcHRpb25JbmZvcm1hdGlvbkFjY29yZGlvbi5vcGVuRmxhZyA9IGZhbHNlOwoKICAgICAgICBpZiAodGhpcy5pbWFnZVZvaWNlc0NoZWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHRoaXMuZ2V0QXNzZXRJbWFnZXMoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgZ2V0QXNzZXRJbWFnZXMoKSB7CiAgICAgIEFzc2V0TWFuYWdlbWVudFNlcnZpY2UuZ2V0QXNzZXRJbWFnZXNCeVV1aWQodGhpcy5hc3NldElEKS50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKCiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICB0aGlzLmltYWdlVm9pY2VzID0gcmVzcG9uc2UuZGF0YS5hc3NldEltYWdlczsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHsKICAgICAgICB0aGlzLnNob3dUb2FzdCgiQW4gRXJyb3IgT2NjdXJyZWQgd2hpbGUgZ2V0dGluZyBBc3NldCBJbWFnZXMuIiwgImVycm9yIik7CiAgICAgIH0pOwogICAgfSwKCiAgICBidWlsZEltYWdlQXJyYXkoZmlsZSkgewogICAgICB0aGlzLm11bHRpcGFydEF0dGFjaG1lbnRzLnB1c2goewogICAgICAgIGZpbGVOYW1lOiBmaWxlLm5hbWUsCiAgICAgICAgZmlsZTogZmlsZSwKICAgICAgICB0eXBlOiBmaWxlLm5hbWUKICAgICAgfSk7CiAgICB9LAoKICAgIGhhbmRsZUltYWdlRmlsZSh2YWx1ZSkgewogICAgICB0aGlzLmltYWdlUGF0aCA9IFtdOwogICAgICB0aGlzLmxvYWRlckZsYWcgPSB0cnVlOwoKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgdGhpcy5idWlsZEltYWdlQXJyYXkodmFsdWUpOwogICAgICAgIHZhciBleHRWaWRlbyA9IHRoaXMudmFsdWUubmFtZS5zcGxpdCgiLiIpLnBvcCgpOwoKICAgICAgICBpZiAoZXh0VmlkZW8gPT09ICJtcDQiIHx8IGV4dFZpZGVvID09PSAid2VibSIpIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJWaWRlbyB1cGxvYWQgbm90IHN1cHBvcnRlZC4iLCAid2FybmluZyIpOwogICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIEFzc2V0TWFuYWdlbWVudFNlcnZpY2UudXBsb2FkRmlsZVRvczModGhpcy52YWx1ZSkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlSWRlbnRpZmllciA9PT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICAgICAgdmFyIGV4dCA9IHJlc3BvbnNlLmRhdGEuZmlsZU5hbWUuc3BsaXQoIi4iKS5wb3AoKTsKCiAgICAgICAgICAgICAgaWYgKGV4dCA9PT0gImpwZWciIHx8IGV4dCA9PT0gInBuZyIgfHwgZXh0ID09PSAianBnIikgewogICAgICAgICAgICAgICAgbGV0IG9iaiA9IHt9OwogICAgICAgICAgICAgICAgb2JqLmlkID0gdGhpcy5hc3NldE9iai5pZCwgb2JqLmFzc2V0VVVJRCA9IHRoaXMuYXNzZXRJRCwgb2JqLmltYWdlVXJsID0gcmVzcG9uc2UuZGF0YS5maWxlVXJsOwogICAgICAgICAgICAgICAgb2JqLmltYWdlRmxhZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmltYWdlUGF0aC5wdXNoKG9iaik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICJwZGYiKSB7CiAgICAgICAgICAgICAgICBsZXQgb2JqID0ge307CiAgICAgICAgICAgICAgICBvYmouaWQgPSB0aGlzLmFzc2V0T2JqLmlkLCBvYmouYXNzZXRVVUlEID0gdGhpcy5hc3NldElELCBvYmouY29udGVudFVybCA9IHJlc3BvbnNlLmRhdGEuZmlsZVVybDsKICAgICAgICAgICAgICAgIG9iai5maWxlTmFtZSA9IHJlc3BvbnNlLmRhdGEuZmlsZU5hbWU7CiAgICAgICAgICAgICAgICB0aGlzLmRvY1BhdGgucHVzaChvYmopOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoZXh0ID09PSAianBlZyIgfHwgZXh0ID09PSAicG5nIiB8fCBleHQgPT09ICJqcGciID8gIkltYWdlIGFkZGVkIFN1Y2Nlc3NmdWxseS4iIDogIkRvY3VtZW50IGFkZGVkIFN1Y2Nlc3NmdWxseS4iLCAic3VjY2VzcyIpOwogICAgICAgICAgICB0aGlzLmxvYWRlckZsYWcgPSBmYWxzZTsKICAgICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHsKICAgICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA2KSB7CiAgICAgICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkFuIGVycm9yIG9jY3VycmVkIHdoaWxlIGFkZGluZyBJbWFnZSBvciBmaWxlIiwgImVycm9yIik7CiAgICAgICAgICAgICAgdGhpcy5sb2FkZXJGbGFnID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBnZXRGb3JtRXJyb3JNZXNzYWdlKGZpZWxkVmFsaWRhdGlvbikgewogICAgICBpZiAoZmllbGRWYWxpZGF0aW9uLiRkaXJ0eSkgewogICAgICAgIHJldHVybiBGdW5jdGlvbnMuZ2V0Rm9ybUZpZWxkRXJyb3JNZXNzYWdlKGZpZWxkVmFsaWRhdGlvbik7CiAgICAgIH0KICAgIH0sCgogICAgZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKSB7CiAgICAgIEFzc2V0UGVyc29ubmVsU2VydmljZS5nZXRBc3NpZ25lZFVzZXJzT2ZBc3NldCh0aGlzLmFzc2V0SUQpLnRoZW4ocmVzcG9uc2UxID0+IHsKICAgICAgICBpZiAocmVzcG9uc2UxLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICBpZiAocmVzcG9uc2UxLmRhdGEuZGV0YWlscy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHRoaXMudXNlckFzc2lnbmVkID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgbGV0IHVzZXJzID0gW107CgogICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJlc3BvbnNlMS5kYXRhLmRldGFpbHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIGxldCBvYmogPSB7fTsKICAgICAgICAgICAgb2JqLm5hbWUgPSByZXNwb25zZTEuZGF0YS5kZXRhaWxzW2luZGV4XS5uYW1lOwogICAgICAgICAgICBvYmouY291bnQgPSByZXNwb25zZTEuZGF0YS5kZXRhaWxzW2luZGV4XS5jb3VudDsKICAgICAgICAgICAgb2JqLnN0YXR1cyA9IHJlc3BvbnNlMS5kYXRhLmRldGFpbHNbaW5kZXhdLnN0YXR1czsKICAgICAgICAgICAgb2JqLnN0YXJ0RGF0ZSA9IG1vbWVudChyZXNwb25zZTEuZGF0YS5kZXRhaWxzW2luZGV4XS5zdGFydERhdGUpLmZvcm1hdCgiREQgTU1NIFlZWVkgaGg6bW0gYSIpOwogICAgICAgICAgICBvYmoudXVpZCA9IHJlc3BvbnNlMS5kYXRhLmRldGFpbHNbaW5kZXhdLnV1aWQ7CiAgICAgICAgICAgIG9iai51c2VyRW5kaW5nRGF0ZXMgPSByZXNwb25zZTEuZGF0YS5kZXRhaWxzW2luZGV4XS51c2VyRW5kaW5nRGF0ZXM7CiAgICAgICAgICAgIG9iai5hc3NpZ25tZW50SWQgPSByZXNwb25zZTEuZGF0YS5kZXRhaWxzW2luZGV4XS5hc3NpZ25tZW50SWQ7CiAgICAgICAgICAgIHVzZXJzLnB1c2gob2JqKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLmFzc2lnbmVkVXNlcnMgPSB1c2VyczsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHsKICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDYpIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJBbiB1bmV4cGVjdGVkIEVycm9yIE9jY3VycmVkIiwgImVycm9yIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc2hvd1RvYXN0KCJBbiB1bmV4cGVjdGVkIEVycm9yIE9jY3VycmVkIiwgImVycm9yIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgdGl0bGVGdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuYXNzZXRJRCA9PSB1bmRlZmluZWQpIHsKICAgICAgICBkb2N1bWVudC50aXRsZSA9IHRoaXMuJHJvdXRlLm1ldGEudGl0bGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9jdW1lbnQudGl0bGUgPSAiRXJvaGFsIC0gRWRpdCBBc3NldCI7CiAgICAgIH0KICAgIH0sCgogICAgZ2V0TWFpbnRhaW5hbmNlQ29zdChhc3NldElkKSB7CiAgICAgIHsKICAgICAgICBXb3JrT3JkZXJTZXJ2aWNlLmdldEFzc2V0TWFpbnRlbmFuY2VDb3N0QnlBc3NldFVVSUQoYXNzZXRJZCkudGhlbihyZXMgPT4gewogICAgICAgICAgdGhpcy5jb3N0ID0gcmVzLmRhdGEubWFpbnRlbmFuY2VDb3N0OwogICAgICAgIH0pLmNhdGNoKGUgPT4gewogICAgICAgICAgdGhpcy5zaG93VG9hc3QoIkFuIHVuZXhwZWN0ZWQgRXJyb3IgT2NjdXJyZWQiLCAiZXJyb3IiKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKCiAgICBzaG93VG9hc3QobWVzc2FnZSwgdHlwZSkgewogICAgICB0aGlzLnRvYXN0TWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgIHRoaXMudG9hc3RUeXBlID0gdHlwZTsKICAgICAgdGhpcy50b2FzdEZsYWcrKzsKICAgIH0KCiAgfSwKCiAgY3JlYXRlZCgpIHsKICAgIHRoaXMuYXNzZXRJRCA9IHRoaXMuJHJvdXRlLnBhcmFtcy5hc3NldElEOwogICAgdGhpcy50aXRsZUZ1bmN0aW9uKCk7CiAgICB0aGlzLmdldEN1cnJlbmN5KCk7CiAgICB0aGlzLmN1cnJlbnRVc2VyRGV0YWlscyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oImN1cnJlbnRVc2VyRGV0YWlscyIpKTsKICAgIHRoaXMuc2VsZWN0VXNlcigpOwogICAgQXNzZXRNYW5hZ2VtZW50U2VydmljZS5nZXRBbGxBc3NldENhdGVnb3JpZXModGhpcy5jdXJyZW50VXNlckRldGFpbHMucHJvZmlsZS5vcmdhbml6YXRpb25JZCkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgIHJlc3BvbnNlLmRhdGEuY2F0ZWdvcmllcy5zb3J0KChjYXRlZ29yeTEsIGNhdGVnb3J5MikgPT4gewogICAgICAgIGxldCB2YWx1ZSA9IDA7IC8vIG5vIGNoYW5nZQoKICAgICAgICBpZiAoY2F0ZWdvcnkxLm5hbWUgPCBjYXRlZ29yeTIubmFtZSkgewogICAgICAgICAgdmFsdWUgPSAtMTsgLy8gMiBiZWZvcmUgMQogICAgICAgIH0gZWxzZSBpZiAoY2F0ZWdvcnkyLm5hbWUgPCBjYXRlZ29yeTEubmFtZSkgewogICAgICAgICAgdmFsdWUgPSAxOyAvLyAxIGJlZm9yZSAyCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0pOwogICAgICB0aGlzLkFzc2V0Q2F0ZWdvcnkgPSByZXNwb25zZS5kYXRhLmNhdGVnb3JpZXM7CgogICAgICBpZiAodGhpcy5hc3NldElEICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmdldEFzc2V0RGV0YWlscygpOwogICAgICAgIHRoaXMuZ2V0TWFpbnRhaW5hbmNlQ29zdCh0aGlzLmFzc2V0SUQpOwogICAgICAgIHRoaXMuZ2V0QXNzaWduZWRVc2Vyc09mQXNzZXQoKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuJHJvdXRlLm5hbWUgPT0gJ2NyZWF0ZS1hc3NldC1ieS1jYXRlZ29yeScpIHsKICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiQWRkQnlDYXRlRmxhZyIsIHRoaXMuJHJvdXRlLnBhcmFtcy5BZGRCeUNhdGVGbGFnKTsKICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiYXNzZXRDYXRlSUQiLCB0aGlzLiRyb3V0ZS5wYXJhbXMuYXNzZXRDYXRlSUQpOwogICAgICAgIHRoaXMuQWRkQnlDYXRlRmxhZyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJBZGRCeUNhdGVGbGFnIik7CiAgICAgICAgdGhpcy5hc3NldENhdGVJRCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJhc3NldENhdGVJRCIpOwoKICAgICAgICBpZiAodGhpcy5BZGRCeUNhdGVGbGFnKSB7CiAgICAgICAgICBpZiAodGhpcy5hc3NldENhdGVJRCAhPT0gIiIpIHsKICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuQXNzZXRDYXRlZ29yeS5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICBpZiAodGhpcy5hc3NldENhdGVJRCA9PT0gdGhpcy5Bc3NldENhdGVnb3J5W2luZGV4XS51dWlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEFzc2V0Q2F0ZWdvcnkgPSB0aGlzLkFzc2V0Q2F0ZWdvcnlbaW5kZXhdOwogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZENhdGVnb3J5SWQgPSB0aGlzLkFzc2V0Q2F0ZWdvcnlbaW5kZXhdOwogICAgICAgICAgICAgICAgdGhpcy5jYXRlZ29yeSA9IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF0ubmFtZTsKICAgICAgICAgICAgICAgIHRoaXMuY2F0ZUluZGV4Kys7CiAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVBZGRCdXR0b24gPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlRWRpdEJ1dHRvbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgbGV0IG9iaiA9IHsKICAgICAgICAgICAgICAgICAgImRpc3BsYXkiOiB0aGlzLkFzc2V0Q2F0ZWdvcnlbaW5kZXhdLm5hbWUsCiAgICAgICAgICAgICAgICAgICJzZWxlY3RlZE9iamVjdCI6IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF0sCiAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHRoaXMuQXNzZXRDYXRlZ29yeVtpbmRleF0udXVpZAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0QXNzZXRDYXRlKG9iaik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9LAoKICB2YWxpZGF0aW9uczogZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHsKICAgICAgY3VzdG9tQ2F0ZWdvcnlGaWVsZHM6IHsKICAgICAgICAkZWFjaDogewogICAgICAgICAgdmFsdWU6IHsKICAgICAgICAgICAgcmVxdWlyZWQKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFzc2V0T2JqOiB7CiAgICAgICAgbmFtZTogewogICAgICAgICAgcmVxdWlyZWQsCiAgICAgICAgICBtYXhMZW5ndGg6IG1heExlbmd0aCgxOTApCiAgICAgICAgfSwKICAgICAgICBtb2RlbE51bWJlcjogewogICAgICAgICAgcmVxdWlyZWQsCiAgICAgICAgICBtYXhMZW5ndGg6IG1heExlbmd0aCgxOTApCiAgICAgICAgfSwKICAgICAgICBtYW51ZmFjdHVyZTogewogICAgICAgICAgcmVxdWlyZWQsCiAgICAgICAgICBtYXhMZW5ndGg6IG1heExlbmd0aCgxOTApCiAgICAgICAgfSwKICAgICAgICB3YXJyYW50eTogewogICAgICAgICAgbWF4TGVuZ3RoOiBtYXhMZW5ndGgoMTkwKQogICAgICAgIH0sCiAgICAgICAgd2FycmFudHlVbml0OiB7CiAgICAgICAgICByZXF1aXJlZAogICAgICAgIH0sCiAgICAgICAgY29uc3VtcHRpb25Vbml0OiB7CiAgICAgICAgICByZXF1aXJlZCwKICAgICAgICAgIG1heExlbmd0aDogbWF4TGVuZ3RoKDE5MCkKICAgICAgICB9LAogICAgICAgIHByaW1hcnlVc2FnZVVuaXQ6IHsKICAgICAgICAgIHJlcXVpcmVkLAogICAgICAgICAgbWF4TGVuZ3RoOiBtYXhMZW5ndGgoMTkwKQogICAgICAgIH0sCiAgICAgICAgc2Vjb25kYXJ5VXNhZ2VVbml0OiB7CiAgICAgICAgICByZXF1aXJlZCwKICAgICAgICAgIG1heExlbmd0aDogbWF4TGVuZ3RoKDE5MCkKICAgICAgICB9IC8vIHF1YW50aXR5OiB7IHJlcXVpcmVkIH0sCiAgICAgICAgLy8gaW52ZW50b3J5OiB7IHJlcXVpcmVkIH0sCgogICAgICB9LAogICAgICBjYXRlZ29yeTogewogICAgICAgIHJlcXVpcmVkCiAgICAgIH0sCiAgICAgIGRlc2NyaXB0aW9uOiB7CiAgICAgICAgcmVxdWlyZWQsCiAgICAgICAgbWF4TGVuZ3RoOiBtYXhMZW5ndGgoNTAwKQogICAgICB9CiAgICB9OwogIH0sCiAgY29tcHV0ZWQ6IHt9Cn07"},null]}